<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ ×ª×™×§ ×”×”×©×§×¢×•×ª ×”××©×•×¤×¨ v32 - Enhanced Charts & Dark Mode</title>
    
    <!-- Chart.js - Fixed CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* ==================== DARK MODE VARIABLES ==================== */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --card-bg: rgba(255,255,255,0.95);
            --glass-bg: rgba(255,255,255,0.95);
            --shadow-color: rgba(0,0,0,0.1);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }
        
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-gradient-start: #4c1d95;
            --bg-gradient-end: #312e81;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --card-bg: rgba(31,41,55,0.95);
            --glass-bg: rgba(31,41,55,0.95);
            --shadow-color: rgba(0,0,0,0.3);
        }
        
        /* ==================== BASIC RESET & RTL ==================== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* ==================== LOADING SCREEN ==================== */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== GLASS EFFECT ==================== */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px var(--shadow-color);
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .glass:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* ==================== HEADER WITH DARK MODE TOGGLE ==================== */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 { 
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: fadeInDown 0.6s ease;
        }
        
        .header p { 
            font-size: clamp(1rem, 3vw, 1.2rem);
            opacity: 0.9;
            animation: fadeInUp 0.6s ease 0.2s both;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Dark Mode Toggle Button */
        .theme-toggle {
            position: absolute;
            top: 0;
            left: 20px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.5rem;
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1) rotate(15deg);
        }
        
        /* ==================== NAVIGATION LINKS ==================== */
        .nav-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-link {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* ==================== TABS ==================== */
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-btn:hover { 
            background: var(--bg-primary);
            transform: translateY(-2px);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .tab-content { 
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ==================== SUMMARY CARDS ==================== */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
            transition: all 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 24px rgba(102,126,234,0.4);
        }
        
        .summary-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .summary-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .summary-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .summary-card.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .summary-card h3 { 
            font-size: 0.9rem; 
            opacity: 0.9; 
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .summary-card .value { 
            font-size: 2rem; 
            font-weight: bold; 
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-card .sub { 
            font-size: 0.85rem; 
            opacity: 0.8; 
        }
        
        /* ==================== CHARTS CONTAINER ==================== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .chart-container {
            background: var(--glass-bg);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 32px var(--shadow-color);
            height: 400px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }
        
        .chart-container.large {
            grid-column: 1 / -1;
            height: 500px;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        canvas {
            max-height: 100%;
        }
        
        /* ==================== FORMS ==================== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--bg-gradient-start);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
            transform: translateY(-2px);
        }
        
        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102,126,234,0.4); 
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-success:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(16,185,129,0.4); 
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-danger:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(239,68,68,0.4); 
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-warning:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(245,158,11,0.4); 
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ==================== NOTIFICATION ==================== */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            color: #1f2937;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            border-left: 4px solid #667eea;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-left-color: #065f46;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-left-color: #991b1b;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-left-color: #92400e;
        }
        
        /* ==================== RESPONSIVE DESIGN ==================== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .theme-toggle {
                top: -10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                white-space: nowrap;
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                min-width: 0;
                height: 350px;
            }
            
            .glass {
                padding: 20px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                flex-direction: column;
            }
            
            .nav-link {
                justify-content: center;
            }
        }
        
        /* ==================== TABLES ==================== */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-primary);
            border-radius: 12px;
            overflow: hidden;
        }
        
        thead {
            background: var(--bg-secondary);
        }
        
        thead th {
            padding: 15px;
            text-align: right;
            font-weight: 700;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }
        
        tbody td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        tbody tr:hover {
            background: var(--bg-secondary);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* ==================== UTILITY CLASSES ==================== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        
        /* ==================== PULSE ANIMATION FOR LIVE DATA ==================== */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    
        .calculator-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .calculator-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .calculator-header h3 {
            margin: 0;
            color: #92400e;
            font-size: 1.5rem;
        }
        
        .calc-input-group {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 25px;
        }
        
        .calc-results {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 20px;
        }
        
        .calc-results.active {
            display: block;
        }
        
        #calc-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .calc-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border-right: 4px solid #667eea;
        }
        
        .calc-item strong {
            color: #111827;
        }
        
        .calc-item span {
            color: #667eea;
            font-weight: 600;
        }

    
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e5e7eb;
        }
        
        body.dark-mode .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            color: #e5e7eb;
        }
        
        body.dark-mode .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        body.dark-mode .summary-card {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(100, 116, 139, 0.4);
        }
        
        body.dark-mode .stat-value {
            color: #f1f5f9;
        }
        
        body.dark-mode .stat-label {
            color: #cbd5e1;
        }
        
        body.dark-mode .tab-btn {
            color: #cbd5e1;
            border-color: rgba(100, 116, 139, 0.3);
        }
        
        body.dark-mode .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        body.dark-mode table {
            background: rgba(30, 41, 59, 0.5);
        }
        
        body.dark-mode thead {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        body.dark-mode tr {
            border-color: rgba(100, 116, 139, 0.3) !important;
        }
        
        body.dark-mode input,
        body.dark-mode select {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(100, 116, 139, 0.4);
            color: #e5e7eb;
        }
        
        body.dark-mode .calculator-card {
            background: linear-gradient(135deg, #422006 0%, #713f12 100%);
            border-color: #d97706;
        }
        
        body.dark-mode .calculator-header h3 {
            color: #fbbf24;
        }
        
        body.dark-mode .calc-results {
            background: rgba(30, 41, 59, 0.9);
        }
        
        body.dark-mode .calc-item {
            background: rgba(51, 65, 85, 0.5);
        }

    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <h2 style="color: white; margin-top: 20px; font-size: 1.5rem;">×˜×•×¢×Ÿ ×ª×™×§ ×”×©×§×¢×•×ª...</h2>
        <p style="color: rgba(255,255,255,0.8); margin-top: 10px;">××›×™×Ÿ ××ª ×”×’×¨×¤×™× ×”××“×”×™××™× ×©×œ×š âœ¨</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <div class="container">
            <!-- Header with Dark Mode Toggle -->
            <div class="header">
                <button class="theme-toggle" onclick="toggleTheme()" title="×”×—×œ×£ ×‘×™×Ÿ ××¦×‘ ×‘×”×™×¨ ×œ×›×”×”">
                    <span id="theme-icon">ğŸŒ™</span>
                </button>
                <h1>âœ¨ ×ª×™×§ ×”×”×©×§×¢×•×ª ×”××©×•×¤×¨</h1>
                <p>× ×™×”×•×œ ×—×›× ×¢× ×’×¨×¤×™× ××ª×§×“××™× ×•-Dark Mode</p>
            </div>

            <!-- Navigation -->
            <div class="nav-links">
                <a href="××¢×§×‘_×›×¡×¤×™_FINAL__1_.html" class="nav-link" target="_blank">
                    <i data-lucide="bar-chart-2"></i> ××¢×§×‘ ×›×¡×¤×™
                </a>
            </div>

            <!-- Glass Container -->
            <div class="glass">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="showTab('overview')">
                        <i data-lucide="layout-dashboard"></i> ×¡×™×›×•×
                    </button>
                    <button class="tab-btn" onclick="showTab('charts')">
                        <i data-lucide="trending-up"></i> ×’×¨×¤×™×
                    </button>
                    <button class="tab-btn" onclick="showTab('holdings')">
                        <i data-lucide="briefcase"></i> ×”×—×–×§×•×ª
                    </button>
                    <button class="tab-btn" onclick="showTab('bonds')">
                        <i data-lucide="file-text"></i> ××’"×—
                    </button>
                    <button class="tab-btn" onclick="showTab('cashflow')">
                        <i data-lucide="dollar-sign"></i> ×ª×–×¨×™× ××–×•×× ×™×
                    </button>
                    <button class="tab-btn" onclick="showTab('history')">
                        <i data-lucide="list"></i> ×¢×¡×§××•×ª
                    </button>
                    <button class="tab-btn" onclick="showTab('calculator')">
                        <i data-lucide="calculator"></i> ××—×©×‘×•×Ÿ
                    </button>
                    <button class="tab-btn" onclick="showTab('groups')">
                        <i data-lucide="folder"></i> ×§×‘×•×¦×•×ª
                    </button>
                    <button class="tab-btn" onclick="showTab('analysis')">
                        <i data-lucide="microscope"></i> × ×™×ª×•×—
                    </button>
                    <button class="tab-btn" onclick="showTab('settings')">
                        <i data-lucide="settings"></i> ×”×’×“×¨×•×ª
                    </button>
                </div>

                <!-- ===== TAB: OVERVIEW ===== -->
                <div id="tab-overview" class="tab-content active">
                    <h2 style="text-align: center; color: var(--text-primary); margin-bottom: 25px;">
                        ğŸ’¼ ×¡×™×›×•× ×ª×™×§ ×”×”×©×§×¢×•×ª
                    </h2>

                    <!-- Main TWR Hero Card -->
                    <div class="summary-grid">
                        <div class="summary-card purple">
                            <h3><i data-lucide="trending-up"></i> ×ª×©×•××” ×›×•×œ×œ×ª (TWR)</h3>
                            <div class="value" id="main-twr-display">--</div>
                            <div class="sub" id="twr-breakdown">×‘×˜×¢×™× ×”...</div>
                            <div class="sub" id="twr-period-info" style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                                ğŸ“… ××ª×—×™×œ×ª ×”×ª×™×§
                            </div>
                        </div>

                        <div class="summary-card green">
                            <h3><i data-lucide="dollar-sign"></i> ×¨×•×•×—/×”×¤×¡×“ ××•×—×œ×˜</h3>
                            <div class="value" id="main-profit-display">â‚ª0</div>
                            <div class="sub" id="overview-total-deposits">×”×•×©×§×¢: â‚ª0</div>
                        </div>

                        <div class="summary-card blue">
                            <h3><i data-lucide="wallet"></i> ×©×•×•×™ ×›×•×œ×œ</h3>
                            <div class="value" id="total-value">â‚ª0</div>
                            <div class="sub">× ×›×¡×™× + ××–×•××Ÿ</div>
                        </div>
                    </div>

                    <!-- Asset Cards Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Stocks Card -->
                        <div class="glass" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 2px solid #0ea5e9; padding: 20px;">
                            <h3 style="color: #0c4a6e; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="trending-up" style="width: 24px; height: 24px;"></i> ×× ×™×•×ª
                            </h3>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">×©×•×•×™ × ×•×›×—×™</div>
                                <div style="font-size: 2rem; font-weight: bold; color: #0ea5e9;" id="stocks-value">â‚ª0</div>
                                <div style="font-size: 0.8rem; color: #6b7280;" id="stocks-value-original">$0 + â‚¬0</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: #6b7280;">×”×—×–×§×•×ª</div>
                                    <div style="font-weight: 600; color: #0c4a6e;" id="stocks-count">0</div>
                                </div>
                                <div>
                                    <div style="color: #6b7280;">×”×•×©×§×¢</div>
                                    <div style="font-weight: 600; color: #0c4a6e;" id="stocks-capital">â‚ª0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Bonds Card -->
                        <div class="glass" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; padding: 20px;">
                            <h3 style="color: #78350f; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="file-text" style="width: 24px; height: 24px;"></i> ××’"×—
                            </h3>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">×©×•×•×™ × ×•×›×—×™</div>
                                <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="bonds-value">â‚ª0</div>
                                <div style="font-size: 0.8rem; color: #6b7280;" id="bonds-count">0 ×§×¨× ×•×ª</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: #6b7280;">×§×¨× ×•×ª</div>
                                    <div style="font-weight: 600; color: #78350f;" id="bonds-count-num">0</div>
                                </div>
                                <div>
                                    <div style="color: #6b7280;">×”×•×©×§×¢</div>
                                    <div style="font-weight: 600; color: #78350f;" id="bonds-cost">â‚ª0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Total Card -->
                        <div class="glass" style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border: 2px solid #8b5cf6; padding: 20px;">
                            <h3 style="color: #4c1d95; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="wallet" style="width: 24px; height: 24px;"></i> ×›×•×œ×œ
                            </h3>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">×©×•×•×™ ×›×•×œ×œ</div>
                                <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;" id="total-value-2">â‚ª0</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">× ×›×¡×™× + ××–×•××Ÿ</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: #6b7280;">××–×•××Ÿ ×–××™×Ÿ</div>
                                    <div style="font-weight: 600; color: #4c1d95;" id="available-cash-overview">â‚ª0</div>
                                </div>
                                <div>
                                    <div style="color: #6b7280;">×¢×“×›×•×Ÿ</div>
                                    <div style="font-weight: 600; color: #4c1d95; font-size: 0.75rem;" id="last-update-time">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cash Flow Summary -->
                    <div class="glass" style="margin-bottom: 20px; padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            <i data-lucide="arrow-right-left"></i> ×ª×–×¨×™× ××–×•×× ×™×
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div style="padding: 15px; background: #f0f9ff; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">×”×©×§×¢×ª×™ ×‘×ª×™×§</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="total-deposits">â‚ª0</div>
                            </div>
                            <div style="padding: 15px; background: #fef2f2; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">××©×›×ª×™ ××”×ª×™×§</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;" id="total-withdrawals">â‚ª0</div>
                            </div>
                            <div style="padding: 15px; background: #f0fdf4; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">××–×•××Ÿ ×¤× ×•×™</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #0ea5e9;" id="available-cash-summary">â‚ª0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Allocation Comparison -->
                    <div class="glass" style="padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            <i data-lucide="target"></i> ×”×ª×××” ×œ×™×¢×“
                        </h3>
                        <div id="allocation-comparison"></div>
                    </div>

                    <!-- Current Allocation Chart -->
                    <div class="chart-container" style="margin-top: 20px;">
                        <canvas id="portfolio-chart"></canvas>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button onclick="refreshPrices()" class="btn btn-primary" style="flex: 1; min-width: 200px;">
                            <i data-lucide="refresh-cw"></i> ×¨×¢× ×Ÿ ××—×™×¨×™ ×× ×™×•×ª
                        </button>
                        
                        <button onclick="fixGroupIds()" class="btn btn-warning" style="flex: 1; min-width: 200px;">
                            <i data-lucide="wrench"></i> ×ª×§×Ÿ ×§×‘×•×¦×•×ª
                        </button>
                    </div>
                </div>

                <!-- ===== TAB: CHARTS (NEW!) ===== -->
                <div id="tab-charts" class="tab-content">
                    <h2 style="text-align: center; color: var(--text-primary); margin-bottom: 25px;">
                        ğŸ“Š ×’×¨×¤×™× ××ª×§×“××™×
                    </h2>
                    
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1rem;">
                        ××¢×§×‘ ×•×™×–×•××œ×™ ××—×¨ ×‘×™×¦×•×¢×™ ×”×ª×™×§ ×©×œ×š ×œ××•×¨×š ×–××Ÿ
                    </p>

                    <div class="charts-grid">
                        <!-- Portfolio Value Over Time -->
                        <div class="chart-container large">
                            <div class="chart-title">
                                <i data-lucide="trending-up"></i>
                                ×”×ª×¤×ª×—×•×ª ×¢×¨×š ×”×ª×™×§ ×œ××•×¨×š ×–××Ÿ
                            </div>
                            <canvas id="value-over-time-chart"></canvas>
                        </div>

                        <!-- Gain/Loss Over Time -->
                        <div class="chart-container large">
                            <div class="chart-title">
                                <i data-lucide="bar-chart-2"></i>
                                ×¨×•×•×—/×”×¤×¡×“ ×œ××•×¨×š ×–××Ÿ
                            </div>
                            <canvas id="gain-loss-chart"></canvas>
                        </div>

                        <!-- Currency Distribution -->
                        <div class="chart-container">
                            <div class="chart-title">
                                <i data-lucide="pie-chart"></i>
                                ×”×ª×¤×œ×’×•×ª ××˜×‘×¢×•×ª
                            </div>
                            <canvas id="currency-distribution-chart"></canvas>
                        </div>

                        <!-- Performance Comparison -->
                        <div class="chart-container">
                            <div class="chart-title">
                                <i data-lucide="activity"></i>
                                ×‘×™×¦×•×¢×™× ×™×—×¡×™×ª ×œ××™× ×“×§×¡
                            </div>
                            <canvas id="performance-comparison-chart"></canvas>
                        </div>
                    </div>
                </div>

<div id="tab-analysis" class="tab-content">
                <h2 style="text-align: center; color: #1f2937; margin-bottom: 15px;">
                    ğŸ”¬ × ×™×ª×•×— ××ª×§×“× ×©×œ ×”×ª×™×§
                </h2>
                
                <!-- Info Box -->
                <div style="text-align: center; margin-bottom: 25px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-right: 4px solid #3b82f6;">
                    <div style="font-size: 0.9rem; color: #1f2937; line-height: 1.6;">
                        ğŸ’¡ <strong>TWR vs MWR:</strong> 
                        TWR (×‘×˜××‘ ×¡×™×›×•×) ××•×“×“ ×‘×™×¦×•×¢×™ ×”×©×•×§ ×‘×œ×™ ×”×©×¤×¢×ª ×ª×–××•×Ÿ ×”×”×¤×§×“×•×ª. 
                        <strong>MWR</strong> (×›××Ÿ ×œ××˜×”) ××—×©×‘ ×ª×©×•××” ×©××ª×—×©×‘×ª ×‘×ª×–××•×Ÿ - ×× ×”×¤×§×“×ª ×›×¡×£ ×‘××•×¢×“ ×˜×•×‘/×¨×¢.
                    </div>
                </div>

                <!-- KPI Cards Section -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Sharpe Ratio Card -->
                    <div class="glass" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“ˆ</div>
                            <div style="font-size: 0.85rem; color: #1e40af; font-weight: 600; margin-bottom: 10px;">Sharpe Ratio</div>
                            <div id="sharpe-ratio" style="font-size: 2.5rem; font-weight: bold; color: #2563eb; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ×ª×©×•××” ××•×œ ×¡×™×›×•×Ÿ<br>
                                <span style="color: #16a34a;">â†‘ ×™×•×ª×¨ ×˜×•×‘</span>
                            </div>
                        </div>
                    </div>

                    <!-- Max Drawdown Card -->
                    <div class="glass" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 2px solid #ef4444; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“‰</div>
                            <div style="font-size: 0.85rem; color: #991b1b; font-weight: 600; margin-bottom: 10px;">Max Drawdown</div>
                            <div id="max-drawdown" style="font-size: 2.5rem; font-weight: bold; color: #dc2626; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ×™×¨×™×“×” ××§×¡×™××œ×™×ª<br>
                                <span style="color: #16a34a;">â†‘ ×§×¨×•×‘ ×œ-0% ×™×•×ª×¨ ×˜×•×‘</span>
                            </div>
                        </div>
                    </div>

                    <!-- Volatility Card -->
                    <div class="glass" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“Š</div>
                            <div style="font-size: 0.85rem; color: #92400e; font-weight: 600; margin-bottom: 10px;">Volatility</div>
                            <div id="volatility" style="font-size: 2.5rem; font-weight: bold; color: #d97706; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ×¡×˜×™×™×ª ×ª×§×Ÿ ×©× ×ª×™×ª<br>
                                <span style="color: #16a34a;">â†“ ×¤×—×•×ª ×ª× ×•×“×•×ª</span>
                            </div>
                        </div>
                    </div>

                    <!-- Win Rate Card -->
                    <div class="glass" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 2px solid #10b981; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ¯</div>
                            <div style="font-size: 0.85rem; color: #065f46; font-weight: 600; margin-bottom: 10px;">Win Rate</div>
                            <div id="win-rate" style="font-size: 2.5rem; font-weight: bold; color: #059669; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ××—×•×– ×× ×™×•×ª ×‘×¨×•×•×—<br>
                                <span style="color: #16a34a;">â†‘ ×™×•×ª×¨ ×˜×•×‘</span>
                            </div>
                        </div>
                    </div>

                    <!-- MWR Card -->
                    <div class="glass" style="background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%); border: 2px solid #a855f7; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ’°</div>
                            <div style="font-size: 0.85rem; color: #6b21a8; font-weight: 600; margin-bottom: 10px;">MWR (IRR)</div>
                            <div id="mwr-value" style="font-size: 2.5rem; font-weight: bold; color: #9333ea; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ×ª×©×•××” ××©×•×§×œ×œ×ª ×›×¡×£<br>
                                <span style="color: #16a34a;">×›×•×œ×œ timing</span>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Treemap Section -->
                <div class="glass" style="padding: 25px;">
                    <h3 style="text-align: center; color: #1f2937; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">ğŸŒ³</span>
                        <span>××¤×ª ×”×ª×™×§ (Treemap)</span>
                    </h3>
                    <div style="text-align: center; font-size: 0.85rem; color: #6b7280; margin-bottom: 20px;">
                        ×’×•×“×œ = ××©×§×œ ×‘×ª×™×§ | ×¦×‘×¢ = ×¨×•×•×—/×”×¤×¡×“
                    </div>
                    <div id="treemap-container" style="width: 100%; height: 500px; position: relative; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: #f9fafb;">
                        <!-- Treemap will be drawn here -->
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 0.8rem; color: #6b7280;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #10b981; border-radius: 4px;"></div>
                            <span>×¨×•×•×—</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #6b7280; border-radius: 4px;"></div>
                            <span>× ×™×˜×¨×œ×™</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #ef4444; border-radius: 4px;"></div>
                            <span>×”×¤×¡×“</span>
                        </div>
                    </div>
                </div>

            </div>



                <!-- ===== PLACEHOLDER FOR OTHER TABS ===== -->
                
<!-- Holdings Tab -->
            
<div id="tab-calculator" class="tab-content">
                <div class="calculator-card">
                    <div class="calculator-header">
                        <span style="font-size: 2rem;">ğŸ§®</span>
                        <h3>××—×©×‘×•×Ÿ ×—×œ×•×§×ª ×”×©×§×¢×”</h3>
                    </div>
                    
                    <p style="color: #92400e; margin-bottom: 20px;">
                        ×”×–×Ÿ ×¡×›×•× ×©××ª×” ×¨×•×¦×” ×œ×”×©×§×™×¢ ×•×”××¢×¨×›×ª ×ª×—×©×‘ ×œ×š ××™×š ×œ×—×œ×§ ××•×ª×• ×‘×™×Ÿ ×”×× ×™×•×ª ×¢×œ ×¤×™ ×”×¤×¢×¨×™× ××”×™×¢×“
                    </p>

                    <div class="calc-input-group">
                        <div class="form-group" style="flex: 1;">
                            <label>×¡×›×•× ×œ×”×©×§×¢×” (â‚ª)</label>
                            <input type="number" id="invest-amount" placeholder="10000" step="100">
                        </div>
                        <button onclick="calculateInvestment()" class="btn btn-success">
                            âœ¨ ×—×©×‘ ×—×œ×•×§×”
                        </button>
                    </div>

                    <div id="calc-results" class="calc-results">
                        <h4 style="margin-bottom: 15px; color: #111827;">ğŸ’¡ ×”××œ×¦×ª ×—×œ×•×§×”:</h4>
                        <div id="calc-items"></div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>×¡×”"×›:</span>
                                <span id="calc-total" style="color: #667eea; font-size: 1.2rem;">â‚ª0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                    <h4 style="margin-bottom: 10px; color: #1e40af;">â„¹ï¸ ××™×š ×–×” ×¢×•×‘×“?</h4>
                    <ul style="color: #1e3a8a; line-height: 1.8;">
                        <li>×”××¢×¨×›×ª ××—×©×‘×ª ××ª ×”×¤×¢×¨ ×©×œ ×›×œ ×§×‘×•×¦×” ××”×™×¢×“ ×©×œ×”</li>
                        <li>×”×§×‘×•×¦×•×ª ×¢× ×”×¤×¢×¨ ×”×’×“×•×œ ×‘×™×•×ª×¨ ××§×‘×œ×•×ª ×™×•×ª×¨ ×›×¡×£</li>
                        <li>×‘×ª×•×š ×›×œ ×§×‘×•×¦×”, ×”×”×©×§×¢×” ××ª×—×œ×§×ª ×‘××•×¤×Ÿ ×©×•×•×” ×‘×™×Ÿ ×”×× ×™×•×ª</li>
                        <li>×–×” ×¢×•×–×¨ ×œ×š ×œ×©××•×¨ ×¢×œ ×”×ª××”×™×œ ×”×¨×¦×•×™ ×œ××•×¨×š ×–××Ÿ</li>
                    </ul>
                </div>
            </div>

            
<div id="tab-holdings" class="tab-content">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showAddHoldingForm()" class="btn btn-success">â• ×”×•×¡×£ ×”×—×–×§×”</button>
                    <button onclick="refreshPrices()" class="btn btn-primary">ğŸ”„ ×¨×¢× ×Ÿ ××—×™×¨×™×</button>
                </div>

                <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <span style="font-size: 1.5rem;">ğŸ‡®ğŸ‡±</span>
                        <div>
                            <strong style="color: #1e40af;">× ×™×™×¨×•×ª ×¢×¨×š ×™×©×¨××œ×™×™×:</strong>
                            <p style="margin: 5px 0 0 0; color: #1e3a8a; font-size: 0.9rem;">
                                ×œ××¡×¤×¨×™ × ×™×™×¨×•×ª ×¢×¨×š ×™×©×¨××œ×™×™× (7 ×¡×¤×¨×•×ª, ×œ×“×•×’××: 1209220), <strong>×”×–×Ÿ ××ª ×”××¡×¤×¨</strong>. ×”××¢×¨×›×ª ×ª× ×¡×” ×œ×©××•×‘ ××—×™×¨×™× ××”×‘×•×¨×¡×”.
                            </p>
                            <div style="margin: 8px 0 0 0; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                <p style="margin: 0; color: #92400e; font-size: 0.85rem;">
                                    âš ï¸ <strong>×—×©×•×‘:</strong> ×©××™×‘×ª ××—×™×¨×™× ××•×˜×•××˜×™×ª ××”×‘×•×¨×¡×” ×”×™×©×¨××œ×™×ª ×œ× ×ª××™×“ ×¢×•×‘×“×ª (×‘×’×œ×œ ××’×‘×œ×•×ª ×˜×›× ×™×•×ª).
                                </p>
                            </div>
                            <p style="margin: 8px 0 0 0; color: #1e3a8a; font-size: 0.85rem;">
                                ğŸ’¡ <strong>×”××œ×¦×”:</strong> 
                            </p>
                            <ol style="margin: 5px 0 0 20px; color: #1e3a8a; font-size: 0.85rem; line-height: 1.6;">
                                <li>×”×’×“×¨ <strong>"×˜×™×§×¨ ×—×œ×•×¤×™"</strong> (×× ×™×© - ×œ×“×•×’××: VWRL.L ×œ×ª×¢×•×“×ª ×¡×œ)</li>
                                <li>××• ×”×©×ª××© ×‘×›×¤×ª×•×¨ <strong>"ğŸ’° ××—×™×¨"</strong> ×œ×¢×“×›×Ÿ ×™×“× ×™×ª</li>
                                <li>×¢×“×›×Ÿ ××—×™×¨×™× ×™×“× ×™×ª ×<a href="https://www.tase.co.il" target="_blank" style="color: #667eea;">××ª×¨ ×”×‘×•×¨×¡×”</a></li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div id="add-holding-form" style="display: none; margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 12px;">
                    <h3 style="margin-bottom: 20px;">×”×•×¡×£ ×”×—×–×§×” ×—×“×©×”</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>×¡×™××•×œ / ××¡' × ×™×™×¨ ×¢×¨×š (×œ××©×œ: AAPL, 1209220)</label>
                            <input type="text" id="new-symbol" placeholder="AAPL">
                            <small style="color: #6b7280; font-size: 0.8rem;">× ×™×™×¨×•×ª ×™×©×¨××œ×™×™×: ×”×–×Ÿ ××¡×¤×¨ × ×™×™×¨ ×¢×¨×š ×‘×Ÿ 7 ×¡×¤×¨×•×ª</small>
                        </div>
                        <div class="form-group">
                            <label>×˜×™×§×¨ ×—×œ×•×¤×™ (×’×™×‘×•×™ - ××•×¤×¦×™×•× ×œ×™)</label>
                            <input type="text" id="new-alt-ticker" placeholder="VWRL.L">
                            <small style="color: #6b7280; font-size: 0.8rem;">×’×™×‘×•×™ ×× ×”×©××™×‘×” ××”×‘×•×¨×¡×” ×”×™×©×¨××œ×™×ª ×œ× ×¢×•×‘×“×ª</small>
                        </div>
                        <div class="form-group">
                            <label>××¡×¤×¨ ×× ×™×•×ª</label>
                            <input type="number" id="new-shares" placeholder="10" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>××—×™×¨ ×§× ×™×™×” ×××•×¦×¢</label>
                            <input type="number" id="new-cost" placeholder="150.50" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>××˜×‘×¢</label>
                            <select id="new-currency">
                                <option value="ILS">â‚ª ×©×§×œ</option>
                                <option value="USD">$ ×“×•×œ×¨</option>
                                <option value="EUR">â‚¬ ×™×•×¨×•</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸ“… ×ª××¨×™×š ×§× ×™×™×”</label>
                            <input type="date" id="new-purchase-date" style="direction: ltr;">
                            <small style="color: #6b7280; font-size: 0.8rem;">×”×©××¨ ×¨×™×§ ×œ×ª××¨×™×š ×”×™×•×</small>
                        </div>
                        <div class="form-group">
                            <label>×§×‘×•×¦×”</label>
                            <select id="new-group"></select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addHolding()" class="btn btn-success">âœ… ×©××•×¨</button>
                        <button onclick="hideAddHoldingForm()" class="btn" style="background: #6b7280; color: white;">âŒ ×‘×™×˜×•×œ</button>
                    </div>
                </div>

                <div id="holdings-list" class="holdings-grid"></div>
            </div>

            <!-- Bonds Tab -->
            <div id="tab-bonds" class="tab-content">
                <h3 style="margin-bottom: 20px;">ğŸ’¼ ×§×¨× ×•×ª ××’"×—</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showAddBondForm()" class="btn btn-success">â• ×”×•×¡×£ ×§×¨×Ÿ ××’"×—</button>
                    <button onclick="refreshBondPrices()" class="btn btn-primary">ğŸ”„ ×¨×¢× ×Ÿ ××—×™×¨×™×</button>
                </div>

                <!-- Add Bond Form -->
                <div id="add-bond-form" style="display: none; margin-bottom: 30px;" class="glass">
                    <h4 style="margin-bottom: 15px;">×”×•×¡×£/×¢×¨×•×š ×§×¨×Ÿ ××’"×—</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>××¡×¤×¨ × ×™×™×¨ ×¢×¨×š / ×¡×™××•×œ</label>
                            <input type="text" id="bond-symbol" placeholder="1234567">
                            <small style="color: #6b7280; font-size: 0.8rem;">× ×™×™×¨×•×ª ×™×©×¨××œ×™×™×: ×”×–×Ÿ ××¡×¤×¨ × ×™×™×¨ ×¢×¨×š ×‘×Ÿ 7 ×¡×¤×¨×•×ª</small>
                        </div>
                        <div class="form-group">
                            <label>×˜×™×§×¨ ×—×œ×•×¤×™ (×’×™×‘×•×™ - ××•×¤×¦×™×•× ×œ×™)</label>
                            <input type="text" id="bond-alt-ticker" placeholder="BOND.TA">
                            <small style="color: #6b7280; font-size: 0.8rem;">×’×™×‘×•×™ ×× ×”×©××™×‘×” ××”×‘×•×¨×¡×” ×œ× ×¢×•×‘×“×ª</small>
                        </div>
                        <div class="form-group">
                            <label>×›××•×ª ×™×—×™×“×•×ª</label>
                            <input type="number" id="bond-units" step="0.001" placeholder="500">
                        </div>
                        <div class="form-group">
                            <label>××—×™×¨ ×§× ×™×™×” ×œ×™×—×™×“×”</label>
                            <input type="number" id="bond-cost" step="0.01" placeholder="100.00">
                        </div>
                        <div class="form-group">
                            <label>×ª××¨×™×š ×§× ×™×™×”</label>
                            <input type="date" id="bond-purchase-date">
                        </div>
                        <div class="form-group">
                            <label>××˜×‘×¢</label>
                            <select id="bond-currency">
                                <option value="ILS">â‚ª ×©×§×œ (ILS)</option>
                                <option value="USD">$ ×“×•×œ×¨ (USD)</option>
                                <option value="EUR">â‚¬ ×™×•×¨×• (EUR)</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="saveBond()" class="btn btn-success">ğŸ’¾ ×©××•×¨</button>
                        <button onclick="hideAddBondForm()" class="btn" style="background: #6b7280;">×‘×™×˜×•×œ</button>
                    </div>
                </div>

                <!-- Bonds List -->
                <div id="bonds-list"></div>
            </div>

            <!-- Groups Tab -->
            <div id="tab-groups" class="tab-content">
                <h3 style="margin-bottom: 20px;">×§×‘×•×¦×•×ª ×”×”×©×§×¢×” ×©×œ×š</h3>
                <div id="groups-list" class="groups-list"></div>
            </div>

            <!-- Recommendations Tab -->
            <div id="tab-recommendations" class="tab-content">
                <h3 style="margin-bottom: 20px;">ğŸ’¡ ×”××œ×¦×•×ª ×œ××™×–×•×Ÿ ×ª×™×§</h3>
                <div id="recommendations-list"></div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content">
                <h3 style="margin-bottom: 20px;">ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ×¢×¡×§××•×ª</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="filterTransactions('all')" class="btn btn-primary" id="filter-all">×”×›×œ</button>
                    <button onclick="filterTransactions('deposits')" class="btn" id="filter-deposits">×”×¤×§×“×•×ª</button>
                    <button onclick="filterTransactions('withdrawals')" class="btn" id="filter-withdrawals">××©×™×›×•×ª</button>
                    <button onclick="filterTransactions('purchases')" class="btn" id="filter-purchases">×§× ×™×•×ª</button>
                    <button onclick="filterTransactions('sales')" class="btn" id="filter-sales">××›×™×¨×•×ª</button>
                </div>
                
                <div class="glass">
                    <div id="transactions-list"></div>
                </div>
            </div>

            <!-- Capital Tab -->
            <!-- Cash Flow Tab -->
            <div id="tab-cashflow" class="tab-content">
                <h3 style="margin-bottom: 20px;">ğŸ’° ×ª×–×¨×™× ×›×¡×¤×™</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showDepositModal()" class="btn btn-success">ğŸ“¥ ×”×¤×§×“×”</button>
                    <button onclick="showWithdrawalModal()" class="btn" style="background: #ef4444; color: white;">ğŸ“¤ ××©×™×›×”</button>
                </div>
                
                <!-- Cash Balances Container -->
                <div id="cash-balances-container"></div>
                
                <!-- Deposits -->
                <div class="glass" style="margin-bottom: 20px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">
                    <h4 style="margin-bottom: 15px; color: #065f46;">ğŸ“¥ ×”×¤×§×“×•×ª</h4>
                    <div id="deposits-list" style="margin-bottom: 15px;"></div>
                    <div style="padding: 10px; background: white; border-radius: 8px; text-align: center;">
                        <strong style="color: #10b981;">×¡×”"×› ×”×¤×§×“×•×ª: â‚ª<span id="total-deposits">0</span></strong>
                    </div>
                </div>
                
                <!-- Withdrawals -->
                <div class="glass" style="margin-bottom: 20px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                    <h4 style="margin-bottom: 15px; color: #7f1d1d;">ğŸ“¤ ××©×™×›×•×ª</h4>
                    <div id="withdrawals-list" style="margin-bottom: 15px;"></div>
                    <div style="padding: 10px; background: white; border-radius: 8px; text-align: center;">
                        <strong style="color: #ef4444;">×¡×”"×› ××©×™×›×•×ª: â‚ª<span id="total-withdrawals">0</span></strong>
                    </div>
                </div>
                

            </div>
            
            <!-- Performance Tab -->
            <!-- Deposit Modal -->
            <div id="deposit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">ğŸ“¥ ×”×¤×§×“×” ×œ×ª×™×§</h3>
                    
                    <div class="form-group">
                        <label>×¡×›×•× ×”×”×¤×§×“×” (â‚ª)</label>
                        <input type="number" id="deposit-amount" placeholder="10000" step="100">
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ“… ×ª××¨×™×š ×”×”×¤×§×“×”</label>
                        <input type="date" id="deposit-date" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                    </div>
                    

                    
                    <div class="form-group">
                        <label>×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="text" id="deposit-note" placeholder="×”×©×§×¢×” ×—×•×“×©×™×ª">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideDepositModal()" class="btn" style="background: #6b7280;">×‘×™×˜×•×œ</button>
                        <button onclick="submitDeposit()" class="btn btn-success">××™×©×•×¨ ×”×¤×§×“×”</button>
                    </div>
                </div>
            </div>

            <!-- Withdrawal Modal -->
            <div id="withdrawal-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">ğŸ“¤ ××©×™×›×” ××”×ª×™×§</h3>
                    
                    <div style="padding: 10px; background: #f0f9ff; border-radius: 8px; margin-bottom: 15px; border: 2px solid #3b82f6;">
                        <div style="font-size: 0.9rem; color: #1e40af;">××–×•××Ÿ ×–××™×Ÿ ×œ××©×™×›×”: <strong>â‚ª<span id="withdrawal-max">0</span></strong></div>
                    </div>
                    
                    <div class="form-group">
                        <label>×¡×›×•× ×”××©×™×›×” (â‚ª)</label>
                        <input type="number" id="withdrawal-amount" placeholder="5000" step="100">
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ“… ×ª××¨×™×š ×”××©×™×›×”</label>
                        <input type="date" id="withdrawal-date" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                    </div>
                    

                    
                    <div class="form-group">
                        <label>×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="text" id="withdrawal-note" placeholder="×¨×•×•×—×™×">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideWithdrawalModal()" class="btn" style="background: #6b7280;">×‘×™×˜×•×œ</button>
                        <button onclick="submitWithdrawal()" class="btn" style="background: #ef4444; color: white;">××™×©×•×¨ ××©×™×›×”</button>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
                <h3 style="margin-bottom: 20px;">âš™ï¸ ×”×’×“×¨×•×ª</h3>
                
                <div class="glass" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">ğŸ’± ×©×¢×¨×™ ×”××¨×”</h4>
                    <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">
                        ğŸ“ <strong>×¢×¨×•×š ××ª ×”×©×¢×¨×™× ×™×“× ×™×ª</strong> ××• × ×¡×” ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
                    </p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>×“×•×œ×¨ ($) ×œ×©×§×œ</label>
                            <input type="number" id="rate-usd" step="0.0001" value="3.7500" 
                                   placeholder="3.7500" 
                                   style="background: #fffbeb; border: 2px solid #f59e0b;">
                        </div>
                        <div class="form-group">
                            <label>×™×•×¨×• (â‚¬) ×œ×©×§×œ</label>
                            <input type="number" id="rate-eur" step="0.0001" value="4.0500" 
                                   placeholder="4.0500"
                                   style="background: #fffbeb; border: 2px solid #f59e0b;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button onclick="tryAutoUpdateRates()" class="btn btn-primary">
                            ğŸ”„ ×¨×¢× ×Ÿ ××•×˜×•××˜×™×ª
                        </button>
                        <button onclick="updateExchangeRates()" class="btn btn-success">
                            ğŸ’¾ ×©××•×¨ ×©×¢×¨×™×
                        </button>
                    </div>
                    <p style="color: #6b7280; margin-top: 10px; font-size: 0.8rem;">
                        ğŸ’¡ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×× ×¡×” ×œ××©×•×š ×©×¢×¨×™× ××”××™× ×˜×¨× ×˜. ×× ×–×” ×œ× ×¢×•×‘×“, ×¢×¨×•×š ×™×“× ×™×ª ×-<a href="https://www.boi.org.il/he/markets/exchangerates/" target="_blank" style="color: #667eea;">×‘× ×§ ×™×©×¨××œ</a>
                    </p>
                </div>

                <div class="glass">
                    <h4 style="margin-bottom: 15px;">ğŸ’¾ ×’×™×‘×•×™ ×•×©×—×–×•×¨</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="exportData()" class="btn btn-primary">ğŸ“¤ ×™×™×¦×•× × ×ª×•× ×™×</button>
                        <label class="btn btn-success" style="cursor: pointer;">
                            ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™×
                            <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                        </label>
                    </div>
                </div>
                
                <div class="glass" style="border: 2px solid #f59e0b;">
                    <h4 style="margin-bottom: 15px; color: #f59e0b;">ğŸ”§ ×ª×™×§×•×Ÿ TWR</h4>
                    <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">
                        ×× TWR ×œ× ×¢×•×‘×“, ×–×” ×‘×’×œ×œ snapshots ×™×©× ×™×. ×œ×—×¥ ×›××Ÿ ×œ××—×•×§ snapshots ×™×©× ×™× ×•×œ×™×¦×•×¨ ×—×“×©.
                    </p>
                    <button onclick="fixSnapshots()" class="btn" style="background: #f59e0b; color: white;">
                        ğŸ”§ ×ª×§×Ÿ Snapshots
                    </button>
                </div>
                
                <div class="glass" style="border: 2px solid #ef4444;">
                    <h4 style="margin-bottom: 15px; color: #ef4444;">ğŸ—‘ï¸ ××–×•×¨ ××¡×•×›×Ÿ</h4>
                    <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">
                        âš ï¸ <strong>×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”!</strong> ××—×™×§×ª ×›×œ ×”× ×ª×•× ×™× ×ª××—×§ ×œ×¦××™×ª×•×ª ××ª ×›×œ ×”×× ×™×•×ª, ×”××’"×—, ×”×”×¤×§×“×•×ª, ×”××©×™×›×•×ª ×•×”×¢×¡×§××•×ª.
                    </p>
                    <button onclick="deleteAllData()" class="btn" style="background: #ef4444; color: white;">
                        ğŸ—‘ï¸ ××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End mainContent -->
<div id="notification" class="notification"></div>

    <script>
        
// ===== LOCAL VERSION - NO FIREBASE =====
        // This version works without authentication, using only localStorage
        
        let currentUser = { uid: 'local-user' }; // Mock user for localStorage
        let authChecked = true;
        
        // Initialize immediately on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ§ª LOCAL MODE - Using localStorage only');
            init();
        });

        // ===========================================
        // DATA STRUCTURE - ENHANCED
        // ===========================================
        
        let editingHoldingId = null; // Track which holding is being edited
        
        
        // âœ¨ × ×ª×•× ×™× ××ª×•×§× ×™× ××”××§×¡×œ×™× - 2025-10-30T22:36:57.557729
        // ğŸ“Š 6 ×× ×™×•×ª/×§×¨× ×•×ª | 2 ××’"×—
        // ğŸ’° ×™×ª×¨×•×ª: â‚ª36.90 + $27.08
        // [REMOVED] let portfolio = {} - ×”×•×¡×¨ ×›×“×™ ×œ× ×œ×“×¨×•×¡ ××ª ×”× ×ª×•× ×™× ××”-IIFE
        // portfolio ×™×˜×¢×Ÿ ×-localStorage ×¢×œ ×™×“×™ loadData()
        let portfolio = {};  // ×™×—×œ×™×£ loadData


        // ============================================
        // [DISABLED] FORCE SAVE - DO NOT OVERWRITE USER DATA
        // ============================================
        // ×”×¡×§×¨×™×¤×˜ ×”×–×” ×”×•×©×‘×ª ×›×“×™ ×œ× ×œ×“×¨×•×¡ × ×ª×•× ×™× ×©×œ ×”××©×ª××©
        /*
        console.log('ğŸ’¾ ×›×•×¤×” ×©××™×¨×ª × ×ª×•× ×™× ×—×“×©×™× ×œ-localStorage...');
        localStorage.setItem('portfolio', JSON.stringify(portfolio));
        console.log('âœ… × ×ª×•× ×™× ×—×“×©×™× × ×©××¨×• ×‘×›×•×—!');
        console.log('   - IBI ××›×™×¨×•×ª ×ª×•×§× ×• (×—×•×œ×§×• ×‘-100)');
        console.log('   - ××©×›× ×ª× ×ª×•×§× ×” (×—×•×œ×§×” ×‘-100)');
        console.log('   - ××©×™×›×•×ª: ' + portfolio.withdrawals.length);
        console.log('   - ××›×™×¨×•×ª: ' + portfolio.sales.length);
        */


        let charts = {};

        // ===========================================
        // EXCHANGE RATES - AUTO UPDATE
        // ===========================================
        
        async function updateExchangeRates() {
            // ×¢×“×›×•×Ÿ ××”×©×“×•×ª ×‘×××©×§ (×¢×“×›×•×Ÿ ×™×“× ×™)
            const usdInput = document.getElementById('rate-usd');
            const eurInput = document.getElementById('rate-eur');
            
            const usdValue = parseFloat(usdInput.value);
            const eurValue = parseFloat(eurInput.value);
            
            if (!isNaN(usdValue) && usdValue > 0) {
                portfolio.rates.USD = usdValue;
            }
            if (!isNaN(eurValue) && eurValue > 0) {
                portfolio.rates.EUR = eurValue;
            }
            
            saveData();
            updateOverview();
            notify(`âœ… ×©×¢×¨×™× × ×©××¨×•! $1 = â‚ª${portfolio.rates.USD.toFixed(2)} | â‚¬1 = â‚ª${portfolio.rates.EUR.toFixed(2)}`);
        }
        
        async function tryAutoUpdateRates() {
            const notif = document.getElementById('notification');
            notif.textContent = 'ğŸ”„ ××•×©×š ×©×¢×¨×™× ××”××™× ×˜×¨× ×˜...';
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ”„ Starting automatic exchange rate update...');
            console.log('Current rates before update:', { 
                USD: portfolio.rates.USD, 
                EUR: portfolio.rates.EUR 
            });
            
            try {
                const success = await autoUpdateExchangeRates();
                
                // Always hide the loading message
                notif.classList.remove('show');
                
                if (success) {
                    console.log('New rates after update:', { 
                        USD: portfolio.rates.USD, 
                        EUR: portfolio.rates.EUR 
                    });
                    console.log('âœ… Exchange rates updated successfully!');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    
                    updateOverview();
                    notify(`âœ… ×©×¢×¨×™× ×¢×•×“×›× ×•!\nğŸ’µ $1 = â‚ª${portfolio.rates.USD.toFixed(4)}\nğŸ’¶ â‚¬1 = â‚ª${portfolio.rates.EUR.toFixed(4)}`);
                } else {
                    console.log('âŒ All API methods failed');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    notify('âš ï¸ ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ × ×›×©×œ. ×¢×¨×•×š ×™×“× ×™×ª ××• × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨', 'warning');
                }
            } catch (error) {
                console.error('âŒ Error during exchange rate update:', error);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                notif.classList.remove('show');
                notify('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©×¢×¨×™×. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨', 'error');
            }
        }
        
        async function autoUpdateExchangeRates() {
            // × ×™×¡×™×•×Ÿ ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×¢× ××¡×¤×¨ APIs (××•×¤×¦×™×•× ×œ×™ - ×œ× ×›×©×œ×•×Ÿ ×× × ×›×©×œ)
            console.log('ğŸ”„ Trying to auto-update exchange rates...');
            
            // × ×™×¡×™×•×Ÿ 1: Frankfurter API
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=ILS,EUR');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“Š Frankfurter API response:', data);
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: 1 USD = X ILS and 1 USD = Y EUR
                        // We need: USD to ILS and EUR to ILS
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(`ğŸ’µ USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // If 1 USD = 3.75 ILS and 1 USD = 0.92 EUR
                        // Then 1 EUR = (1/0.92) USD = 1.087 USD
                        // So 1 EUR = 1.087 Ã— 3.75 = 4.08 ILS
                        // Formula: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(`ğŸ’¶ EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log('âœ… Exchange rates updated via Frankfurter API');
                        console.log(`   Final rates: $1 = â‚ª${portfolio.rates.USD.toFixed(4)}, â‚¬1 = â‚ª${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('âš ï¸ Frankfurter API failed:', error.message);
            }
            
            // × ×™×¡×™×•×Ÿ 2: ExchangeRate-API
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“Š ExchangeRate-API response (first 5 rates):', {
                        ILS: data.rates?.ILS,
                        EUR: data.rates?.EUR,
                        GBP: data.rates?.GBP,
                        JPY: data.rates?.JPY,
                        CNY: data.rates?.CNY
                    });
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: all rates relative to 1 USD
                        // 1 USD = X ILS, 1 USD = Y EUR
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(`ğŸ’µ USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // Same logic as above: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(`ğŸ’¶ EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log('âœ… Exchange rates updated via ExchangeRate-API');
                        console.log(`   Final rates: $1 = â‚ª${portfolio.rates.USD.toFixed(4)}, â‚¬1 = â‚ª${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('âš ï¸ ExchangeRate-API failed:', error.message);
            }
            
            // × ×™×¡×™×•×Ÿ 3: ×”×•×¡×£ Bank of Israel API ×× ××¤×©×¨×™
            try {
                // Note: BOI API usually requires CORS proxy or backend
                // This is a fallback attempt
                const response = await fetch('https://www.boi.org.il/currency.xml');
                if (response.ok) {
                    const text = await response.text();
                    console.log('ğŸ“Š BOI XML received, parsing...');
                    // Parse XML for USD and EUR rates
                    // This is complex and might not work due to CORS
                }
            } catch (error) {
                console.log('âš ï¸ BOI API not accessible (CORS or network issue)');
            }
            
            console.log('â„¹ï¸ All auto-update methods failed - using manual rates');
            console.log('ğŸ’¡ You can update manually from: https://www.boi.org.il/he/markets/exchangerates/');
            return false;
        }

        // ===========================================
        // CASH FLOW CORE FUNCTIONS
        // ===========================================
        
        // ×—×™×©×•×‘ ××–×•××Ÿ ×•×™×¨×˜×•××œ×™ (implicit cash)
        function getImplicitCash(assetType = 'all') {
            let deposits = 0;
            let withdrawals = 0;
            let purchases = 0;
            let sales = 0;
            
            if (assetType === 'all' || assetType === 'stocks') {
                deposits += portfolio.deposits
                    .filter(d => !d.assetType || d.assetType === 'stocks')
                    .reduce((sum, d) => sum + (d.amount || 0), 0);
                withdrawals += portfolio.withdrawals
                    .filter(w => !w.assetType || w.assetType === 'stocks')
                    .reduce((sum, w) => sum + (w.amount || 0), 0);
                purchases += portfolio.purchases
                    .filter(p => !p.assetType || p.assetType === 'stocks')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                sales += portfolio.sales
                    .filter(s => !s.assetType || s.assetType === 'stocks')
                    .reduce((sum, s) => sum + (s.amount || 0), 0);
            }
            
            if (assetType === 'all' || assetType === 'bonds') {
                deposits += portfolio.deposits
                    .filter(d => d.assetType === 'bonds')
                    .reduce((sum, d) => sum + (d.amount || 0), 0);
                withdrawals += portfolio.withdrawals
                    .filter(w => w.assetType === 'bonds')
                    .reduce((sum, w) => sum + (w.amount || 0), 0);
                purchases += portfolio.purchases
                    .filter(p => p.assetType === 'bonds')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                sales += portfolio.sales
                    .filter(s => s.assetType === 'bonds')
                    .reduce((sum, s) => sum + (s.amount || 0), 0);
            }
            
            return deposits - withdrawals - purchases + sales;
        }
        
        // ×—×™×©×•×‘ ×©×•×•×™ ×›×•×œ×œ ×©×œ ×”×ª×™×§
        function getTotalPortfolioValue() {
            const stocksValue = getTotalValueILS();
            const bondsValue = portfolio.bonds ? portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0) : 0;
            
            // Use portfolio.cash directly, not getImplicitCash
            const cashILS = portfolio.cash.ILS || 0;
            const cashUSD = (portfolio.cash.USD || 0) * (portfolio.rates.USD || 3.7);
            const cashEUR = (portfolio.cash.EUR || 0) * (portfolio.rates.EUR || 4.0);
            const totalCash = cashILS + cashUSD + cashEUR;
            
            console.log('ğŸ’° Portfolio Value:', {
                stocks: stocksValue,
                bonds: bondsValue,
                cash: totalCash,
                total: stocksValue + bondsValue + totalCash
            });
            
            return stocksValue + bondsValue + totalCash;
        }
        
        // ×—×™×©×•×‘ ×©×•×•×™ ×ª×™×§ ×œ×¤×™ ××—×™×¨ ×§× ×™×™×” (costBasis) - ×œ×©×™××•×© ×‘-snapshots
        function getTotalPortfolioValueAtCost() {
            let stocksValue = 0;
            portfolio.holdings.forEach(h => {
                const value = h.shares * h.costBasis;
                stocksValue += convertToILS(value, h.currency);
            });
            
            const bondsValue = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.costBasis), 0);
            const cash = getImplicitCash('all');
            
            return stocksValue + bondsValue + cash;
        }
        
        // ×™×¦×™×¨×ª Snapshot (×œ×¤× ×™ ×”×¤×§×“×”/××©×™×›×”!)
        function createSnapshot(triggerType, triggerNote = '', cashFlow = 0, customDate = null) {
            const snapshot = {
                id: Date.now(),
                date: customDate || new Date().toISOString(),
                value_before_flow: getTotalPortfolioValue(), // ×©×•×•×™ ×”×ª×™×§ ×œ×¤× ×™ ×–×¨×™××ª ×”××–×•××Ÿ
                cash_flow: cashFlow, // ×¡×›×•× ×”×”×¤×§×“×” (+) ××• ×”××©×™×›×” (-)
                stocksValue: getTotalValueILS(),
                bondsValue: portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0),
                implicitCash: getImplicitCash('all'),
                totalValue: getTotalPortfolioValue(),
                triggerType: triggerType, // 'deposit' or 'withdrawal'
                triggerNote: triggerNote
            };
            
            portfolio.snapshots.push(snapshot);
            
            // Sort snapshots by date after adding new one
            portfolio.snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            console.log('ğŸ“¸ Snapshot created:', snapshot);
            return snapshot;
        }
        
        // ×—×™×©×•×‘ TWR ×¢× ×ª××™×›×” ×‘-Live TWR
        function calculateTWR(assetType = 'total') {
            if (!portfolio.snapshots || portfolio.snapshots.length === 0) {
                return null;
            }
            
            const snapshots = [...portfolio.snapshots].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // ×× ×™×© ×¨×§ snapshot ××—×“, ××™×Ÿ ×”×™×¡×˜×•×¨×™×” - ×¨×§ Live
            if (snapshots.length === 1) {
                const lastSnapshot = snapshots[0];
                const startValue = lastSnapshot.value_before_flow + lastSnapshot.cash_flow;
                const currentValue = getTotalPortfolioValue();
                
                if (startValue === 0) return null;
                
                const R_Live = (currentValue - startValue) / startValue;
                
                console.log(`ğŸ“Š Live only: Start=â‚ª${startValue.toFixed(0)}, Current=â‚ª${currentValue.toFixed(0)}, R=${(R_Live*100).toFixed(2)}%`);
                
                return {
                    total: R_Live * 100,
                    annualized: null,
                    years: 0,
                    periods: 1
                };
            }
            
            // === ×—×œ×§ 1: TWR_Base (×”×™×¡×˜×•×¨×™) ===
            const periodicReturns = [];
            
            // ×—×™×©×•×‘ ×ª×©×•××•×ª ×œ×›×œ ×”×ª×§×•×¤×•×ª ×”×¡×’×•×¨×•×ª (×¢×“ snapshot-1 ×œ×¤× ×™ ××—×¨×•×Ÿ)
            for (let i = 1; i < snapshots.length; i++) {
                const currentEvent = snapshots[i];
                const previousEvent = snapshots[i - 1];
                
                // Check if snapshots have the new format (value_before_flow, cash_flow)
                if (previousEvent.value_before_flow !== undefined && previousEvent.cash_flow !== undefined &&
                    currentEvent.value_before_flow !== undefined) {
                    
                    const periodStartValue = previousEvent.value_before_flow + previousEvent.cash_flow;
                    const periodEndValue = currentEvent.value_before_flow;
                    
                    // Skip if values are invalid
                    if (periodStartValue === undefined || periodEndValue === undefined || 
                        periodStartValue === null || periodEndValue === null ||
                        isNaN(periodStartValue) || isNaN(periodEndValue) || periodStartValue === 0) {
                        continue;
                    }
                    
                    const R_i = (periodEndValue - periodStartValue) / periodStartValue;
                    periodicReturns.push(1 + R_i);
                    
                    console.log(`ğŸ“Š Period ${i}: Start=â‚ª${periodStartValue.toFixed(0)}, End=â‚ª${periodEndValue.toFixed(0)}, R=${(R_i*100).toFixed(2)}%`);
                } else {
                    // Old format snapshot - skip or use totalValue as fallback
                    console.warn(`âš ï¸ Old snapshot format detected at index ${i}`);
                }
            }
            
            // ×—×™×©×•×‘ TWR_Base (×œ×œ× ×”×ª×§×•×¤×” ×”×¤×ª×•×—×”)
            const TWR_Base = periodicReturns.length > 0 
                ? periodicReturns.reduce((acc, factor) => acc * factor, 1) - 1 
                : 0;
            
            // === ×—×œ×§ 2: R_Live (×ª×§×•×¤×” ×¤×ª×•×—×”) ===
            const lastSnapshot = snapshots[snapshots.length - 1];
            let startValueLive, currentValueLive, R_Live = 0;
            
            // Check if last snapshot has new format
            if (lastSnapshot.value_before_flow !== undefined && lastSnapshot.cash_flow !== undefined) {
                startValueLive = lastSnapshot.value_before_flow + lastSnapshot.cash_flow;
                currentValueLive = getTotalPortfolioValue();
                
                if (startValueLive !== 0 && !isNaN(startValueLive) && !isNaN(currentValueLive)) {
                    R_Live = (currentValueLive - startValueLive) / startValueLive;
                    console.log(`ğŸ“Š Live: Start=â‚ª${startValueLive.toFixed(0)}, Current=â‚ª${currentValueLive.toFixed(0)}, R=${(R_Live*100).toFixed(2)}%`);
                }
            } else {
                // Old format - use totalValue as fallback
                startValueLive = lastSnapshot.totalValue || 0;
                currentValueLive = getTotalPortfolioValue();
                
                if (startValueLive !== 0 && !isNaN(startValueLive) && !isNaN(currentValueLive)) {
                    R_Live = (currentValueLive - startValueLive) / startValueLive;
                    console.log(`ğŸ“Š Live (fallback): Start=â‚ª${startValueLive.toFixed(0)}, Current=â‚ª${currentValueLive.toFixed(0)}, R=${(R_Live*100).toFixed(2)}%`);
                }
            }
            
            // === ×—×™×©×•×‘ TWR ×›×•×œ×œ ===
            const TWR_Total = (1 + TWR_Base) * (1 + R_Live) - 1;
            
            // ×—×™×©×•×‘ ×ª×§×•×¤×” ×œ×©× ×ª×™×•×ª
            const firstSnapshot = snapshots[0];
            const lastSnapshot_date = snapshots[snapshots.length - 1];
            const daysDiff = (new Date(lastSnapshot_date.date) - new Date(firstSnapshot.date)) / (1000 * 60 * 60 * 24);
            const years = daysDiff / 365.25;
            
            let annualized = null;
            if (years >= 1) {
                annualized = (Math.pow(1 + TWR_Total, 1 / years) - 1) * 100;
            }
            
            console.log(`âœ… TWR: Base=${(TWR_Base*100).toFixed(2)}%, Live=${(R_Live*100).toFixed(2)}%, Total=${(TWR_Total*100).toFixed(2)}%`);
            
            return {
                total: TWR_Total * 100,
                base: TWR_Base * 100,
                live: R_Live * 100,
                annualized: annualized,
                years: years,
                periods: periodicReturns.length + 1 // +1 for live period
            };
        }

        // ===========================================
        // ISRAELI TASE (BORSE) API
        // ===========================================
        
        async function fetchTASEPrice(securityNumber) {
            console.log(`ğŸ‡®ğŸ‡± Fetching Israeli security: ${securityNumber}`);
            
            // Strategy 1: Try TASE Official Site (BEST - real-time updates!)
            try {
                console.log(`ğŸ“Š Strategy 1: TASE Official Site (market.tase.co.il)...`);
                const taseUrl = `https://market.tase.co.il/he/market_data/security/${securityNumber}/major_data`;
                
                const response = await fetch(taseUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    console.log(`âœ… Got TASE HTML, length: ${html.length}`);
                    
                    // Look for "×©×¢×¨ ××—×¨×•×Ÿ (×‘××’×•×¨×•×ª)" or similar
                    const patterns = [
                        // Pattern 1: "×©×¢×¨ ××—×¨×•×Ÿ (×‘××’×•×¨×•×ª):" followed by number
                        /×©×¢×¨ ××—×¨×•×Ÿ\s*\(×‘××’×•×¨×•×ª\)[:\s]*([0-9,]+\.?[0-9]*)/,
                        // Pattern 2: Just "×©×¢×¨ ××—×¨×•×Ÿ" with number
                        /×©×¢×¨ ××—×¨×•×Ÿ[:\s]*([0-9,]+\.?[0-9]*)/,
                        // Pattern 3: Data in structured format
                        /×‘××’×•×¨×•×ª[):\s]*([0-9,]+\.?[0-9]*)/
                    ];
                    
                    for (let i = 0; i < patterns.length; i++) {
                        const match = html.match(patterns[i]);
                        if (match && match[1]) {
                            let priceStr = match[1].trim();
                            let price = parseFloat(priceStr.replace(/,/g, ''));
                            console.log(`ğŸ” TASE Pattern ${i+1} found: "${priceStr}" = ${price}`);
                            
                            if (price && price > 0) {
                                // TASE shows in agorot - convert to shekels
                                if (price > 100) {
                                    console.log(`ğŸ”„ Converting from agorot: ${price} â†’ â‚ª${(price/100).toFixed(2)}`);
                                    price = price / 100;
                                }
                                console.log(`âœ… TASE Official: â‚ª${price.toFixed(2)} (real-time!)`);
                                return price;
                            }
                        }
                    }
                    
                    console.log(`âš ï¸ No price found in TASE HTML (might be JS-rendered)`);
                }
            } catch (e) {
                console.log(`âš ï¸ TASE Official failed: ${e.message}`);
            }
            
            // Strategy 2: Try TheMarker (fallback - end of day prices)
            try {
                console.log(`ğŸ“Š Strategy 2: TheMarker (end-of-day prices)...`);
                const markerUrl = `https://finance.themarker.com/etf/${securityNumber}`;
                
                const response = await fetch(markerUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    console.log(`âœ… Got TheMarker HTML, length: ${html.length}`);
                    
                    // Look for SPECIFIC data cells/patterns
                    const patterns = [
                        // Pattern 1: "×©×¢×¨ ××—×¨×•×Ÿ" followed by number (most specific!)
                        /×©×¢×¨ ××—×¨×•×Ÿ[^\d]*\|\s*([0-9,]+\.?[0-9]*)/,
                        // Pattern 2: In table/data structure with pipe separator
                        /×©×¢×¨ ××—×¨×•×Ÿ[^|]*\|\s*([0-9,]+\.?[0-9]*)/,
                        // Pattern 3: Generic price keywords with clear separation
                        /(?:×©×¢×¨ ××—×¨×•×Ÿ|××—×™×¨ × ×•×›×—×™|×©×•×•×™ ×™×—×™×“×”)[\s\S]{0,50}?([0-9,]+\.?[0-9]*)/,
                        // Pattern 4: Fallback - price near beginning
                        /(?:××—×™×¨|×©×¢×¨)[\s:|\-]{1,10}([0-9,]+\.?[0-9]*)/
                    ];
                    
                    for (let i = 0; i < patterns.length; i++) {
                        const match = html.match(patterns[i]);
                        if (match && match[1]) {
                            let priceStr = match[1].trim();
                            let price = parseFloat(priceStr.replace(/,/g, ''));
                            console.log(`ğŸ” TheMarker Pattern ${i+1} found: "${priceStr}" = ${price}`);
                            
                            if (price && price > 0) {
                                // Convert from agorot if > 100
                                if (price > 100) {
                                    console.log(`ğŸ”„ Converting from agorot: ${price} â†’ â‚ª${(price/100).toFixed(2)}`);
                                    price = price / 100;
                                }
                                console.log(`âœ… TheMarker: â‚ª${price.toFixed(2)} (end-of-day)`);
                                return price;
                            }
                        }
                    }
                    
                    console.log(`âš ï¸ No valid price found in TheMarker HTML`);
                }
            } catch (e) {
                console.log(`âš ï¸ TheMarker failed: ${e.message}`);
            }
            
            // Strategy 3: Try Globes
            try {
                console.log(`ğŸ“Š Strategy 3: Globes...`);
                const globesUrl = `https://www.globes.co.il/portal/instrument.aspx?instrumentid=${securityNumber}`;
                
                const response = await fetch(globesUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    console.log(`âœ… Got Globes HTML, length: ${html.length}`);
                    
                    // Context-based patterns only
                    const patterns = [
                        /(?:×©×¢×¨|××—×™×¨|×©×•×•×™)[^\d]{0,30}(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/,
                        /class="[^"]*price[^"]*"[^>]*>(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/
                    ];
                    
                    for (let i = 0; i < patterns.length; i++) {
                        const match = html.match(patterns[i]);
                        if (match && match[1]) {
                            let priceStr = match[1];
                            let price = parseFloat(priceStr.replace(/,/g, ''));
                            console.log(`ğŸ” Globes Pattern ${i+1} found: "${priceStr}" = ${price}`);
                            
                            if (price && price > 0) {
                                // Convert from agorot if > 100
                                if (price > 100) {
                                    console.log(`ğŸ”„ Converting from agorot: ${price} â†’ â‚ª${(price/100).toFixed(2)}`);
                                    price = price / 100;
                                }
                                console.log(`âœ… Globes: â‚ª${price.toFixed(2)}`);
                                return price;
                            }
                        }
                    }
                    
                    console.log(`âš ï¸ No valid price found in Globes HTML`);
                }
            } catch (e) {
                console.log(`âš ï¸ Globes failed: ${e.message}`);
            }
            
            // Strategy 4: Try Yahoo with .TA suffix
            try {
                console.log(`ğŸ“Š Strategy 4: Yahoo Finance .TA...`);
                let yahooPrice = await fetchYahooChart(`${securityNumber}.TA`);
                if (yahooPrice && yahooPrice > 0) {
                    if (yahooPrice > 100) {
                        console.log(`ğŸ”„ Converting from agorot: ${yahooPrice} â†’ â‚ª${(yahooPrice/100).toFixed(2)}`);
                        yahooPrice = yahooPrice / 100;
                    }
                    console.log(`âœ… Yahoo .TA: â‚ª${yahooPrice.toFixed(2)}`);
                    return yahooPrice;
                }
            } catch (e) {
                console.log(`âš ï¸ Yahoo .TA failed: ${e.message}`);
            }
            
            // Strategy 5: Try alternative Yahoo formats
            try {
                console.log(`ğŸ“Š Strategy 5: Alternative Yahoo formats...`);
                const formats = [
                    `TLV:${securityNumber}`,
                    `TASE:${securityNumber}`,
                    `${securityNumber}.TASE`
                ];
                
                for (const format of formats) {
                    try {
                        let price = await fetchYahooChart(format);
                        if (price && price > 0) {
                            if (price > 100) {
                                price = price / 100;
                            }
                            console.log(`âœ… Yahoo ${format}: â‚ª${price.toFixed(2)}`);
                            return price;
                        }
                    } catch (e) {
                        // Silent - try next
                    }
                }
            } catch (e) {
                console.log(`âš ï¸ Alternative Yahoo formats failed`);
            }
            
            console.log(`âŒ All strategies failed for ${securityNumber}`);
            throw new Error(`ğŸ‡®ğŸ‡± ×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××—×™×¨ ××•×˜×•××˜×™ ×¢×‘×•×¨ ${securityNumber}. ×œ×—×¥ "ğŸ’° ××—×™×¨" ×œ×¢×“×›×Ÿ ×™×“× ×™×ª.`);
        }
        
        function isIsraeliSecurity(symbol) {
            // Israeli security numbers are 7 digits
            return /^\d{7}$/.test(symbol);
        }

        // ===========================================
        // ENHANCED API - WITH MULTIPLE FALLBACKS
        // ===========================================
        
        async function fetchStockPrice(symbol) {
            console.log(`ğŸ” Fetching price for: ${symbol}`);
            
            // First, check if this is an Israeli security
            if (isIsraeliSecurity(symbol)) {
                console.log('ğŸ‡®ğŸ‡± Detected Israeli security number, trying TASE first...');
                try {
                    const price = await fetchTASEPrice(symbol);
                    return price;
                } catch (e) {
                    console.log('âš ï¸ TASE fetch failed, will try alternatives if available');
                }
            }
            
            // × ×™×¡×•×™ 3 ×©×™×˜×•×ª ×©×•× ×•×ª
            const methods = [
                () => fetchYahooChart(symbol),
                () => fetchYahooQuote(symbol),
                () => fetchYahooV10(symbol)
            ];
            
            // × ×™×¡×™×•×Ÿ ×¢× ×”×¡×™××•×œ ×”××§×•×¨×™
            for (const method of methods) {
                try {
                    const price = await method();
                    if (price && price > 0) {
                        console.log(`âœ… Success: ${price}`);
                        return price;
                    }
                } catch (e) {
                    console.log(`âŒ Method failed: ${e.message}`);
                }
            }
            
            // × ×™×¡×™×•×Ÿ ×¢× ×¡×™××•×œ×™× ×—×œ×•×¤×™×™×
            const alternatives = getAlternativeSymbols(symbol);
            for (const alt of alternatives) {
                console.log(`ğŸ”„ Trying alternative: ${alt}`);
                for (const method of methods) {
                    try {
                        const price = await method.call(null, alt);
                        if (price && price > 0) {
                            console.log(`âœ… Success with alternative: ${price}`);
                            return price;
                        }
                    } catch (e) {
                        // ×©×§×˜, ×××©×™×›×™× ×”×œ××”
                    }
                }
            }
            
            throw new Error(`Could not fetch price for ${symbol}`);
        }
        
        async function fetchYahooChart(symbol) {
            // Using CORS proxy to bypass CORS restrictions
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.chart?.result?.[0]?.meta?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        async function fetchYahooQuote(symbol) {
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteResponse?.result?.[0]?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        async function fetchYahooV10(symbol) {
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=price`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteSummary?.result?.[0]?.price?.regularMarketPrice?.raw;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        function getAlternativeSymbols(symbol) {
            const alternatives = [];
            if (symbol.endsWith('.L')) {
                alternatives.push(symbol.replace('.L', '.AS'));
            }
            if (symbol.endsWith('.AS')) {
                alternatives.push(symbol.replace('.AS', '.L'));
            }
            if (symbol.endsWith('.DE')) {
                alternatives.push(symbol.replace('.DE', '.AS'));
            }
            if (symbol.includes('.')) {
                alternatives.push(symbol.split('.')[0]);
            }
            return alternatives;
        }
        
        // ===========================================
        // FIX EXISTING DATA
        // ===========================================
        
        function fixGroupIds() {
            console.log('ğŸ”§ Starting to fix groupIds...');
            console.log('ğŸ“Š Holdings before fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            let fixedCount = 0;
            
            portfolio.holdings.forEach(holding => {
                const originalGroupId = holding.groupId;
                
                // If groupId is missing, undefined, null, or NaN
                if (!holding.groupId || isNaN(parseInt(holding.groupId))) {
                    console.log(`âš ï¸ ${holding.symbol}: Invalid groupId (${holding.groupId}), setting to 1`);
                    holding.groupId = 1;
                    fixedCount++;
                } else {
                    // Parse to ensure it's a number
                    const parsed = parseInt(holding.groupId);
                    if (parsed !== holding.groupId) {
                        console.log(`ğŸ”§ ${holding.symbol}: Converting groupId from ${holding.groupId} (${typeof holding.groupId}) to ${parsed}`);
                        holding.groupId = parsed;
                        fixedCount++;
                    }
                }
            });
            
            console.log('ğŸ“Š Holdings after fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            // Save the fixed data
            saveData();
            
            // Update displays
            updateOverview();
            renderHoldingsList();
            renderGroupsList();
            
            if (fixedCount > 0) {
                notify(`âœ… ×ª×•×§× ×• ${fixedCount} ×× ×™×•×ª. ×¨×¢× ×Ÿ ××ª ×”×“×£ ×× ×¢×“×™×™×Ÿ ×™×© ×‘×¢×™×•×ª.`);
            } else {
                notify(`â„¹ï¸ ×›×œ ×”×× ×™×•×ª ×›×‘×¨ ×ª×§×™× ×•×ª`);
            }
            
            console.log(`âœ… Fixed ${fixedCount} holdings`);
        }
        
        // ===========================================
        // REFRESH PRICES
        // ===========================================
        
        async function refreshPrices() {
            const notif = document.getElementById('notification');
            notif.textContent = 'ğŸ”„ ××¨×¢× ×Ÿ ××—×™×¨×™×... 0/' + portfolio.holdings.length;
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            let successCount = 0;
            let errorCount = 0;
            let skippedCount = 0;
            const errors = [];
            const manualUpdateNeeded = [];
            
            for (let i = 0; i < portfolio.holdings.length; i++) {
                const holding = portfolio.holdings[i];
                
                // ğŸ”’ Skip manually updated prices!
                if (holding.isManualPrice) {
                    console.log(`ğŸ”’ Skipping ${holding.symbol} - manual price protected`);
                    skippedCount++;
                    continue;
                }
                
                // Update progress
                notif.textContent = `ğŸ”„ ××¨×¢× ×Ÿ ××—×™×¨×™×... ${i + 1}/${portfolio.holdings.length} (${holding.symbol})`;
                
                try {
                    let price = null;
                    
                    // Strategy: Try Israeli TASE first if applicable, then altTicker, then main symbol
                    if (isIsraeliSecurity(holding.symbol)) {
                        // Try TASE for Israeli securities
                        try {
                            price = await fetchStockPrice(holding.symbol);
                            console.log(`âœ… ${holding.symbol}: â‚ª${price} (from TASE)`);
                        } catch (e) {
                            console.log(`âš ï¸ TASE failed for ${holding.symbol}: ${e.message}`);
                            // If TASE fails and there's an alternative ticker, try it
                            if (holding.altTicker) {
                                try {
                                    price = await fetchStockPrice(holding.altTicker);
                                    console.log(`âœ… ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${holding.altTicker})`);
                                } catch (e2) {
                                    console.log(`âš ï¸ Alt ticker also failed for ${holding.symbol}`);
                                    manualUpdateNeeded.push(holding.symbol);
                                    throw new Error('×¢×“×›×Ÿ ×™×“× ×™×ª');
                                }
                            } else {
                                manualUpdateNeeded.push(holding.symbol);
                                throw e; // Re-throw if no alternative
                            }
                        }
                    } else {
                        // For non-Israeli securities, use altTicker if available, otherwise main symbol
                        const tickerToUse = holding.altTicker || holding.symbol;
                        price = await fetchStockPrice(tickerToUse);
                        console.log(`âœ… ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${tickerToUse})`);
                    }
                    
                    holding.currentPrice = price;
                    holding.lastUpdate = new Date().toISOString();
                    // Clear manual flag if automatic update succeeds
                    delete holding.isManualPrice;
                    successCount++;
                } catch (error) {
                    console.error(`âŒ Failed: ${holding.symbol}${holding.altTicker ? ` (alt: ${holding.altTicker})` : ''}`, error);
                    errorCount++;
                    errors.push(holding.symbol);
                }
                
                // ×”××ª× ×” ×§×¦×¨×” ×‘×™×Ÿ ×‘×§×©×•×ª
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            saveData();
            updateOverview();
            renderHoldingsList();
            
            // Hide loading notification
            notif.classList.remove('show');
            
            // Show final result
            let msg = '';
            if (skippedCount > 0) {
                msg = `ğŸ”’ ${skippedCount} ×× ×™×•×ª ×“×•×œ×’×• (××—×™×¨ ×™×“× ×™ ××•×’×Ÿ)\n`;
            }
            
            if (errorCount === 0) {
                notify(`âœ… ${successCount} ××—×™×¨×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!\n${msg}`);
            } else if (successCount === 0 && skippedCount === 0) {
                notify(`âŒ ×›×œ ×”× ×™×¡×™×•× ×•×ª × ×›×©×œ×•. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜`, 'error');
            } else {
                msg += `âš ï¸ ${successCount} ×”×¦×œ×™×—×•, ${errorCount} × ×›×©×œ×•`;
                if (manualUpdateNeeded.length > 0) {
                    msg += `\n\nğŸ‡®ğŸ‡± × ×™×™×¨×•×ª ×™×©×¨××œ×™×™× ×©×“×•×¨×©×™× ×¢×“×›×•×Ÿ ×™×“× ×™:\n${manualUpdateNeeded.join(', ')}\n\n×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "ğŸ’° ××—×™×¨" ×œ×™×“ ×”×× ×™×” ×œ×¢×“×›×Ÿ ×™×“× ×™×ª`;
                }
                notify(msg, 'warning');
            }
        }

        // ===========================================
        // INVESTMENT CALCULATOR
        // ===========================================
        
        function calculateInvestment() {
            const amount = parseFloat(document.getElementById('invest-amount').value);
            
            if (!amount || amount <= 0) {
                notify('âŒ ×”×–×Ÿ ×¡×›×•× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // ×—×™×©×•×‘ ×¡×˜×˜×•×¡ × ×•×›×—×™
            const totalValue = getTotalValueILS();
            const groupsStatus = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const currentPercent = (groupValue / totalValue) * 100;
                const gap = group.target - currentPercent;
                
                return {
                    group,
                    currentPercent,
                    gap,
                    value: groupValue
                };
            });
            
            // ××™×•×Ÿ ×œ×¤×™ ×¤×¢×¨ (×”×›×™ ×—×¡×¨ ×§×•×“×)
            groupsStatus.sort((a, b) => b.gap - a.gap);
            
            // ×—×œ×•×§×” ×¤×¨×•×¤×•×¨×¦×™×•× ×œ×™×ª ×œ×¤×™ ×¤×¢×¨×™×
            const totalGap = groupsStatus.reduce((sum, g) => sum + Math.max(0, g.gap), 0);
            
            const allocations = groupsStatus.map(status => {
                const proportion = totalGap > 0 ? Math.max(0, status.gap) / totalGap : 1 / groupsStatus.length;
                const allocatedAmount = amount * proportion;
                
                // ×—×œ×•×§×” ×©×•×•×” ×‘×ª×•×š ×”×§×‘×•×¦×”
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === status.group.id);
                const perHolding = groupHoldings.length > 0 ? allocatedAmount / groupHoldings.length : 0;
                
                return {
                    group: status.group.name,
                    amount: allocatedAmount,
                    holdings: groupHoldings.map(h => ({
                        symbol: h.symbol,
                        amount: perHolding
                    }))
                };
            });
            
            // ×”×¦×’×ª ×ª×•×¦××•×ª
            displayCalculatorResults(allocations, amount);
        }
        
        function displayCalculatorResults(allocations, totalAmount) {
            const container = document.getElementById('calc-items');
            const resultsDiv = document.getElementById('calc-results');
            
            let html = '';
            let displayedTotal = 0;
            
            allocations.forEach(alloc => {
                if (alloc.amount > 0) {
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">${alloc.group} - â‚ª${Math.round(alloc.amount).toLocaleString()}</div>`;
                    
                    alloc.holdings.forEach(holding => {
                        if (holding.amount > 0) {
                            html += `<div class="calc-item">`;
                            html += `<span class="calc-symbol">${holding.symbol}</span>`;
                            html += `<span class="calc-amount">â‚ª${Math.round(holding.amount).toLocaleString()}</span>`;
                            html += `</div>`;
                            displayedTotal += holding.amount;
                        }
                    });
                    
                    html += `</div>`;
                }
            });
            
            container.innerHTML = html;
            document.getElementById('calc-total').textContent = `â‚ª${Math.round(displayedTotal).toLocaleString()}`;
            resultsDiv.classList.add('show');
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        
        function notify(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = 'notification show';
            
            // Remove all type classes first
            notif.classList.remove('error', 'warning');
            
            if (type === 'error') notif.classList.add('error');
            if (type === 'warning') notif.classList.add('warning');
            
            // Don't auto-hide for loading messages
            if (type === 'loading') {
                notif.style.background = '#3b82f6';
                return; // Stay visible
            }
            
            setTimeout(() => notif.classList.remove('show'), 3000);
        }
        
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Find and activate the clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find the button by tab name
                const buttons = document.querySelectorAll('.tab-btn');
                buttons.forEach((btn, index) => {
                    if (btn.textContent.includes('×¡×§×™×¨×”') && tabName === 'overview') btn.classList.add('active');
                    if (btn.textContent.includes('××—×©×‘×•×Ÿ') && tabName === 'calculator') btn.classList.add('active');
                    if (btn.textContent.includes('×× ×™×•×ª') && tabName === 'holdings') btn.classList.add('active');
                    if (btn.textContent.includes('××’"×—') && tabName === 'bonds') btn.classList.add('active');
                    if (btn.textContent.includes('×§×‘×•×¦×•×ª') && tabName === 'groups') btn.classList.add('active');
                    if (btn.textContent.includes('×”×™×¡×˜×•×¨×™×”') && tabName === 'history') btn.classList.add('active');
                    if (btn.textContent.includes('×”×•×Ÿ') && tabName === 'capital') btn.classList.add('active');
                    if (btn.textContent.includes('×”××œ×¦×•×ª') && tabName === 'recommendations') btn.classList.add('active');
                    if (btn.textContent.includes('×”×’×“×¨×•×ª') && tabName === 'settings') btn.classList.add('active');
                });
            }
            
            const tabElement = document.getElementById(`tab-${tabName}`);
            if (tabElement) {
                tabElement.classList.add('active');
            } else {
                console.error('Tab not found:', tabName);
            }
            
            if (tabName === 'overview') updateOverview();
            if (tabName === 'holdings') renderHoldingsList();
            if (tabName === 'bonds') renderBondsList();
            if (tabName === 'groups') renderGroupsList();
            if (tabName === 'history') renderAllTransactions();
            if (tabName === 'capital') { 
                renderCapitalMovements(); 
                renderBondsCapitalMovements(); 
                updateCapitalSummary(); 
            }
            if (tabName === 'recommendations') renderRecommendations();
            if (tabName === 'charts') {
                // Refresh charts when switching to charts tab
                setTimeout(() => {
                    if (typeof createAdvancedCharts === 'function') {
                        createAdvancedCharts();
                    }
                }, 100);
            }
        }

        // Toggle Dark Mode
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            // Update moon/sun icon
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            }
            
            // Recreate charts with new theme
            if (typeof createAdvancedCharts === 'function') {
                setTimeout(() => createAdvancedCharts(), 100);
            }
        }

        function calculateInvestment() {
            const amount = parseFloat(document.getElementById('invest-amount').value);
            
            if (!amount || amount <= 0) {
                notify('âŒ ×”×–×Ÿ ×¡×›×•× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // ×—×™×©×•×‘ ×¡×˜×˜×•×¡ × ×•×›×—×™
            const totalValue = getTotalValueILS();
            const groupsStatus = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const currentPercent = (groupValue / totalValue) * 100;
                const gap = group.target - currentPercent;
                
                return {
                    group,
                    currentPercent,
                    gap,
                    value: groupValue
                };
            });
            
            // ××™×•×Ÿ ×œ×¤×™ ×¤×¢×¨ (×”×›×™ ×—×¡×¨ ×§×•×“×)
            groupsStatus.sort((a, b) => b.gap - a.gap);
            
            // ×—×œ×•×§×” ×¤×¨×•×¤×•×¨×¦×™×•× ×œ×™×ª ×œ×¤×™ ×¤×¢×¨×™×
            const totalGap = groupsStatus.reduce((sum, g) => sum + Math.max(0, g.gap), 0);
            
            const allocations = groupsStatus.map(status => {
                const proportion = totalGap > 0 ? Math.max(0, status.gap) / totalGap : 1 / groupsStatus.length;
                const allocatedAmount = amount * proportion;
                
                // ×—×œ×•×§×” ×©×•×•×” ×‘×ª×•×š ×”×§×‘×•×¦×”
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === status.group.id);
                const perHolding = groupHoldings.length > 0 ? allocatedAmount / groupHoldings.length : 0;
                
                return {
                    group: status.group.name,
                    amount: allocatedAmount,
                    holdings: groupHoldings.map(h => ({
                        symbol: h.symbol,
                        amount: perHolding
                    }))
                };
            });
            
            // ×”×¦×’×ª ×ª×•×¦××•×ª
            displayCalculatorResults(allocations, amount);
        }



        
        function convertToILS(amount, currency) {
            if (currency === 'ILS') return amount;
            if (currency === 'USD') return amount * portfolio.rates.USD;
            if (currency === 'EUR') return amount * portfolio.rates.EUR;
            return amount;
        }
        
        function getTotalValueILS() {
            return portfolio.holdings.reduce((sum, h) => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                return sum + convertToILS(value, h.currency);
            }, 0);
        }
        
        function getCurrencySymbol(currency) {
            const symbols = { ILS: 'â‚ª', USD: '$', EUR: 'â‚¬' };
            return symbols[currency] || currency;
        }

        // ===========================================
        // TWR (TIME-WEIGHTED RETURN) HELPERS
        // ===========================================
        
        function getBondsValue() {
            return Array.isArray(portfolio.bonds) ? 
                portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0) : 0;
        }
        
        // ===========================================
        // DATA MANAGEMENT - FIREBASE
        // ===========================================
        
        async function saveData() {
            // LOCAL VERSION - Save only to localStorage
            try {
                const defaultGroups = [
                    { id: 1, name: '××“×“×™× ×¢×•×œ××™×™×', target: 60, color: '#3b82f6' },
                    { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                    { id: 3, name: '××§×˜×™×‘×™/×¡×™×›×•× ×™', target: 10, color: '#ef4444' }
                ];
                
                // Validate all holdings have valid groupId
                if (Array.isArray(portfolio.holdings)) {
                    portfolio.holdings = portfolio.holdings.map(h => {
                        const groupId = parseInt(h.groupId);
                        if (isNaN(groupId) || groupId <= 0) {
                            console.warn(`âš ï¸ Invalid groupId for ${h.symbol}, setting to 1`);
                            return { ...h, groupId: 1 };
                        }
                        return h;
                    });
                }
                
                const dataToSave = {
                    holdings: portfolio.holdings,
                    groups: defaultGroups,
                    rates: portfolio.rates,
                    bonds: portfolio.bonds,
                    deposits: portfolio.deposits || [],
                    withdrawals: portfolio.withdrawals || [],
                    purchases: portfolio.purchases || [],
                    sales: portfolio.sales || [],
                    snapshots: portfolio.snapshots || [],
                    cash: portfolio.cash || { ILS: 0, USD: 0 },
                    lastModified: new Date().toISOString()
                };
                
                localStorage.setItem('portfolio', JSON.stringify(dataToSave));
                console.log('âœ… Data saved to localStorage');
            } catch (error) {
                console.error('âŒ Error saving data:', error);
                notify('âš ï¸ ×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™×', 'error');
            }
        }
        
        async function loadData() {
            // LOCAL VERSION - Load only from localStorage
            return loadFromLocalStorage();
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('portfolio');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    
                    const defaultGroups = [
                        { id: 1, name: '××“×“×™× ×¢×•×œ××™×™×', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: '××§×˜×™×‘×™/×¡×™×›×•× ×™', target: 10, color: '#ef4444' }
                    ];
                    
                    portfolio = {
                        holdings: Array.isArray(loaded.holdings) ? loaded.holdings.map(h => {
                            const groupId = parseInt(h.groupId);
                            const validGroupId = isNaN(groupId) ? 1 : groupId;
                            return {
                                ...h,
                                groupId: validGroupId
                            };
                        }) : [],
                        groups: defaultGroups,
                        rates: loaded.rates && typeof loaded.rates === 'object' ? loaded.rates : portfolio.rates,
                        bonds: Array.isArray(loaded.bonds) ? loaded.bonds : 
                               (typeof loaded.bonds === 'number' && loaded.bonds > 0) ? 
                               [{
                                   id: Date.now(),
                                   name: '×§×¨×Ÿ ××’"×— (×× ×ª×•× ×™× ×™×©× ×™×)',
                                   units: 1,
                                   costBasis: loaded.bonds,
                                   currentPrice: loaded.bonds,
                                   lastUpdate: new Date().toISOString()
                               }] : portfolio.bonds || [],
                        // New structure
                        deposits: Array.isArray(loaded.deposits) ? loaded.deposits : [],
                        withdrawals: Array.isArray(loaded.withdrawals) ? loaded.withdrawals : [],
                        purchases: Array.isArray(loaded.purchases) ? loaded.purchases : [],
                        sales: Array.isArray(loaded.sales) ? loaded.sales : [],
                        snapshots: Array.isArray(loaded.snapshots) ? loaded.snapshots : [],
                        cash: loaded.cash && typeof loaded.cash === 'object' ? loaded.cash : { ILS: 0, USD: 0 },
                        // Old structure (for migration)
                        capitalMovements: Array.isArray(loaded.capitalMovements) ? loaded.capitalMovements : [],
                        bondsCapitalMovements: Array.isArray(loaded.bondsCapitalMovements) ? loaded.bondsCapitalMovements : [],
                        bondsSales: Array.isArray(loaded.bondsSales) ? loaded.bondsSales : [],
                        portfolioSnapshots: Array.isArray(loaded.portfolioSnapshots) ? loaded.portfolioSnapshots : []
                    };
                    
                    // Run migration
                    migrateOldData();
                    
                    console.log('âœ… Data loaded from localStorage');
                    console.log('ğŸ“Š Holdings loaded:', portfolio.holdings.length);
                    return true;
                } else {
                    console.log('â„¹ï¸ No saved data, using defaults');
                    if (!Array.isArray(portfolio.holdings)) {
                        portfolio.holdings = [];
                    }
                    return false;
                }
            } catch (error) {
                console.error('âŒ Error loading data:', error);
                notify('âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×', 'error');
                portfolio.holdings = [];
                return false;
            }
        }

        // ===========================================
        // HOLDINGS MANAGEMENT - FIXED
        // ===========================================
        
        function showAddHoldingForm() {
            editingHoldingId = null; // Reset editing mode
            document.getElementById('add-holding-form').style.display = 'block';
            updateGroupSelect();
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = '×”×•×¡×£ ×”×—×–×§×” ×—×“×©×”';
        }
        
        function hideAddHoldingForm() {
            document.getElementById('add-holding-form').style.display = 'none';
            editingHoldingId = null;
            
            // Clear form
            document.getElementById('new-symbol').value = '';
            document.getElementById('new-shares').value = '';
            document.getElementById('new-cost').value = '';
            document.getElementById('new-alt-ticker').value = '';
            document.getElementById('new-purchase-date').value = '';  // â† × ×™×§×•×™ ×ª××¨×™×š
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = '×”×•×¡×£ ×”×—×–×§×” ×—×“×©×”';
        }
        
        function updateGroupSelect() {
            const select = document.getElementById('new-group');
            if (!select) {
                console.error('âŒ Group select element not found');
                return;
            }
            select.innerHTML = portfolio.groups.map(g => 
                `<option value="${g.id}">${g.name}</option>`
            ).join('');
        }
        
        function addHolding() {
            console.log('ğŸ” Starting addHolding function...');
            console.log('ğŸ“ Step 1: Getting form elements');
            
            const symbolInput = document.getElementById('new-symbol');
            const sharesInput = document.getElementById('new-shares');
            const costInput = document.getElementById('new-cost');
            const currencySelect = document.getElementById('new-currency');
            const groupSelect = document.getElementById('new-group');
            
            // ×‘×“×™×§×” ×©×›×œ ×”××œ×× ×˜×™× ×§×™×™××™×
            console.log('ğŸ“ Step 2: Checking if elements exist', {
                symbolInput: !!symbolInput,
                sharesInput: !!sharesInput,
                costInput: !!costInput,
                currencySelect: !!currencySelect,
                groupSelect: !!groupSelect
            });
            
            if (!symbolInput || !sharesInput || !costInput || !currencySelect || !groupSelect) {
                console.error('âŒ One or more form elements not found');
                notify('âŒ ×©×’×™××” ×‘×˜×•×¤×¡ - ××œ×× ×˜ ×œ× × ××¦×', 'error');
                return;
            }
            
            console.log('ğŸ“ Step 3: Reading form values');
            const symbol = symbolInput.value.trim().toUpperCase();
            const sharesStr = sharesInput.value.trim();
            const costStr = costInput.value.trim();
            const currency = currencySelect.value;
            const groupId = parseInt(groupSelect.value);
            const altTicker = document.getElementById('new-alt-ticker')?.value.trim().toUpperCase() || '';
            
            // ×§×¨×™××ª ×ª××¨×™×š ×§× ×™×™×” (×× ×¨×™×§ - ×ª××¨×™×š ×”×™×•×)
            const purchaseDateInput = document.getElementById('new-purchase-date');
            let purchaseDate = purchaseDateInput?.value || new Date().toISOString().split('T')[0];
            
            // ×”××¨×” ×œ-ISO format ××œ×
            purchaseDate = new Date(purchaseDate + 'T12:00:00.000Z').toISOString();
            
            console.log('ğŸ“‹ Form values:', { 
                symbol, 
                shares: sharesStr, 
                cost: costStr, 
                currency, 
                groupId,
                altTicker,
                purchaseDate,
                raw: {
                    symbolRaw: symbolInput.value,
                    sharesRaw: sharesInput.value,
                    costRaw: costInput.value
                }
            });
            
            // ×‘×“×™×§×ª ×ª×§×™× ×•×ª - ×©×“×•×ª ×¨×™×§×™×
            console.log('ğŸ“ Step 4: Validating empty fields');
            if (!symbol || !sharesStr || !costStr) {
                console.error('âŒ Empty fields detected:', { symbol, sharesStr, costStr });
                notify('âŒ ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'error');
                return;
            }
            
            // ×”××¨×” ×œ××¡×¤×¨×™×
            console.log('ğŸ“ Step 5: Converting to numbers');
            const shares = parseFloat(sharesStr);
            const cost = parseFloat(costStr);
            
            console.log('ğŸ”¢ Parsed numbers:', { shares, cost, isNaN_shares: isNaN(shares), isNaN_cost: isNaN(cost) });
            
            // ×‘×“×™×§×” ×©×”××¨×” ×”×¦×œ×™×—×”
            if (isNaN(shares) || isNaN(cost)) {
                console.error('âŒ NaN detected after parsing');
                notify('âŒ ×”×›××•×ª ×•×”××—×™×¨ ×—×™×™×‘×™× ×œ×”×™×•×ª ××¡×¤×¨×™×', 'error');
                return;
            }
            
            // ×‘×“×™×§×” ×©×”×¢×¨×›×™× ×—×™×•×‘×™×™×
            console.log('ğŸ“ Step 6: Validating positive numbers');
            if (shares <= 0 || cost <= 0) {
                console.error('âŒ Non-positive numbers:', { shares, cost });
                notify('âŒ ×”×›××•×ª ×•×”××—×™×¨ ×—×™×™×‘×™× ×œ×”×™×•×ª ×’×“×•×œ×™× ×××¤×¡', 'error');
                return;
            }
            
            // ×‘×“×™×§×” ×× ×× ×—× ×• ×‘××¦×‘ ×¢×¨×™×›×” ××• ×”×•×¡×¤×”
            if (editingHoldingId !== null) {
                // ××¦×‘ ×¢×¨×™×›×” - ×¢×“×›×Ÿ ×”×—×–×§×” ×§×™×™××ª
                console.log('ğŸ“ Step 7: Updating existing holding:', editingHoldingId);
                const holding = portfolio.holdings.find(h => h.id === editingHoldingId);
                if (holding) {
                    holding.symbol = symbol;
                    holding.shares = shares;
                    holding.costBasis = cost;
                    holding.currency = currency;
                    holding.groupId = groupId;
                    holding.altTicker = altTicker;
                    holding.purchaseDate = purchaseDate;  // â† ×ª××¨×™×š ×§× ×™×™×”!
                    holding.lastUpdate = new Date().toISOString();
                    console.log('âœ… Holding updated:', holding);
                }
            } else {
                // ××¦×‘ ×”×•×¡×¤×” - ×¦×•×¨ ×”×—×–×§×” ×—×“×©×”
                console.log('ğŸ“ Step 7: Creating new holding object');
                
                // ×—×™×©×•×‘ ×¡×›×•× ×”×§× ×™×™×”
                const purchaseAmountInCurrency = shares * cost;  // ×‘××˜×‘×¢ ×”××§×•×¨×™
                const purchaseAmount = convertToILS(purchaseAmountInCurrency, currency);  // ×‘×©×§×œ×™×
                const availableCash = getImplicitCash('stocks');
                
                // ×©××œ×”: ×××™×¤×” ×”×›×¡×£?
                let fundingSource = 'cash'; // default
                
                if (availableCash < purchaseAmount) {
                    // ××™×Ÿ ××¡×¤×™×§ ××–×•××Ÿ - ×—×™×™×‘×™× ×”×¤×§×“×”
                    const needDeposit = purchaseAmount - availableCash;
                    if (!confirm(`××™×Ÿ ××¡×¤×™×§ ××–×•××Ÿ ×‘×ª×™×§ (×–××™×Ÿ: â‚ª${Math.round(availableCash).toLocaleString()}).\n×”×× ×œ×”×¤×§×™×“ â‚ª${Math.round(needDeposit).toLocaleString()} × ×•×¡×¤×™×?`)) {
                        notify('âŒ ×‘×•×˜×œ - ××™×Ÿ ××¡×¤×™×§ ××–×•××Ÿ', 'error');
                        return;
                    }
                    fundingSource = 'deposit';
                } else if (availableCash > 0) {
                    // ×™×© ××–×•××Ÿ - ×©×•××œ×™×
                    fundingSource = confirm(`×œ×××Ÿ ××”××–×•××Ÿ ×”×§×™×™× ×‘×ª×™×§ (â‚ª${Math.round(availableCash).toLocaleString()})?\n\n×œ×—×¥ ××™×©×•×¨ ×œ××–×•××Ÿ ×§×™×™×, ×‘×™×˜×•×œ ×œ×”×¤×§×“×” ×—×“×©×”.`) ? 'cash' : 'deposit';
                } else {
                    // ××™×Ÿ ××–×•××Ÿ ×‘×›×œ×œ - ×”×¤×§×“×”
                    fundingSource = 'deposit';
                }
                
                // ×©××™×¨×ª ×©×•×•×™ ×”×ª×™×§ ×œ×¤×™ ××—×™×¨ ×§× ×™×™×” (costBasis) ×œ×¤× ×™ ×”×•×¡×¤×ª ×”×× ×™×” ×”×—×“×©×”
                const valueBeforeNewHolding = getTotalPortfolioValueAtCost();
                
                const newHolding = {
                    id: Date.now(),
                    symbol,
                    shares,
                    costBasis: cost,
                    currentPrice: cost,
                    currency,
                    groupId,
                    altTicker: altTicker || '',
                    purchaseDate: purchaseDate,  // â† ×ª××¨×™×š ×§× ×™×™×”!
                    lastUpdate: new Date().toISOString()
                };
                
                console.log('â• Adding holding:', newHolding);
                portfolio.holdings.push(newHolding);
                
                // ×¢×“×›×Ÿ portfolio.cash - ×”×¤×—×ª ××ª ×¡×›×•× ×”×§× ×™×™×” ×‘××˜×‘×¢ ×”××§×•×¨×™
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                portfolio.cash[currency] = (portfolio.cash[currency] || 0) - purchaseAmountInCurrency;
                console.log(`ğŸ’° ×§× ×™×™×”: ×”×•×¤×—×ª ${purchaseAmountInCurrency.toFixed(2)} ${currency} ××™×ª×¨×ª ×”××–×•××Ÿ`);
                console.log(`   ×™×ª×¨×ª ${currency} ×—×“×©×”: ${portfolio.cash[currency].toFixed(2)}`);
                console.log(`   (×¡×›×•× ×‘×©×§×œ×™×: â‚ª${purchaseAmount.toFixed(2)})`);
                
                // ×¨×™×©×•× ×”×§× ×™×™×”
                const purchase = {
                    id: Date.now(),
                    date: purchaseDate,  // â† ×ª××¨×™×š ×§× ×™×™×” ×××™×ª×™!
                    amount: purchaseAmount,
                    assetType: 'stocks',
                    assetId: newHolding.id,
                    symbol: symbol,
                    note: `×§× ×™×™×”: ${shares} Ã— ${currency}${cost}`
                };
                portfolio.purchases.push(purchase);
                
                // ×× ×¦×¨×™×š ×”×¤×§×“×” - ×™×¦×™×¨×ª ×”×¤×§×“×” ×•-snapshot
                if (fundingSource === 'deposit') {
                    const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                    const deposit = {
                        id: Date.now() + 1,
                        date: purchaseDate,  // â† ×ª××¨×™×š ×§× ×™×™×” ×××™×ª×™!
                        amount: depositAmount,
                        assetType: 'stocks',
                        note: `×”×¤×§×“×” ×œ×§× ×™×™×”: ${symbol}`
                    };
                    portfolio.deposits.push(deposit);
                    
                    // ×™×¦×™×¨×ª snapshot ×¢× ×©×•×•×™ ×œ×¤× ×™ ×”×§× ×™×™×”
                    const snapshot = {
                        id: Date.now() + 2,
                        date: purchaseDate,  // â† ×ª××¨×™×š ×§× ×™×™×” ×××™×ª×™!
                        value_before_flow: valueBeforeNewHolding,
                        cash_flow: depositAmount,
                        stocksValue: getTotalValueILS(),
                        bondsValue: portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0),
                        implicitCash: getImplicitCash('all'),
                        totalValue: getTotalPortfolioValue(),
                        triggerType: 'deposit',
                        triggerNote: `×”×¤×§×“×” ×œ×§× ×™×™×”: ${symbol}`
                    };
                    portfolio.snapshots.push(snapshot);
                    console.log('ğŸ“¸ Snapshot created with value_before_flow:', valueBeforeNewHolding);
                }
                
                console.log('ğŸ“Š Purchase recorded:', purchase);
                console.log('ğŸ“Š Funding source:', fundingSource);
            }
            
            console.log('ğŸ“ Step 8: Saving data');
            
            // ×©××™×¨×”
            saveData();
            
            console.log('ğŸ“ Step 9: Closing form and clearing inputs');
            
            // ×¡×’×™×¨×ª ×”×˜×•×¤×¡ ×•× ×™×§×•×™
            hideAddHoldingForm();
            symbolInput.value = '';
            sharesInput.value = '';
            costInput.value = '';
            
            console.log('ğŸ“ Step 10: Updating UI');
            
            // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
            renderHoldingsList();
            updateOverview();
            
            const actionText = editingHoldingId ? '×¢×•×“×›×Ÿ' : '× ×•×¡×£';
            notify(`âœ… ${symbol} ${actionText} ×‘×”×¦×œ×—×”!`);
            console.log('âœ… Holding saved successfully. Total holdings:', portfolio.holdings.length);
            console.log('âœ… addHolding function completed successfully');
        }
        
        function deleteHolding(id) {
            if (!confirm('×”×× ×œ××—×•×§ ×”×—×–×§×” ×–×•?\n\n×–×” ×™×‘×˜×œ ××ª ×”×§× ×™×™×” ×•×™×—×–×™×¨ ××ª ×”×›×¡×£.')) return;
            
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) {
                notify('âŒ ×”×—×–×§×” ×œ× × ××¦××”', 'error');
                return;
            }
            
            // ××¦× ××ª ×”×¢×¡×§×” ×”××§×•×¨×™×ª
            const purchase = portfolio.purchases.find(p => p.assetId === id);
            
            // ×”×—×–×¨ ××ª ×”×›×¡×£ ×œ-portfolio.cash
            if (purchase) {
                const purchaseAmountInCurrency = holding.shares * holding.costBasis;
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                portfolio.cash[holding.currency] = (portfolio.cash[holding.currency] || 0) + purchaseAmountInCurrency;
                console.log(`ğŸ’° ×”×—×–×¨ ${purchaseAmountInCurrency.toFixed(2)} ${holding.currency} ×œ××–×•××Ÿ`);
                
                // ××—×§ ××ª ×”×¢×¡×§×”
                portfolio.purchases = portfolio.purchases.filter(p => p.assetId !== id);
                console.log('ğŸ—‘ï¸ ×¢×¡×§×ª ×”×§× ×™×™×” × ××—×§×”');
            }
            
            // ××—×§ ××ª ×”×¤×•×–×™×¦×™×”
            portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
            
            saveData();
            renderHoldingsList();
            renderCashFlow();
            renderTransactions();
            updateOverview();
            notify('âœ… ×”×—×–×§×” ×•×”×¢×¡×§×” × ××—×§×•, ×”×›×¡×£ ×”×•×—×–×¨');
        }
        
        function editHolding(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            // Set editing mode
            editingHoldingId = id;
            
            // Fill form with holding data
            document.getElementById('new-symbol').value = holding.symbol;
            document.getElementById('new-shares').value = holding.shares;
            document.getElementById('new-cost').value = holding.costBasis;
            document.getElementById('new-currency').value = holding.currency;
            document.getElementById('new-group').value = holding.groupId;
            document.getElementById('new-alt-ticker').value = holding.altTicker || '';
            
            // Change form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = `×¢×¨×•×š ×”×—×–×§×”: ${holding.symbol}`;
            
            // Show form
            document.getElementById('add-holding-form').style.display = 'block';
            
            // Scroll to form
            document.getElementById('add-holding-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function updatePriceManually(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            const newPrice = prompt(`×¢×“×›×Ÿ ××—×™×¨ ×¢×‘×•×¨ ${holding.symbol}\n\n××—×™×¨ × ×•×›×—×™: ${getCurrencySymbol(holding.currency)}${holding.currentPrice}\n\n×”×–×Ÿ ××—×™×¨ ×—×“×©:`, holding.currentPrice);
            
            if (newPrice === null) return; // User cancelled
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            holding.currentPrice = price;
            holding.isManualPrice = true; // ğŸ”’ Mark as manual - will not be overridden!
            holding.lastUpdate = new Date().toISOString();
            saveData();
            renderHoldingsList();
             // âš¡ Update TWR Live!
            updateOverview();
            notify(`âœ… ××—×™×¨ ${holding.symbol} ×¢×•×“×›×Ÿ ×™×“× ×™×ª ×œ-${getCurrencySymbol(holding.currency)}${price} (××•×’×Ÿ ××¨×™×¢× ×•×Ÿ)`);
        }
        
        function unlockPrice(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            if (!confirm(`ğŸ”“ ×‘×˜×œ ×”×’× ×” ×¢×œ ${holding.symbol}?\n\n×”××—×™×¨ ×™×ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª ×‘×¨×™×¢× ×•×Ÿ ×”×‘×.`)) {
                return;
            }
            
            delete holding.isManualPrice;
            saveData();
            renderHoldingsList();
            notify(`ğŸ”“ ×”×’× ×” ×‘×•×˜×œ×” ×¢×‘×•×¨ ${holding.symbol}. ×”××—×™×¨ ×™×ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª ×‘×¨×™×¢× ×•×Ÿ ×”×‘×.`);
        }
        
        // ===========================================
        // BONDS MANAGEMENT
        // ===========================================
        let editingBondId = null;
        
        window.showAddBondForm = function() {
            document.getElementById('add-bond-form').style.display = 'block';
            document.getElementById('add-bond-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        window.hideAddBondForm = function() {
            const form = document.getElementById('add-bond-form');
            if (form) form.style.display = 'none';
            // Clear form with proper field names
            const symbol = document.getElementById('bond-symbol');
            const altTicker = document.getElementById('bond-alt-ticker');
            const units = document.getElementById('bond-units');
            const cost = document.getElementById('bond-cost');
            const date = document.getElementById('bond-purchase-date');
            
            if (symbol) symbol.value = '';
            if (altTicker) altTicker.value = '';
            if (units) units.value = '';
            if (cost) cost.value = '';
            if (date) date.value = new Date().toISOString().split('T')[0];
        }
        
        function saveBond() {
            console.log('=== START saveBond ===');
            console.log('Cash before:', JSON.stringify(portfolio.cash));
            const symbol = document.getElementById('bond-symbol').value.trim();
            const altTicker = document.getElementById('bond-alt-ticker').value.trim();
            const units = parseFloat(document.getElementById('bond-units').value);
            const costBasis = parseFloat(document.getElementById('bond-cost').value);
            const purchaseDate = document.getElementById('bond-purchase-date').value;
            const currency = document.getElementById('bond-currency').value;
            
            if (!symbol || !units || !costBasis || !purchaseDate) {
                notify('âŒ ×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”', 'error');
                return;
            }
            
            // ×‘×“×™×§×ª ××–×•××Ÿ ×–××™×Ÿ
            const totalCost = units * costBasis;
            const availableCash = portfolio.cash[currency] || 0;
            
            if (availableCash < totalCost) {
                const shortage = totalCost - availableCash;
                const currSymbol = getCurrencySymbol(currency);
                const depositNow = confirm(
                    `âŒ ××™×Ÿ ××¡×¤×™×§ ××–×•××Ÿ ×‘${currency}

` +
                    `×“×¨×•×©: ${currSymbol}${totalCost.toFixed(2)}
` +
                    `×–××™×Ÿ: ${currSymbol}${availableCash.toFixed(2)}
` +
                    `×—×¡×¨: ${currSymbol}${shortage.toFixed(2)}

` +
                    `×”×× ×œ×”×¤×§×™×“ ${currSymbol}${shortage.toFixed(2)} ×¢×›×©×™×•?`
                );
                
                if (depositNow) {
                    // ×”×¤×§×“×” ××•×˜×•××˜×™×ª
                    portfolio.cash[currency] = availableCash + shortage;
                    
                    // ×¨×©×•× ×‘deposits (×œ×”×™×¡×˜×•×¨×™×”)
                    if (!Array.isArray(portfolio.deposits)) {
                        portfolio.deposits = [];
                    }
                    portfolio.deposits.push({
                        id: Date.now(),
                        amount: shortage,
                        date: purchaseDate,
                        currency: currency,
                        note: `×”×¤×§×“×” ××•×˜×•××˜×™×ª ×œ×§× ×™×™×ª ${symbol}`
                    });
                    
                    // ×¨×©×•× ×‘cashFlows (×œ-MWR)
                    if (!Array.isArray(portfolio.cashFlows)) {
                        portfolio.cashFlows = [];
                    }
                    portfolio.cashFlows.push({
                        id: Date.now() + 1,
                        type: 'deposit',
                        amount: shortage,
                        date: purchaseDate,
                        currency: currency,
                        note: `×”×¤×§×“×” ××•×˜×•××˜×™×ª ×œ×§× ×™×™×ª ${symbol}`
                    });
                    
                    notify(`âœ… ×”×•×¤×§×“×• ${currSymbol}${shortage.toFixed(2)}`, 'success');
                } else {
                    notify('âŒ ×”×§× ×™×™×” ×‘×•×˜×œ×” - ××™×Ÿ ××¡×¤×™×§ ××–×•××Ÿ', 'error');
                    return;
                }
            }
            
            const bond = {
                id: Date.now(),
                symbol: symbol,
                altTicker: altTicker,
                units: units,
                costBasis: costBasis,
                currentPrice: costBasis, // ××ª×—×™×œ ×¢× ××—×™×¨ ×§× ×™×™×”
                purchaseDate: purchaseDate,
                currency: currency,
                isManualPrice: false
            };
            
            if (!Array.isArray(portfolio.bonds)) {
                portfolio.bonds = [];
            }
            
            portfolio.bonds.push(bond);
            
            // ×¨×©×•× ×¢×¡×§×ª ×§× ×™×™×”
            if (!Array.isArray(portfolio.transactions)) {
                portfolio.transactions = [];
            }
            
            portfolio.transactions.push({
                id: Date.now() + 1,
                type: 'buy',
                assetType: 'bond',
                symbol: symbol,
                shares: units,
                price: costBasis,
                date: purchaseDate,
                currency: currency
            });
            
            // ×”×¤×—×ª ×××–×•××Ÿ - ×•×•×“× ×©×–×” ×§×•×¨×”!
            const currentCash = portfolio.cash[currency] || 0;
            const newCash = currentCash - totalCost;
            portfolio.cash[currency] = newCash;
            console.log(`ğŸ’° Cash after purchase: ${currency} = ${newCash} (was ${currentCash}, spent ${totalCost})`);
            
            console.log('Cash after all operations:', JSON.stringify(portfolio.cash));
            console.log('Transactions:', portfolio.transactions.length);
            console.log('=== END saveBond ===');
            saveData();
            renderBondsList();
            hideAddBondForm();
            updateOverview();
            renderCashFlow();
            notify('âœ… ×§×¨×Ÿ ××’"×— × ×•×¡×¤×” ×‘×”×¦×œ×—×”', 'success');
        }

        async function refreshBondPrices() {
            if (!Array.isArray(portfolio.bonds) || portfolio.bonds.length === 0) {
                notify('××™×Ÿ ×§×¨× ×•×ª ××’"×— ×œ×¨×¢× ×•×Ÿ', 'info');
                return;
            }
            
            notify('ğŸ”„ ××¨×¢× ×Ÿ ××—×™×¨×™ ××’"×—...', 'info');
            
            let updated = 0;
            let failed = 0;
            let skipped = 0;
            const total = portfolio.bonds.length;
            
            for (let i = 0; i < portfolio.bonds.length; i++) {
                const bond = portfolio.bonds[i];
                
                if (bond.isManualPrice) {
                    console.log(`ğŸ”’ Skipping ${bond.symbol} - manual price`);
                    skipped++;
                    continue;
                }
                
                try {
                    let price = null;
                    
                    // Try Israeli TASE first if applicable
                    if (isIsraeliSecurity(bond.symbol)) {
                        try {
                            price = await fetchStockPrice(bond.symbol);
                            console.log(`âœ… ${bond.symbol}: â‚ª${price} (from TASE)`);
                        } catch (e) {
                            // Try alternative ticker
                            if (bond.altTicker) {
                                price = await fetchStockPrice(bond.altTicker);
                                console.log(`âœ… ${bond.symbol}: ${price} (from ${bond.altTicker})`);
                            } else {
                                throw e;
                            }
                        }
                    } else {
                        const ticker = bond.altTicker || bond.symbol;
                        price = await fetchStockPrice(ticker);
                        console.log(`âœ… ${bond.symbol}: ${price} (from ${ticker})`);
                    }
                    
                    if (price && price > 0) {
                        bond.currentPrice = price;
                        bond.lastUpdate = new Date().toISOString();
                        delete bond.isManualPrice;
                        updated++;
                    }
                } catch (error) {
                    console.error(`âŒ Failed: ${bond.symbol}`, error);
                    failed++;
                }
                
                // ×”××ª× ×” ×§×¦×¨×” ×‘×™×Ÿ ×‘×§×©×•×ª
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            saveData();
            renderBondsList();
            updateOverview();
            
            let msg = '';
            if (skipped > 0) msg += `ğŸ”’ ${skipped} ×“×•×œ×’×• (××—×™×¨ ××•×’×Ÿ)
`;
            if (failed === 0) {
                notify(`âœ… ${updated} ××—×™×¨×™ ××’"×— ×¢×•×“×›× ×•!
${msg}`, 'success');
            } else {
                notify(`âš ï¸ ${updated} ×”×¦×œ×™×—×•, ${failed} × ×›×©×œ×•
${msg}`, 'warning');
            }
        }

        
        function editBond(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            editingBondId = id;
            document.getElementById('bond-name').value = bond.name;
            document.getElementById('bond-units').value = bond.units;
            document.getElementById('bond-cost').value = bond.costBasis;
            document.getElementById('bond-price').value = bond.currentPrice;
            
            document.getElementById('add-bond-form').style.display = 'block';
            document.getElementById('add-bond-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        window.deleteBond = function(bondId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×§×¨×Ÿ ××’"×— ×–×•?')) return;
            
            if (!Array.isArray(portfolio.bonds)) {
                notify('âŒ ××™×Ÿ ×§×¨× ×•×ª ××’"×—', 'error');
                return;
            }
            
            const bondIndex = portfolio.bonds.findIndex(b => b.id === bondId);
            if (bondIndex === -1) {
                notify('âŒ ×§×¨×Ÿ ××’"×— ×œ× × ××¦××”', 'error');
                return;
            }
            
            const bond = portfolio.bonds[bondIndex];
            
            // ×”×•×¡×£ ×‘×—×–×¨×” ×œ××–×•××Ÿ (×”×—×–×¨ ××ª ×”×§× ×™×™×” ×”××§×•×¨×™×ª)
            const totalCost = bond.units * bond.costBasis;
            const currency = bond.currency || 'ILS';
            portfolio.cash[currency] = (portfolio.cash[currency] || 0) + totalCost;
            
            console.log(`ğŸ’° Refunded ${totalCost} ${currency} after deleting bond`);
            
            // ××—×§ ×¢×¡×§××•×ª ×§×©×•×¨×•×ª
            if (Array.isArray(portfolio.transactions)) {
                portfolio.transactions = portfolio.transactions.filter(t => 
                    !(t.assetType === 'bond' && t.symbol === bond.symbol)
                );
            }
            
            // ××—×§ ××ª ×”××’"×—
            portfolio.bonds.splice(bondIndex, 1);
            
            console.log('Cash after deletion:', JSON.stringify(portfolio.cash));
            console.log('Transactions left:', portfolio.transactions ? portfolio.transactions.length : 0);
            
            saveData();
            renderBondsList();
            updateOverview();
            renderCashFlow();
            notify('âœ… ×§×¨×Ÿ ××’"×— × ××—×§×” ×•×”×›×¡×£ ×”×•×—×–×¨', 'success');
        }

        window.updateBondPriceManually = function(bondId) {
            if (!Array.isArray(portfolio.bonds)) {
                notify('âŒ ××™×Ÿ ×§×¨× ×•×ª ××’"×—', 'error');
                return;
            }
            
            const bond = portfolio.bonds.find(b => b.id === bondId);
            if (!bond) {
                notify('âŒ ×§×¨×Ÿ ××’"×— ×œ× × ××¦××”', 'error');
                return;
            }
            
            const newPrice = prompt(`×¢×“×›×Ÿ ××—×™×¨ ×¢×‘×•×¨ ${bond.symbol}:`, bond.currentPrice);
            if (newPrice === null) return;
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            bond.currentPrice = price;
            bond.isManualPrice = true;
            bond.lastUpdate = new Date().toISOString();
            
            console.log(`ğŸ’° Manual price update: ${bond.symbol} = ${price}`);
            
            saveData();
            renderBondsList();
            updateOverview();
            notify(`âœ… ××—×™×¨ ×¢×•×“×›×Ÿ ×œ-${getCurrencySymbol(bond.currency)}${price.toFixed(2)}`, 'success');
        }
        
        window.unlockBondPrice = function(bondId) {
            const bond = portfolio.bonds.find(b => b.id === bondId);
            if (!bond) return;
            
            bond.isManualPrice = false;
            
            console.log('Cash after all operations:', JSON.stringify(portfolio.cash));
            console.log('Transactions:', portfolio.transactions.length);
            console.log('=== END saveBond ===');
            saveData();
            renderBondsList();
            notify('ğŸ”“ ×”×’× ×ª ××—×™×¨ ×‘×•×˜×œ×” - ×¨×™×¢× ×•×Ÿ ××•×˜×•××˜×™ ××•×¤×¢×œ', 'success');
        }
        


        

        function addBondUnits(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            const units = prompt(`×”×•×¡×£ ×™×—×™×“×•×ª ×œ-${bond.name}\n\n×™×—×™×“×•×ª × ×•×›×—×™×•×ª: ${bond.units}\n\n×›××” ×™×—×™×“×•×ª ×œ×”×•×¡×™×£?`);
            if (units === null) return;
            
            const unitsNum = parseFloat(units);
            if (isNaN(unitsNum) || unitsNum <= 0) {
                notify('âŒ ×›××•×ª ×œ× ×ª×§×™× ×”', 'error');
                return;
            }
            
            const price = prompt(`×‘××—×™×¨ ×©×œ ×›××” ×§× ×™×ª ${unitsNum} ×™×—×™×“×•×ª?\n\n(××—×™×¨ ×œ×™×—×™×“×”)`);
            if (price === null) return;
            
            const priceNum = parseFloat(price);
            if (isNaN(priceNum) || priceNum <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // ×—×™×©×•×‘ ×¡×›×•× ×”×§× ×™×™×”
            const purchaseAmount = unitsNum * priceNum;
            const availableCash = getImplicitCash('bonds');
            
            // ×©××œ×”: ×××™×¤×” ×”×›×¡×£?
            let fundingSource = 'cash';
            
            if (availableCash < purchaseAmount) {
                const needDeposit = purchaseAmount - availableCash;
                if (!confirm(`××™×Ÿ ××¡×¤×™×§ ××–×•××Ÿ ×‘×—×œ×§ ××’"×— (×–××™×Ÿ: â‚ª${Math.round(availableCash).toLocaleString()}).\n×”×× ×œ×”×¤×§×™×“ â‚ª${Math.round(needDeposit).toLocaleString()} × ×•×¡×¤×™×?`)) {
                    notify('âŒ ×‘×•×˜×œ - ××™×Ÿ ××¡×¤×™×§ ××–×•××Ÿ', 'error');
                    return;
                }
                fundingSource = 'deposit';
            } else if (availableCash > 0) {
                fundingSource = confirm(`×œ×××Ÿ ××”××–×•××Ÿ ×”×§×™×™× ×‘×—×œ×§ ××’"×— (â‚ª${Math.round(availableCash).toLocaleString()})?\n\n×œ×—×¥ ××™×©×•×¨ ×œ××–×•××Ÿ ×§×™×™×, ×‘×™×˜×•×œ ×œ×”×¤×§×“×” ×—×“×©×”.`) ? 'cash' : 'deposit';
            } else {
                fundingSource = 'deposit';
            }
            
            // Calculate new average cost
            const oldCost = bond.units * bond.costBasis;
            const newCost = purchaseAmount;
            const totalUnits = bond.units + unitsNum;
            const newAvgCost = (oldCost + newCost) / totalUnits;
            
            // ×©××™×¨×ª ×©×•×•×™ ×”×ª×™×§ ×œ×¤×™ ××—×™×¨ ×§× ×™×™×” (costBasis) ×œ×¤× ×™ ×¢×“×›×•×Ÿ ×”××’"×—
            const valueBeforeUpdate = getTotalPortfolioValueAtCost();
            
            bond.units = totalUnits;
            bond.costBasis = newAvgCost;
            bond.lastUpdate = new Date().toISOString();
            
            // ×¨×™×©×•× ×”×§× ×™×™×”
            const purchase = {
                id: Date.now(),
                date: new Date().toISOString(),
                amount: purchaseAmount,
                assetType: 'bonds',
                assetId: bond.id,
                note: `×§× ×™×™×”: ${unitsNum} ×™×—×™×“×•×ª ${bond.name}`
            };
            portfolio.purchases.push(purchase);
            
            // ×× ×¦×¨×™×š ×”×¤×§×“×”
            if (fundingSource === 'deposit') {
                const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                const deposit = {
                    id: Date.now() + 1,
                    date: new Date().toISOString(),
                    amount: depositAmount,
                    assetType: 'bonds',
                    note: `×”×¤×§×“×” ×œ×§× ×™×™×”: ${bond.name}`
                };
                portfolio.deposits.push(deposit);
                
                // ×™×¦×™×¨×ª snapshot ×¢× ×©×•×•×™ ×œ×¤× ×™ ×”×§× ×™×™×”
                const snapshot = {
                    id: Date.now() + 2,
                    date: new Date().toISOString(),
                    value_before_flow: valueBeforeUpdate,
                    cash_flow: depositAmount,
                    stocksValue: getTotalValueILS(),
                    bondsValue: portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0),
                    implicitCash: getImplicitCash('all'),
                    totalValue: getTotalPortfolioValue(),
                    triggerType: 'deposit',
                    triggerNote: `×”×¤×§×“×” ×œ×§× ×™×™×”: ${bond.name}`
                };
                portfolio.snapshots.push(snapshot);
                console.log('ğŸ“¸ Bond snapshot created with value_before_flow:', valueBeforeUpdate);
            }
            
            console.log('Cash after all operations:', JSON.stringify(portfolio.cash));
            console.log('Transactions:', portfolio.transactions.length);
            console.log('=== END saveBond ===');
            saveData();
            renderBondsList();
            renderCashFlow();
            
            updateOverview();
            notify(`âœ… × ×•×¡×¤×• ${unitsNum} ×™×—×™×“×•×ª ×œ-${bond.name}\n××—×™×¨ ×××•×¦×¢ ×—×“×©: â‚ª${newAvgCost.toFixed(2)}`);
        }
        
        // ===========================================
        // NEW: SELL BOND UNITS
        // ===========================================
        function sellBondUnits(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            const units = prompt(`××›×•×¨ ×™×—×™×“×•×ª ×-${bond.name}\n\n×™×—×™×“×•×ª ×–××™× ×•×ª: ${bond.units}\n\n×›××” ×™×—×™×“×•×ª ×œ××›×•×¨?`);
            if (units === null) return;
            
            const unitsNum = parseFloat(units);
            if (isNaN(unitsNum) || unitsNum <= 0) {
                notify('âŒ ×›××•×ª ×œ× ×ª×§×™× ×”', 'error');
                return;
            }
            
            if (unitsNum > bond.units) {
                notify('âŒ ××™×Ÿ ××¡×¤×™×§ ×™×—×™×“×•×ª ×œ××›×™×¨×”', 'error');
                return;
            }
            
            const price = prompt(`×‘××—×™×¨ ×©×œ ×›××” ××›×¨×ª ${unitsNum} ×™×—×™×“×•×ª?\n\n(××—×™×¨ ×œ×™×—×™×“×”)`, bond.currentPrice);
            if (price === null) return;
            
            const priceNum = parseFloat(price);
            if (isNaN(priceNum) || priceNum <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // Calculate amounts
            const saleAmount = unitsNum * priceNum;
            const profit = (priceNum - bond.costBasis) * unitsNum;
            
            // ×©××œ×”: ××” ×œ×¢×©×•×ª ×¢× ×”×ª××•×¨×”?
            const keepInPortfolio = confirm(`×ª××•×¨×ª ×”××›×™×¨×”: â‚ª${saleAmount.toLocaleString()}\n\n×”×× ×œ×”×©××™×¨ ×‘×ª×™×§ ×›××–×•××Ÿ?\n\n×œ×—×¥ ××™×©×•×¨ ×œ×”×©××™×¨ ×‘×ª×™×§, ×‘×™×˜×•×œ ×œ××©×•×š ××™×™×“.`);
            
            // ×¨×™×©×•× ×”××›×™×¨×”
            const sale = {
                id: Date.now(),
                date: new Date().toISOString(),
                amount: saleAmount,
                profit: profit,
                assetType: 'bonds',
                assetId: bond.id,
                fundName: bond.name,
                units: unitsNum,
                salePrice: priceNum,
                costBasis: bond.costBasis
            };
            portfolio.sales.push(sale);
            
            // ×× ×‘×—×¨ ×œ××©×•×š
            if (!keepInPortfolio) {
                const withdrawal = {
                    id: Date.now() + 1,
                    date: new Date().toISOString(),
                    amount: saleAmount,
                    assetType: 'bonds',
                    note: `××©×™×›×” ×××›×™×¨×ª ${unitsNum} ×™×—×™×“×•×ª ${bond.name}`
                };
                portfolio.withdrawals.push(withdrawal);
                createSnapshot('withdrawal', `××©×™×›×” ×××›×™×¨×ª ${bond.name}`, -saleAmount);
            }
            
            // Update bond units
            bond.units -= unitsNum;
            
            // ×¢×“×›×Ÿ portfolio.cash - ×”×•×¡×£ ××ª ×ª××•×¨×ª ×”××›×™×¨×” (×× × ×©××¨ ×‘×ª×™×§)
            if (keepInPortfolio) {
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                portfolio.cash.ILS = (portfolio.cash.ILS || 0) + saleAmount;
                console.log(`ğŸ’° ××›×™×¨×ª ××’"×—: × ×•×¡×£ ${saleAmount.toFixed(2)} â‚ª ×œ×™×ª×¨×ª ×”××–×•××Ÿ`);
            }
            bond.lastUpdate = new Date().toISOString();
            
            // If all units sold, optionally delete
            if (bond.units === 0) {
                if (confirm(`××›×¨×ª ××ª ×›×œ ×”×™×—×™×“×•×ª ×©×œ ${bond.name}. ×”×× ×œ××—×•×§ ××ª ×”×§×¨×Ÿ ××”×¨×©×™××”?`)) {
                    portfolio.bonds = portfolio.bonds.filter(b => b.id !== id);
                }
            }
            
            console.log('Cash after all operations:', JSON.stringify(portfolio.cash));
            console.log('Transactions:', portfolio.transactions.length);
            console.log('=== END saveBond ===');
            saveData();
            renderBondsList();
            renderCashFlow();
            
            
            updateOverview();
            
            const profitText = profit >= 0 ? `+â‚ª${profit.toFixed(2)}` : `â‚ª${profit.toFixed(2)}`;
            const actionText = keepInPortfolio ? '× ×©××¨ ×‘×ª×™×§' : '× ××©×š';
            notify(`âœ… × ××›×¨×• ${unitsNum} ×™×—×™×“×•×ª ×-${bond.name}\n×¨×•×•×—: ${profitText}\n${actionText}`);
        }
        
        // ===========================================
        // NEW: BONDS CAPITAL MOVEMENTS
        // ===========================================
        function addBondsCapitalMovement() {
            const amount = prompt('×”×–×Ÿ ×¡×›×•×:\n\n(×—×™×•×‘×™ = ×”×¤×§×“×”, ×©×œ×™×œ×™ = ××©×™×›×”)');
            if (amount === null) return;
            
            const amountNum = parseFloat(amount);
            if (isNaN(amountNum) || amountNum === 0) {
                notify('âŒ ×¡×›×•× ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            const note = prompt('×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™):', '') || '';
            
            // ğŸ“¸ Create snapshot BEFORE adding the capital movement
            const typeText = amountNum > 0 ? '×”×¤×§×“×”' : '××©×™×›×”';
            createPortfolioSnapshot(amountNum > 0 ? 'bonds-deposit' : 'bonds-withdrawal', `××’"×—: ${typeText} â‚ª${Math.abs(amountNum).toLocaleString()}`);
            
            if (!portfolio.bondsCapitalMovements) portfolio.bondsCapitalMovements = [];
            portfolio.bondsCapitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: amountNum,
                type: amountNum > 0 ? 'deposit' : 'withdrawal',
                note: note
            });
            
            saveData();
            renderBondsCapitalMovements();
            updateCapitalSummary();
            
            notify(`âœ… ${typeText} ×©×œ â‚ª${Math.abs(amountNum).toLocaleString()} × ×¨×©××” ×œ××’"×—`);
        }
        
        function deleteBondsCapitalMovement(id) {
            if (!confirm('×”×× ×œ××—×•×§ ×ª× ×•×¢×” ×–×•?')) return;
            
            portfolio.bondsCapitalMovements = portfolio.bondsCapitalMovements.filter(m => m.id !== id);
            saveData();
            renderBondsCapitalMovements();
            updateCapitalSummary();
            notify('âœ… ×ª× ×•×¢×” × ××—×§×”');
        }
        
        function renderBondsCapitalMovements() {
            const container = document.getElementById('bonds-capital-movements-list');
            if (!container) return;
            
            if (!portfolio.bondsCapitalMovements || portfolio.bondsCapitalMovements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #92400e;">××™×Ÿ ×ª× ×•×¢×•×ª ×”×•×Ÿ ×œ××’"×—</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #fde68a;"><th style="padding: 8px;">×ª××¨×™×š</th><th>×¡×›×•×</th><th>×¡×•×’</th><th>×”×¢×¨×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>';
            html += '<tbody>';
            
            const sorted = [...portfolio.bondsCapitalMovements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(m => {
                const date = new Date(m.date).toLocaleDateString('he-IL');
                const amount = m.amount >= 0 ? `+â‚ª${m.amount.toLocaleString()}` : `-â‚ª${Math.abs(m.amount).toLocaleString()}`;
                const color = m.amount >= 0 ? 'green' : 'red';
                const typeText = m.type === 'deposit' ? 'ğŸ’° ×”×¤×§×“×”' : 'ğŸ’¸ ××©×™×›×”';
                
                html += `<tr style="border-bottom: 1px solid #fde68a;">
                    <td style="padding: 8px;">${date}</td>
                    <td style="color: ${color}; font-weight: bold;">${amount}</td>
                    <td>${typeText}</td>
                    <td style="color: #92400e;">${m.note || '-'}</td>
                    <td><button onclick="deleteBondsCapitalMovement(${m.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            const totalBondsCapital = portfolio.bondsCapitalMovements.reduce((sum, m) => sum + m.amount, 0);
            html += `<div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 8px; text-align: center; border: 2px solid #f59e0b;">
                <strong style="color: #92400e;">×¡×”"×› ×”×•×Ÿ ××§×•×¨×™ ××’"×—: â‚ª${totalBondsCapital.toLocaleString()}</strong>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function renderBondsList() {
            const container = document.getElementById('bonds-list');
            if (!container) return;
            
            if (!Array.isArray(portfolio.bonds) || portfolio.bonds.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">××™×Ÿ ×§×¨× ×•×ª ××’"×— ×¢×“×™×™×Ÿ</p>
                        <p>×œ×—×¥ ×¢×œ "×”×•×¡×£ ×§×¨×Ÿ ××’"×—" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                `;
                return;
            }
            
            // ×˜×‘×œ×” ×¨×•×—×‘×™×ª
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden;">';
            html += `<thead style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                <tr>
                    <th style="padding: 15px; text-align: right; font-weight: 700;">×¡×™××•×œ / × .×¢.</th>
                    <th style="padding: 15px; text-align: center;">×™×—×™×“×•×ª</th>
                    <th style="padding: 15px; text-align: center;">××—×™×¨ ×§× ×™×™×”</th>
                    <th style="padding: 15px; text-align: center;">××—×™×¨ × ×•×›×—×™</th>
                    <th style="padding: 15px; text-align: center;">×©×•×•×™</th>
                    <th style="padding: 15px; text-align: center;">×¨×•×•×—/×”×¤×¡×“</th>
                    <th style="padding: 15px; text-align: center;">×ª××¨×™×š ×§× ×™×™×”</th>
                    <th style="padding: 15px; text-align: center;">×¤×¢×•×œ×•×ª</th>
                </tr>
            </thead><tbody>`;
            
            portfolio.bonds.forEach(bond => {
                const currentValue = bond.units * bond.currentPrice;
                const costValue = bond.units * bond.costBasis;
                const profit = currentValue - costValue;
                const profitPercent = (profit / costValue) * 100;
                const profitColor = profit >= 0 ? '#10b981' : '#ef4444';
                const currSymbol = getCurrencySymbol(bond.currency);
                
                html += `<tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 15px; font-weight: 700; color: #1f2937;">
                        ${bond.symbol}
                        ${bond.altTicker ? `<br><span style="font-size: 0.75rem; color: #f59e0b;">â†’ ${bond.altTicker}</span>` : ''}
                        ${bond.isManualPrice ? '<span style="font-size: 0.75rem; color: #f59e0b; margin-right: 5px;" title="××—×™×¨ ×™×“× ×™">ğŸ”’</span>' : ''}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600;">
                        ${bond.units}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        ${currSymbol}${bond.costBasis.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600;">
                        ${currSymbol}${bond.currentPrice.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: #1f2937;">
                        ${currSymbol}${currentValue.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: ${profitColor};">
                        ${profit >= 0 ? '+' : ''}${currSymbol}${profit.toFixed(2)}
                        <br>
                        <span style="font-size: 0.85rem;">(${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%)</span>
                    </td>
                    <td style="padding: 15px; text-align: center; color: #6b7280; font-size: 0.9rem;">
                        ${new Date(bond.purchaseDate).toLocaleDateString('he-IL')}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="updateBondPriceManually(${bond.id})" class="btn btn-sm" title="×¢×“×›×Ÿ ××—×™×¨" style="background: #8b5cf6; color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ${bond.isManualPrice ? 'ğŸ”’' : 'ğŸ’°'}
                            </button>
                            ${bond.isManualPrice ? `
                            <button onclick="unlockBondPrice(${bond.id})" class="btn btn-sm" title="×‘×˜×œ ×”×’× ×”" style="background: #f59e0b; color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ğŸ”“
                            </button>
                            ` : ''}
                            <button onclick="console.log('Deleting bond:', ${bond.id}); deleteBond(${bond.id}); return false;" class="btn btn-sm" title="××—×§" style="background: #ef4444; color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // ===========================================
        // NEW: ADD SHARES TO EXISTING POSITION
        // ===========================================
        function showAddSharesForm(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            const shares = prompt(`×”×•×¡×£ ×× ×™×•×ª ×œ-${holding.symbol}\n\n×”×—×–×§×” × ×•×›×—×™×ª: ${holding.shares} ×× ×™×•×ª\n××—×™×¨ ×××•×¦×¢ × ×•×›×—×™: ${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}\n\n×›××” ×× ×™×•×ª ×œ×”×•×¡×™×£?`);
            if (!shares) return;
            
            const sharesToAdd = parseFloat(shares);
            if (isNaN(sharesToAdd) || sharesToAdd <= 0) {
                notify('âŒ ×›××•×ª ×œ× ×ª×§×™× ×”', 'error');
                return;
            }
            
            const price = prompt(`××—×™×¨ ×§× ×™×” ×œ×× ×™×”?`, holding.currentPrice);
            if (!price) return;
            
            const purchasePrice = parseFloat(price);
            if (isNaN(purchasePrice) || purchasePrice <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // Calculate new average cost
            const oldTotal = holding.shares * holding.costBasis;
            const newTotal = sharesToAdd * purchasePrice;
            const newShares = holding.shares + sharesToAdd;
            const newAvgCost = (oldTotal + newTotal) / newShares;
            
            // Save purchase to history
            if (!holding.purchases) holding.purchases = [];
            holding.purchases.push({
                date: new Date().toISOString(),
                shares: sharesToAdd,
                price: purchasePrice,
                total: newTotal
            });
            
            // Update holding
            holding.shares = newShares;
            holding.costBasis = newAvgCost;
            holding.lastUpdate = new Date().toISOString();
            
            saveData();
            renderHoldingsList();
            updateOverview();
            notify(`âœ… × ×•×¡×¤×• ${sharesToAdd} ×× ×™×•×ª ×©×œ ${holding.symbol}\n××—×™×¨ ×××•×¦×¢ ×—×“×©: ${getCurrencySymbol(holding.currency)}${newAvgCost.toFixed(2)}`);
        }
        
        // ===========================================
        // NEW: SELL PARTIAL POSITION
        // ===========================================
        function showSellSharesForm(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            const shares = prompt(`××›×•×¨ ×× ×™×•×ª ×-${holding.symbol}\n\n×”×—×–×§×” × ×•×›×—×™×ª: ${holding.shares} ×× ×™×•×ª\n××—×™×¨ ×§× ×™×™×” ×××•×¦×¢: ${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}\n××—×™×¨ × ×•×›×—×™: ${getCurrencySymbol(holding.currency)}${holding.currentPrice.toFixed(2)}\n\n×›××” ×× ×™×•×ª ×œ××›×•×¨?`);
            if (!shares) return;
            
            const sharesToSell = parseFloat(shares);
            if (isNaN(sharesToSell) || sharesToSell <= 0) {
                notify('âŒ ×›××•×ª ×œ× ×ª×§×™× ×”', 'error');
                return;
            }
            
            if (sharesToSell > holding.shares) {
                notify('âŒ ××™×Ÿ ××¡×¤×™×§ ×× ×™×•×ª ×œ××›×™×¨×”', 'error');
                return;
            }
            
            const price = prompt(`××—×™×¨ ××›×™×¨×” ×œ×× ×™×”?`, holding.currentPrice);
            if (!price) return;
            
            const salePrice = parseFloat(price);
            if (isNaN(salePrice) || salePrice <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // Calculate amounts
            const saleAmountForeign = sharesToSell * salePrice;
            const saleAmountILS = convertToILS(saleAmountForeign, holding.currency);
            const profit = (salePrice - holding.costBasis) * sharesToSell;
            const profitILS = convertToILS(profit, holding.currency);
            
            // ×©××œ×”: ××” ×œ×¢×©×•×ª ×¢× ×”×ª××•×¨×”?
            const keepInPortfolio = confirm(`×ª××•×¨×ª ×”××›×™×¨×”: ${getCurrencySymbol(holding.currency)}${saleAmountForeign.toFixed(2)} (â‚ª${Math.round(saleAmountILS).toLocaleString()})\n\n×”×× ×œ×”×©××™×¨ ×‘×ª×™×§ ×›××–×•××Ÿ?\n\n×œ×—×¥ ××™×©×•×¨ ×œ×”×©××™×¨ ×‘×ª×™×§, ×‘×™×˜×•×œ ×œ××©×•×š ××™×™×“.`);
            
            // ×¨×™×©×•× ×”××›×™×¨×”
            const sale = {
                id: Date.now(),
                date: new Date().toISOString(),
                amount: saleAmountILS,
                profit: profitILS,
                assetType: 'stocks',
                assetId: holding.id,
                symbol: holding.symbol,
                shares: sharesToSell,
                salePrice: salePrice,
                costBasis: holding.costBasis,
                currency: holding.currency
            };
            portfolio.sales.push(sale);
            
            // ×× ×‘×—×¨ ×œ××©×•×š - ×™×¦×™×¨×ª ××©×™×›×” ×•-snapshot
            if (!keepInPortfolio) {
                const withdrawal = {
                    id: Date.now() + 1,
                    date: new Date().toISOString(),
                    amount: saleAmountILS,
                    assetType: 'stocks',
                    note: `××©×™×›×” ×××›×™×¨×ª ${sharesToSell} ${holding.symbol}`
                };
                portfolio.withdrawals.push(withdrawal);
                createSnapshot('withdrawal', `××©×™×›×” ×××›×™×¨×ª ${holding.symbol}`, -saleAmountILS);
            }
            
            // ×¢×“×›×Ÿ portfolio.cash - ×”×•×¡×£ ××ª ×ª××•×¨×ª ×”××›×™×¨×” (×× × ×©××¨ ×‘×ª×™×§)
            if (keepInPortfolio) {
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                const saleAmountInCurrency = sharesToSell * salePrice;
                portfolio.cash[holding.currency] = (portfolio.cash[holding.currency] || 0) + saleAmountInCurrency;
                console.log(`ğŸ’° ××›×™×¨×”: × ×•×¡×£ ${saleAmountInCurrency.toFixed(2)} ${holding.currency} ×œ×™×ª×¨×ª ×”××–×•××Ÿ`);
            }
            
            // Update holding
            holding.shares -= sharesToSell;
            holding.lastUpdate = new Date().toISOString();
            
            // If sold all shares, remove holding
            if (holding.shares === 0) {
                portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
            }
            
            saveData();
            renderHoldingsList();
            renderCashFlow();
            
            
            updateOverview();
            
            const profitText = profit >= 0 ? `×¨×•×•×—: +${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}` : `×”×¤×¡×“: ${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}`;
            const actionText = keepInPortfolio ? '× ×©××¨ ×‘×ª×™×§' : '× ××©×š';
            notify(`âœ… × ××›×¨×• ${sharesToSell} ${holding.symbol}\n${profitText}\n${actionText}`);
        }
        
        // ===========================================
        // CASHFLOW UI FUNCTIONS
        // ===========================================
        
        function showDepositModal() {
            document.getElementById('deposit-modal').style.display = 'flex';
            document.getElementById('deposit-amount').value = '';
            document.getElementById('deposit-note').value = '';
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deposit-date').value = today;
        }
        
        function hideDepositModal() {
            document.getElementById('deposit-modal').style.display = 'none';
        }
        
        function submitDeposit() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const dateInput = document.getElementById('deposit-date').value;
            // const assetType = document.getElementById('deposit-asset-type').value; // ×”×•×¡×¨ - ×”×¤×§×“×” ×ª××™×“ ×œ××–×•××Ÿ
            const note = document.getElementById('deposit-note').value || '';
            
            if (isNaN(amount) || amount <= 0) {
                notify('âŒ ×¡×›×•× ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('âŒ ×× × ×‘×—×¨ ×ª××¨×™×š', 'error');
                return;
            }
            
            // Convert date input to ISO string
            const depositDate = new Date(dateInput + 'T12:00:00').toISOString();
            
            // ğŸ“¸ Create snapshot BEFORE adding the deposit (for TWR)
            createSnapshot('deposit', note || '×”×¤×§×“×”', amount, depositDate);
            
            const deposit = {
                id: Date.now(),
                date: depositDate,
                amount: amount,
                note: note
            };
            
            portfolio.deposits.push(deposit);
            
            // ×¢×“×›×Ÿ portfolio.cash (×”×¤×§×“×” = ×ª××™×“ ×œ×©×§×œ×™×)
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS += amount;
            
            // Sort deposits by date (oldest first)
            portfolio.deposits.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            saveData();
            hideDepositModal();
            renderCashFlow();
            
            updateOverview();
            
            notify(`âœ… × ×•×¡×¤×” ×”×¤×§×“×”: â‚ª${amount.toLocaleString()}`);
        }
        
        function showWithdrawalModal() {
            const availableCash = getImplicitCash('all');
            document.getElementById('withdrawal-max').textContent = Math.round(availableCash).toLocaleString();
            document.getElementById('withdrawal-modal').style.display = 'flex';
            document.getElementById('withdrawal-amount').value = '';
            document.getElementById('withdrawal-note').value = '';
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('withdrawal-date').value = today;
        }
        
        function hideWithdrawalModal() {
            document.getElementById('withdrawal-modal').style.display = 'none';
        }
        
        function submitWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const dateInput = document.getElementById('withdrawal-date').value;
            // const assetType = document.getElementById('withdrawal-asset-type').value; // ×”×•×¡×¨
            const note = document.getElementById('withdrawal-note').value || '';
            const availableCash = getImplicitCash('all');
            
            if (isNaN(amount) || amount <= 0) {
                notify('âŒ ×¡×›×•× ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('âŒ ×× × ×‘×—×¨ ×ª××¨×™×š', 'error');
                return;
            }
            
            if (amount > availableCash) {
                notify(`âŒ ××™×Ÿ ××¡×¤×™×§ ××–×•××Ÿ. ×–××™×Ÿ: â‚ª${Math.round(availableCash).toLocaleString()}`, 'error');
                return;
            }
            
            // Convert date input to ISO string
            const withdrawalDate = new Date(dateInput + 'T12:00:00').toISOString();
            
            // ğŸ“¸ Create snapshot BEFORE adding the withdrawal (for TWR)
            createSnapshot('withdrawal', note || '××©×™×›×”', -amount, withdrawalDate);
            
            const withdrawal = {
                id: Date.now(),
                date: withdrawalDate,
                amount: amount,
                // assetType: assetType, // ×”×•×¡×¨
                note: note
            };
            
            portfolio.withdrawals.push(withdrawal);
            
            // ×¢×“×›×Ÿ portfolio.cash (××©×™×›×” = ×ª××™×“ ××©×§×œ×™×)
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS -= amount;
            
            // portfolio.cash ××ª×¢×“×›×Ÿ ×“×¨×š getImplicitCash ××•×˜×•××˜×™×ª
            
            // Sort withdrawals by date (oldest first)
            portfolio.withdrawals.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            saveData();
            hideWithdrawalModal();
            renderCashFlow();
            
            updateOverview();
            
            notify(`âœ… × ×•×¡×¤×” ××©×™×›×”: â‚ª${amount.toLocaleString()}`);
        }
        
        function deleteDeposit(id) {
            if (!confirm('×œ××—×•×§ ×”×¤×§×“×” ×–×•?')) return;
            
            portfolio.deposits = portfolio.deposits.filter(d => d.id !== id);
            // Remove associated snapshot
            const deposit = portfolio.deposits.find(d => d.id === id);
            if (deposit) {
                portfolio.snapshots = portfolio.snapshots.filter(s => 
                    !(s.triggerType === 'deposit' && Math.abs(new Date(s.date) - new Date(deposit.date)) < 1000)
                );
            }
            
            saveData();
            renderCashFlow();
            
            updateOverview();
            notify('âœ… ×”×¤×§×“×” × ××—×§×”');
        }
        
        function deleteWithdrawal(id) {
            if (!confirm('×œ××—×•×§ ××©×™×›×” ×–×•?')) return;
            
            portfolio.withdrawals = portfolio.withdrawals.filter(w => w.id !== id);
            // Remove associated snapshot
            const withdrawal = portfolio.withdrawals.find(w => w.id === id);
            if (withdrawal) {
                portfolio.snapshots = portfolio.snapshots.filter(s => 
                    !(s.triggerType === 'withdrawal' && Math.abs(new Date(s.date) - new Date(withdrawal.date)) < 1000)
                );
            }
            
            saveData();
            renderCashFlow();
            
            updateOverview();
            notify('âœ… ××©×™×›×” × ××—×§×”');
        }
        
                function renderCashFlow() {
            // ============================================
            // ×ª×¦×•×’×ª ×™×ª×¨×•×ª ××–×•××Ÿ (3 ××˜×‘×¢×•×ª)
            // ============================================
            // ×—×©×‘ ×™×ª×¨×•×ª ××–×•××Ÿ:
            // portfolio.cash = ×›×œ ×”×™×ª×¨×•×ª (ILS, USD, EUR)
            // getImplicitCash = ×¨×§ ×œ×‘×“×™×§×” ×©×œ deposits-withdrawals-purchases+sales
            
            // ××ª×—×œ portfolio.cash ×× ×œ× ×§×™×™×
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            const cashBalances = {
                ILS: portfolio.cash.ILS || 0,
                USD: portfolio.cash.USD || 0,
                EUR: portfolio.cash.EUR || 0
            };
            const cashHtml = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        ğŸ’° ×™×ª×¨×•×ª ××–×•××Ÿ
                        <button onclick="showCurrencyExchange()" style="margin-right: auto; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            ğŸ”„ ×”××¨×ª ××˜×‘×¢
                        </button>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">×©×§×œ×™× (â‚ª)</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">â‚ª${Math.round(cashBalances.ILS).toLocaleString()}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">×“×•×œ×¨ ($)</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">$${cashBalances.USD.toFixed(2)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">×™×•×¨×• (â‚¬)</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">â‚¬${cashBalances.EUR.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            const cashContainer = document.getElementById('cash-balances-container');
            if (cashContainer) {
                cashContainer.innerHTML = cashHtml;
            }
            
            // ============================================
            // ×˜×‘×œ×ª ×”×¤×§×“×•×ª
            // ============================================
            const depositsContainer = document.getElementById('deposits-list');
            if (portfolio.deposits.length === 0) {
                depositsContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">××™×Ÿ ×”×¤×§×“×•×ª ×¢×“×™×™×Ÿ</p>';
            } else {
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #d1fae5;"><th style="padding: 8px;">×ª××¨×™×š</th><th>×¡×›×•×</th><th>×¡×•×’</th><th>×”×¢×¨×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody>';
                
                const sorted = [...portfolio.deposits].sort((a, b) => new Date(b.date) - new Date(a.date));
                let totalDep = 0;
                sorted.forEach(d => {
                    const amount = parseFloat(d.amount);
                    if (!d.amount || isNaN(amount) || amount <= 0) return;
                    totalDep += amount;
                    
                    const date = new Date(d.date).toLocaleDateString('he-IL');
                    const typeText = d.assetType === 'bonds' ? '××’\"×—' : '×× ×™×•×ª';
                    html += `<tr style="border-bottom: 1px solid #d1fae5;">
                        <td style="padding: 8px;">${date}</td>
                        <td style="color: #10b981; font-weight: bold;">+â‚ª${Math.round(amount).toLocaleString()}</td>
                        <td>${typeText}</td>
                        <td style="color: #6b7280;">${d.note || '-'}</td>
                        <td><button onclick="deleteDeposit(${d.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">××—×§</button></td>
                    </tr>`;
                });
                html += `<tfoot><tr style="background: #a7f3d0; font-weight: bold; font-size: 1.1rem;">
                    <td style="padding: 12px;">×¡×”\"×› ×”×¤×§×“×•×ª</td>
                    <td style="color: #059669;">+â‚ª${Math.round(totalDep).toLocaleString()}</td>
                    <td colspan="3"></td>
                </tr></tfoot>`;
                html += '</tbody></table>';
                depositsContainer.innerHTML = html;
            }
            
            // ============================================
            // ×˜×‘×œ×ª ××©×™×›×•×ª
            // ============================================
            const withdrawalsContainer = document.getElementById('withdrawals-list');
            if (portfolio.withdrawals.length === 0) {
                withdrawalsContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">××™×Ÿ ××©×™×›×•×ª ×¢×“×™×™×Ÿ</p>';
            } else {
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #fee2e2;"><th style="padding: 8px;">×ª××¨×™×š</th><th>×¡×›×•×</th><th>×¡×•×’</th><th>×”×¢×¨×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody>';
                
                const sorted = [...portfolio.withdrawals].sort((a, b) => new Date(b.date) - new Date(a.date));
                let totalWith = 0;
                sorted.forEach(w => {
                    const amount = parseFloat(w.amount);
                    if (!w.amount || isNaN(amount) || amount <= 0) return;
                    totalWith += amount;
                    
                    const date = new Date(w.date).toLocaleDateString('he-IL');
                    const typeText = w.assetType === 'bonds' ? '××’\"×—' : '×× ×™×•×ª';
                    html += `<tr style="border-bottom: 1px solid #fee2e2;">
                        <td style="padding: 8px;">${date}</td>
                        <td style="color: #ef4444; font-weight: bold;">-â‚ª${Math.round(amount).toLocaleString()}</td>
                        <td>${typeText}</td>
                        <td style="color: #6b7280;">${w.note || '-'}</td>
                        <td><button onclick="deleteWithdrawal(${w.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">××—×§</button></td>
                    </tr>`;
                });
                html += `<tfoot><tr style="background: #fecaca; font-weight: bold; font-size: 1.1rem;">
                    <td style="padding: 12px;">×¡×”\"×› ××©×™×›×•×ª</td>
                    <td style="color: #dc2626;">-â‚ª${Math.round(totalWith).toLocaleString()}</td>
                    <td colspan="3"></td>
                </tr></tfoot>`;
                html += '</tbody></table>';
                withdrawalsContainer.innerHTML = html;
            }
            
            // Summary
            const totalDeposits = portfolio.deposits.reduce((sum, d) => {
                const amount = parseFloat(d.amount);
                return sum + (isNaN(amount) ? 0 : amount);
            }, 0);
            const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => {
                const amount = parseFloat(w.amount);
                return sum + (isNaN(amount) ? 0 : amount);
            }, 0);
            const netCapital = totalDeposits - totalWithdrawals;
            const availableCash = getImplicitCash('all');
            
            // ×¢×“×›×Ÿ ××ª ×”×¡×™×›×•× ×‘×˜××‘ ×ª×–×¨×™× ×›×¡×¤×™
            const el1 = document.getElementById('total-deposits');
            if (el1) el1.textContent = Math.round(totalDeposits).toLocaleString();
            
            const el2 = document.getElementById('total-withdrawals');
            if (el2) el2.textContent = Math.round(totalWithdrawals).toLocaleString();
            
            // ×¢×“×›×Ÿ ×’× ××ª ×”×¡×§×™×¨×” ×”×›×œ×œ×™×ª
            const el1b = document.getElementById('overview-total-deposits');
            if (el1b) el1b.textContent = `â‚ª${Math.round(totalDeposits).toLocaleString()}`;
            
            const el2b = document.getElementById('overview-total-withdrawals');
            if (el2b) el2b.textContent = `â‚ª${Math.round(totalWithdrawals).toLocaleString()}`;
            
            const el3 = document.getElementById('net-capital');
            if (el3) el3.textContent = Math.round(netCapital).toLocaleString();
            
            const el4 = document.getElementById('available-cash');
            if (el4) el4.textContent = Math.round(availableCash).toLocaleString();
        }
        
        let currentTransactionFilter = 'all';
        
        function filterTransactions(type) {
            currentTransactionFilter = type;
            
            // Update button styles
            ['all', 'deposits', 'withdrawals', 'purchases', 'sales'].forEach(t => {
                const btn = document.getElementById(`filter-${t}`);
                if (btn) {
                    btn.className = t === type ? 'btn btn-primary' : 'btn';
                }
            });
            
            renderTransactions();
        }
        
        function renderTransactions() {
            const container = document.getElementById('transactions-list');
            
            // Collect all transactions
            let transactions = [];
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'deposits') {
                portfolio.deposits.forEach(d => {
                    transactions.push({
                        id: d.id,
                        date: d.date,
                        type: 'deposit',
                        amount: d.amount,
                        note: d.note || '-',
                        assetType: d.assetType,
                        icon: 'ğŸ“¥',
                        color: '#10b981'
                    });
                });
            }
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'withdrawals') {
                portfolio.withdrawals.forEach(w => {
                    transactions.push({
                        id: w.id,
                        date: w.date,
                        type: 'withdrawal',
                        amount: -w.amount,
                        note: w.note || '-',
                        assetType: w.assetType,
                        icon: 'ğŸ“¤',
                        color: '#ef4444'
                    });
                });
            }
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'purchases') {
                portfolio.purchases.forEach(p => {
                    transactions.push({
                        id: p.id,
                        date: p.date,
                        type: 'purchase',
                        amount: -p.amount,
                        note: p.note || p.symbol || '-',
                        assetType: p.assetType,
                        icon: 'ğŸ›’',
                        color: '#3b82f6'
                    });
                });
            }
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'sales') {
                portfolio.sales.forEach(s => {
                    transactions.push({
                        id: s.id,
                        date: s.date,
                        type: 'sale',
                        amount: s.amount,
                        profit: s.profit,
                        note: `${s.symbol || s.fundName} (×¨×•×•×—: ${s.profit >= 0 ? '+' : ''}â‚ª${Math.round(s.profit).toLocaleString()})`,
                        assetType: s.assetType,
                        icon: 'ğŸ’¸',
                        color: '#f59e0b'
                    });
                });
            }
            
            // Sort by date (newest first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">××™×Ÿ ×¢×¡×§××•×ª ×œ×”×¦×’×”</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f3f4f6;"><th style="padding: 10px;">×ª××¨×™×š</th><th>×¡×•×’</th><th>× ×›×¡</th><th>×ª×™××•×¨</th><th>×¡×›×•×</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>';
            html += '<tbody>';
            
            transactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString('he-IL');
                const typeText = {
                    'deposit': '×”×¤×§×“×”',
                    'withdrawal': '××©×™×›×”',
                    'purchase': '×§× ×™×™×”',
                    'sale': '××›×™×¨×”'
                }[t.type];
                const assetText = t.assetType === 'bonds' ? '××’"×—' : '×× ×™×•×ª';
                
                html += `<tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 10px;">${date}</td>
                    <td style="color: ${t.color};">${t.icon} ${typeText}</td>
                    <td>${assetText}</td>
                    <td style="color: #6b7280;">${t.note}</td>
                    <td style="font-weight: bold; color: ${t.amount >= 0 ? '#10b981' : '#ef4444'};">
                        ${t.amount >= 0 ? '+' : ''}â‚ª${Math.round(Math.abs(t.amount)).toLocaleString()}
                    </td>
                    <td>
                        <button onclick="deleteTransaction('${t.type}', ${t.id})" 
                                style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                            ××—×§
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function deleteTransaction(type, id) {
            if (!confirm('×”×× ×œ××—×•×§ ×¢×¡×§×” ×–×•?')) return;
            
            let found = false;
            
            switch(type) {
                case 'deposit':
                    const depositIndex = portfolio.deposits.findIndex(d => d.id === id);
                    if (depositIndex !== -1) {
                        const deposit = portfolio.deposits[depositIndex];
                        
                        // ×”×¤×—×ª ××”××–×•××Ÿ
                        if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                        portfolio.cash.ILS = (portfolio.cash.ILS || 0) - deposit.amount;
                        console.log(`ğŸ’° ×”×•×¤×—×ª ${deposit.amount.toFixed(2)} â‚ª ××”××–×•××Ÿ`);
                        
                        portfolio.deposits.splice(depositIndex, 1);
                        
                        // Remove associated snapshot
                        portfolio.snapshots = portfolio.snapshots.filter(s => 
                            !(s.triggerType === 'deposit' && Math.abs(new Date(s.date) - new Date(deposit.date)) < 1000)
                        );
                        found = true;
                    }
                    break;
                    
                case 'withdrawal':
                    const withdrawalIndex = portfolio.withdrawals.findIndex(w => w.id === id);
                    if (withdrawalIndex !== -1) {
                        const withdrawal = portfolio.withdrawals[withdrawalIndex];
                        
                        // ×”×—×–×¨ ×œ××–×•××Ÿ
                        if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                        portfolio.cash.ILS = (portfolio.cash.ILS || 0) + withdrawal.amount;
                        console.log(`ğŸ’° ×”×•×—×–×¨ ${withdrawal.amount.toFixed(2)} â‚ª ×œ××–×•××Ÿ`);
                        
                        portfolio.withdrawals.splice(withdrawalIndex, 1);
                        
                        // Remove associated snapshot
                        portfolio.snapshots = portfolio.snapshots.filter(s => 
                            !(s.triggerType === 'withdrawal' && Math.abs(new Date(s.date) - new Date(withdrawal.date)) < 1000)
                        );
                        found = true;
                    }
                    break;
                    
                case 'purchase':
                    const purchaseIndex = portfolio.purchases.findIndex(p => p.id === id);
                    if (purchaseIndex !== -1) {
                        const purchase = portfolio.purchases[purchaseIndex];
                        
                        // ××¦× ××ª ×”×¤×•×–×™×¦×™×” ×”××ª××™××”
                        const holding = portfolio.holdings.find(h => h.id === purchase.assetId);
                        
                        if (holding) {
                            // ×”×—×–×¨ ××ª ×”×›×¡×£
                            const purchaseAmountInCurrency = holding.shares * holding.costBasis;
                            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                            portfolio.cash[holding.currency] = (portfolio.cash[holding.currency] || 0) + purchaseAmountInCurrency;
                            console.log(`ğŸ’° ×”×—×–×¨ ${purchaseAmountInCurrency.toFixed(2)} ${holding.currency} ×œ××–×•××Ÿ`);
                            
                            // ××—×§ ××ª ×”×¤×•×–×™×¦×™×”
                            portfolio.holdings = portfolio.holdings.filter(h => h.id !== purchase.assetId);
                            console.log('ğŸ—‘ï¸ ×”×¤×•×–×™×¦×™×” × ××—×§×”');
                        }
                        
                        // ××—×§ ××ª ×”×¢×¡×§×”
                        portfolio.purchases.splice(purchaseIndex, 1);
                        found = true;
                    }
                    break;
                    
                case 'sale':
                    const saleIndex = portfolio.sales.findIndex(s => s.id === id);
                    if (saleIndex !== -1) {
                        const sale = portfolio.sales[saleIndex];
                        
                        // ×”×¤×—×ª ××ª ×ª××•×¨×ª ×”××›×™×¨×” ××”××–×•××Ÿ
                        if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                        
                        // ×× ××›×™×¨×” ×”×™×™×ª×” ×‘××˜×‘×¢ ×–×¨
                        if (sale.currency) {
                            const saleAmountInCurrency = sale.shares * sale.salePrice;
                            portfolio.cash[sale.currency] = (portfolio.cash[sale.currency] || 0) - saleAmountInCurrency;
                            console.log(`ğŸ’° ×”×•×¤×—×ª ${saleAmountInCurrency.toFixed(2)} ${sale.currency} ××”××–×•××Ÿ (×‘×™×˜×•×œ ××›×™×¨×”)`);
                        }
                        
                        // ××¦× ×× ×™×© ×¤×•×–×™×¦×™×” ×§×™×™××ª ×‘××•×ª×” ×× ×™×”
                        let holding = portfolio.holdings.find(h => h.symbol === sale.symbol);
                        
                        if (holding) {
                            // ×”×—×–×¨ ×× ×™×•×ª ×œ×¤×•×–×™×¦×™×” ×§×™×™××ª
                            holding.shares += sale.shares;
                            console.log(`ğŸ“ˆ ×”×•×—×–×¨ ${sale.shares} ×× ×™×•×ª ×œ-${sale.symbol}`);
                        } else {
                            // ×¦×•×¨ ×¤×•×–×™×¦×™×” ×—×“×©×”
                            portfolio.holdings.push({
                                id: Date.now(),
                                symbol: sale.symbol,
                                shares: sale.shares,
                                costBasis: sale.costBasis,
                                currentPrice: sale.costBasis,
                                currency: sale.currency || 'USD',
                                groupId: 1,
                                lastUpdate: new Date().toISOString()
                            });
                            console.log(`ğŸ“ˆ × ×•×¦×¨×” ×¤×•×–×™×¦×™×” ×—×“×©×”: ${sale.shares} ${sale.symbol}`);
                        }
                        
                        portfolio.sales.splice(saleIndex, 1);
                        found = true;
                    }
                    break;
            }
            
            if (found) {
                saveData();
                renderTransactions();
                renderCashFlow();
            
                
                updateOverview();
                notify('âœ… ×¢×¡×§×” × ××—×§×”');
            } else {
                notify('âŒ ×¢×¡×§×” ×œ× × ××¦××”', 'error');
            }
        }
        
        // ===========================================
        // ===========================================
        // DATA MIGRATION
        // ===========================================
        
        function migrateOldData() {
            let migrated = false;
            
            // Migrate capitalMovements to deposits/withdrawals
            if (portfolio.capitalMovements && portfolio.capitalMovements.length > 0) {
                console.log('ğŸ”„ Migrating capitalMovements...');
                
                portfolio.capitalMovements.forEach(m => {
                    if (m.amount > 0) {
                        portfolio.deposits.push({
                            id: m.id,
                            date: m.date,
                            amount: m.amount,
                            assetType: 'stocks',
                            note: m.note || '××™×’×¨×¦×™×”'
                        });
                        createSnapshot('deposit', m.note || '××™×’×¨×¦×™×”');
                    } else if (m.amount < 0) {
                        portfolio.withdrawals.push({
                            id: m.id,
                            date: m.date,
                            amount: Math.abs(m.amount),
                            assetType: 'stocks',
                            note: m.note || '××™×’×¨×¦×™×”'
                        });
                        createSnapshot('withdrawal', m.note || '××™×’×¨×¦×™×”');
                    }
                });
                
                delete portfolio.capitalMovements;
                migrated = true;
            }
            
            // Migrate bondsCapitalMovements
            if (portfolio.bondsCapitalMovements && portfolio.bondsCapitalMovements.length > 0) {
                portfolio.bondsCapitalMovements.forEach(m => {
                    if (m.amount > 0) {
                        portfolio.deposits.push({
                            id: m.id || Date.now(),
                            date: m.date,
                            amount: m.amount,
                            assetType: 'bonds',
                            note: m.note || '××™×’×¨×¦×™×”'
                        });
                    } else if (m.amount < 0) {
                        portfolio.withdrawals.push({
                            id: m.id || Date.now(),
                            date: m.date,
                            amount: Math.abs(m.amount),
                            assetType: 'bonds',
                            note: m.note || '××™×’×¨×¦×™×”'
                        });
                    }
                });
                
                delete portfolio.bondsCapitalMovements;
                migrated = true;
            }
            
            // Migrate bondsSales
            if (portfolio.bondsSales && portfolio.bondsSales.length > 0) {
                portfolio.bondsSales.forEach(bs => {
                    portfolio.sales.push({
                        id: bs.id,
                        date: bs.date,
                        amount: bs.units * bs.salePrice,
                        profit: bs.profit,
                        assetType: 'bonds',
                        fundName: bs.fundName,
                        units: bs.units,
                        salePrice: bs.salePrice,
                        costBasis: bs.costBasis
                    });
                });
                
                delete portfolio.bondsSales;
                migrated = true;
            }
            
            // Migrate portfolioSnapshots
            if (portfolio.portfolioSnapshots && portfolio.portfolioSnapshots.length > 0) {
                portfolio.portfolioSnapshots.forEach(ps => {
                    portfolio.snapshots.push({
                        id: ps.id,
                        date: ps.date,
                        stocksValue: ps.stocksValue || 0,
                        bondsValue: ps.bondsValue || 0,
                        implicitCash: 0,
                        totalValue: ps.totalValue,
                        triggerType: ps.triggerType,
                        triggerNote: ps.triggerNote || ''
                    });
                });
                
                delete portfolio.portfolioSnapshots;
                migrated = true;
            }
            
            if (migrated) {
                saveData();
                console.log('âœ… Migration completed');
                notify('ğŸ”„ × ×ª×•× ×™× ×”×•××¨×•');
            }
        }
        
        function addCapitalMovement() {
            const amountStr = prompt('×”×›× ×¡ ×¡×›×•×:\n(×—×™×•×‘×™ ×œ×”×¤×§×“×”, ×©×œ×™×œ×™ ×œ××©×™×›×”)');
            if (!amountStr) return;
            
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount === 0) {
                notify('âŒ ×¡×›×•× ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            const note = prompt('×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™):') || '';
            
            // ğŸ“¸ Create snapshot BEFORE adding the capital movement
            const typeText = amount > 0 ? '×”×¤×§×“×”' : '××©×™×›×”';
            createPortfolioSnapshot(amount > 0 ? 'deposit' : 'withdrawal', `×× ×™×•×ª: ${typeText} â‚ª${Math.abs(amount).toLocaleString()}`);
            
            if (!portfolio.capitalMovements) portfolio.capitalMovements = [];
            portfolio.capitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: amount,
                type: amount > 0 ? 'deposit' : 'withdrawal',
                note: note
            });
            
            saveData();
            renderCapitalMovements();
            updateOverview();
            
            notify(`âœ… ${typeText} ×©×œ â‚ª${Math.abs(amount).toLocaleString()} × ×¨×©××”`);
        }
        
        function deleteCapitalMovement(id) {
            if (!confirm('×”×× ×œ××—×•×§ ×ª× ×•×¢×” ×–×•?')) return;
            
            portfolio.capitalMovements = portfolio.capitalMovements.filter(m => m.id !== id);
            saveData();
            renderCapitalMovements();
            updateOverview();
            notify('âœ… ×ª× ×•×¢×” × ××—×§×”');
        }
        
        function renderCapitalMovements() {
            const container = document.getElementById('capital-movements-list');
            if (!container) return;
            
            if (!portfolio.capitalMovements || portfolio.capitalMovements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">××™×Ÿ ×ª× ×•×¢×•×ª ×”×•×Ÿ</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f0f0f0;"><th style="padding: 8px;">×ª××¨×™×š</th><th>×¡×›×•×</th><th>×¡×•×’</th><th>×”×¢×¨×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>';
            html += '<tbody>';
            
            const sorted = [...portfolio.capitalMovements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(m => {
                const date = new Date(m.date).toLocaleDateString('he-IL');
                const amount = m.amount >= 0 ? `+â‚ª${m.amount.toLocaleString()}` : `-â‚ª${Math.abs(m.amount).toLocaleString()}`;
                const color = m.amount >= 0 ? 'green' : 'red';
                const typeText = m.type === 'deposit' ? '×”×¤×§×“×”' : '××©×™×›×”';
                
                html += `<tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px;">${date}</td>
                    <td style="color: ${color}; font-weight: bold;">${amount}</td>
                    <td>${typeText}</td>
                    <td style="color: #666;">${m.note || '-'}</td>
                    <td><button onclick="deleteCapitalMovement(${m.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">××—×§</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Add summary
            const totalCapital = portfolio.capitalMovements.reduce((sum, m) => sum + m.amount, 0);
            html += `<div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center;">
                <strong>×¡×”"×› ×”×•×Ÿ ××§×•×¨×™: â‚ª${totalCapital.toLocaleString()}</strong>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function renderSalesHistory() {
            const container = document.getElementById('sales-history-list');
            if (!container) return;
            
            const hasStockSales = portfolio.sales && portfolio.sales.length > 0;
            const hasBondSales = portfolio.bondsSales && portfolio.bondsSales.length > 0;
            
            if (!hasStockSales && !hasBondSales) {
                container.innerHTML = '<p style="text-align: center; color: #999;">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ××›×™×¨×•×ª</p>';
                return;
            }
            
            let html = '';
            
            // ××›×™×¨×•×ª ×× ×™×•×ª
            if (hasStockSales) {
                html += '<h4 style="margin-bottom: 15px; color: #3b82f6;">ğŸ“ˆ ××›×™×¨×•×ª ×× ×™×•×ª</h4>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">';
                html += '<thead><tr style="background: #eff6ff;"><th style="padding: 8px;">×ª××¨×™×š</th><th>×¡×™××•×œ</th><th>×›××•×ª</th><th>××—×™×¨ ××›×™×¨×”</th><th>××—×™×¨ ×§× ×™×™×”</th><th>×¨×•×•×—/×”×¤×¡×“</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>';
                html += '<tbody>';
                
                const sortedStocks = [...portfolio.sales].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let totalRealizedStocks = 0;
                sortedStocks.forEach(s => {
                    const date = new Date(s.date).toLocaleDateString('he-IL');
                    const color = s.profit >= 0 ? 'green' : 'red';
                    const profitText = `${getCurrencySymbol(s.currency)}${s.profit.toFixed(2)} (${s.profitPercent}%)`;
                    
                    // Convert to ILS for total
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    totalRealizedStocks += s.profit * rate;
                    
                    html += `<tr style="border-bottom: 1px solid #dbeafe;">
                        <td style="padding: 8px;">${date}</td>
                        <td><strong>${s.symbol}</strong></td>
                        <td>${s.shares}</td>
                        <td>${getCurrencySymbol(s.currency)}${s.salePrice.toFixed(2)}</td>
                        <td>${getCurrencySymbol(s.currency)}${s.costBasis.toFixed(2)}</td>
                        <td style="color: ${color}; font-weight: bold;">${profitText}</td>
                        <td><button onclick="deleteSale(${s.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-bottom: 20px; padding: 10px; background: #eff6ff; border-radius: 8px; text-align: center; border: 2px solid #3b82f6;">
                    <strong style="color: #1e40af;">×¡×”"×› ×¨×•×•×— ×××•××© ××× ×™×•×ª: â‚ª${Math.round(totalRealizedStocks).toLocaleString()}</strong>
                </div>`;
            }
            
            // ××›×™×¨×•×ª ××’"×—
            if (hasBondSales) {
                html += '<h4 style="margin-bottom: 15px; color: #f59e0b;">ğŸ’¼ ××›×™×¨×•×ª ××’"×—</h4>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">';
                html += '<thead><tr style="background: #fef3c7;"><th style="padding: 8px;">×ª××¨×™×š</th><th>×©× ×§×¨×Ÿ</th><th>×™×—×™×“×•×ª</th><th>××—×™×¨ ××›×™×¨×”</th><th>××—×™×¨ ×§× ×™×™×”</th><th>×¨×•×•×—/×”×¤×¡×“</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>';
                html += '<tbody>';
                
                const sortedBonds = [...portfolio.bondsSales].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let totalRealizedBonds = 0;
                sortedBonds.forEach(s => {
                    const date = new Date(s.date).toLocaleDateString('he-IL');
                    const color = s.profit >= 0 ? 'green' : 'red';
                    const profitPercent = ((s.salePrice - s.costBasis) / s.costBasis * 100).toFixed(2);
                    const profitText = `â‚ª${s.profit.toFixed(2)} (${profitPercent}%)`;
                    
                    totalRealizedBonds += s.profit;
                    
                    html += `<tr style="border-bottom: 1px solid #fde68a;">
                        <td style="padding: 8px;">${date}</td>
                        <td><strong>${s.fundName}</strong></td>
                        <td>${s.units}</td>
                        <td>â‚ª${s.salePrice.toFixed(2)}</td>
                        <td>â‚ª${s.costBasis.toFixed(2)}</td>
                        <td style="color: ${color}; font-weight: bold;">${profitText}</td>
                        <td><button onclick="deleteBondSale(${s.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-bottom: 20px; padding: 10px; background: #fef3c7; border-radius: 8px; text-align: center; border: 2px solid #f59e0b;">
                    <strong style="color: #92400e;">×¡×”"×› ×¨×•×•×— ×××•××© ×××’"×—: â‚ª${Math.round(totalRealizedBonds).toLocaleString()}</strong>
                </div>`;
            }
            
            // ×¡×™×›×•× ×›×•×œ×œ
            if (hasStockSales && hasBondSales) {
                const totalStocks = portfolio.sales.reduce((sum, s) => {
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    return sum + (s.profit * rate);
                }, 0);
                const totalBonds = portfolio.bondsSales.reduce((sum, s) => sum + s.profit, 0);
                const grandTotal = totalStocks + totalBonds;
                
                html += `<div style="padding: 15px; background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border-radius: 8px; text-align: center; border: 2px solid #8b5cf6;">
                    <strong style="color: #5b21b6; font-size: 1.2rem;">ğŸ’° ×¡×”"×› ×¨×•×•×— ×××•××© ×›×•×œ×œ: â‚ª${Math.round(grandTotal).toLocaleString()}</strong>
                </div>`;
            }
            
            container.innerHTML = html;
        }
        
        function renderAllTransactions() {
            const container = document.getElementById('sales-history-list');
            if (!container) return;
            
            // ××¡×•×£ ××ª ×›×œ ×”×¢×¡×§××•×ª
            const allTransactions = [];
            
            console.log('ğŸ“Š Transactions:', portfolio.transactions);
            
            // ×”×•×¡×£ ×§× ×™×•×ª ×× ×™×•×ª ×•××’"×—
            if (portfolio.transactions && portfolio.transactions.length > 0) {
                portfolio.transactions.forEach(t => {
                    // ×›×œ ×¢×¡×§×” - ×’× ×× ×™×•×ª ×•×’× ××’"×—
                    allTransactions.push({
                        ...t,
                        displayType: t.assetType === 'bond' ? 'ğŸ’¼ ××’"×—' : 'ğŸ“ˆ ×× ×™×”',
                        displayAction: t.type === 'buy' ? 'ğŸŸ¢ ×§× ×™×™×”' : 'ğŸ”´ ××›×™×¨×”'
                    });
                });
            }
            
            // ×”×•×¡×£ ×’× deposits
            if (portfolio.deposits && portfolio.deposits.length > 0) {
                portfolio.deposits.forEach(d => {
                    allTransactions.push({
                        id: d.id,
                        date: d.date,
                        type: 'deposit',
                        assetType: 'cash',
                        symbol: d.note || '×”×¤×§×“×”',
                        shares: d.amount,
                        price: 1,
                        currency: d.currency || 'ILS',
                        displayType: 'ğŸ’° ×”×¤×§×“×”',
                        displayAction: 'â• ×”×¤×§×“×”'
                    });
                });
            }
            
            // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">××™×Ÿ ×¢×¡×§××•×ª</p>';
                return;
            }
            
            let html = '<h4 style="margin-bottom: 15px;">ğŸ“Š ×›×œ ×”×¢×¡×§××•×ª</h4>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">';
            html += '<thead><tr style="background: #eff6ff;"><th style="padding: 8px;">×ª××¨×™×š</th><th>×¡×•×’</th><th>×¤×¢×•×œ×”</th><th>×¡×™××•×œ</th><th>×›××•×ª</th><th>××—×™×¨</th><th>×¡×”"×›</th></tr></thead>';
            html += '<tbody>';
            
            allTransactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString('he-IL');
                const currSymbol = getCurrencySymbol(t.currency || 'ILS');
                const total = (t.shares * t.price).toFixed(2);
                const actionColor = t.type === 'buy' ? '#10b981' : '#ef4444';
                
                html += `<tr style="border-bottom: 1px solid #dbeafe;">
                    <td style="padding: 8px;">${date}</td>
                    <td>${t.displayType}</td>
                    <td style="color: ${actionColor}; font-weight: bold;">${t.displayAction}</td>
                    <td><strong>${t.symbol}</strong></td>
                    <td>${t.shares}</td>
                    <td>${currSymbol}${t.price.toFixed(2)}</td>
                    <td>${currSymbol}${total}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            container.innerHTML = html;
        }
        
        function deleteSale(id) {
            if (!confirm('×”×× ×œ××—×•×§ ××›×™×¨×” ×–×• ××”×”×™×¡×˜×•×¨×™×”?')) return;
            
            portfolio.sales = portfolio.sales.filter(s => s.id !== id);
            saveData();
            renderSalesHistory();
            updateCapitalSummary();
            notify('âœ… ××›×™×¨×” × ××—×§×” ××”×”×™×¡×˜×•×¨×™×”');
        }
        
        function deleteBondSale(id) {
            if (!confirm('×”×× ×œ××—×•×§ ××›×™×¨×ª ××’"×— ×–×• ××”×”×™×¡×˜×•×¨×™×”?')) return;
            
            portfolio.bondsSales = portfolio.bondsSales.filter(s => s.id !== id);
            saveData();
            renderSalesHistory();
            updateCapitalSummary();
            notify('âœ… ××›×™×¨×ª ××’"×— × ××—×§×” ××”×”×™×¡×˜×•×¨×™×”');
        }
        
        function updateCapitalSummary() {
            const container = document.getElementById('capital-summary');
            if (!container) return;
            
            // === ×× ×™×•×ª ===
            const stocksCapital = portfolio.capitalMovements ? 
                portfolio.capitalMovements.reduce((sum, m) => sum + m.amount, 0) : 0;
            const stocksValue = getTotalValueILS();
            const stocksRealizedProfit = portfolio.sales ?
                portfolio.sales.reduce((sum, s) => {
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    return sum + (s.profit * rate);
                }, 0) : 0;
            const stocksCost = portfolio.holdings.reduce((sum, h) => {
                const cost = h.shares * h.costBasis;
                return sum + convertToILS(cost, h.currency);
            }, 0);
            const stocksUnrealizedProfit = stocksValue - stocksCost;
            const stocksTotalProfit = stocksValue - stocksCapital;
            const stocksProfitPercent = stocksCapital > 0 ? (stocksTotalProfit / stocksCapital * 100) : 0;
            
            // === ××’"×— ===
            const bondsCapital = portfolio.bondsCapitalMovements ?
                portfolio.bondsCapitalMovements.reduce((sum, m) => sum + m.amount, 0) : 0;
            const bondsValue = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0);
            const bondsCost = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.costBasis), 0);
            const bondsRealizedProfit = portfolio.bondsSales ?
                portfolio.bondsSales.reduce((sum, s) => sum + s.profit, 0) : 0;
            const bondsUnrealizedProfit = bondsValue - bondsCost;
            const bondsTotalProfit = bondsValue - bondsCapital;
            const bondsProfitPercent = bondsCapital > 0 ? (bondsTotalProfit / bondsCapital * 100) : 0;
            
            // === ×¡×”"×› ===
            const totalCapital = stocksCapital + bondsCapital;
            const totalValue = stocksValue + bondsValue;
            const totalProfit = totalValue - totalCapital;
            const totalProfitPercent = totalCapital > 0 ? (totalProfit / totalCapital * 100) : 0;
            
            let html = '';
            
            // ×× ×™×•×ª
            html += `
                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #3b82f6;">
                    <h4 style="margin-bottom: 15px; color: #1e40af;">ğŸ“ˆ ×× ×™×•×ª</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">×”×•×Ÿ ××§×•×¨×™</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #1e40af;">â‚ª${stocksCapital.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">×©×•×•×™ × ×•×›×—×™</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #1e40af;">â‚ª${Math.round(stocksValue).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">×¨×•×•×— ×××•××©</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #1e40af;">â‚ª${Math.round(stocksRealizedProfit).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">×¨×•×•×— ×œ× ×××•××©</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #1e40af;">â‚ª${Math.round(stocksUnrealizedProfit).toLocaleString()}</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">ğŸ’° ×¨×•×•×— ×›×•×œ×œ</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${stocksTotalProfit >= 0 ? '#10b981' : '#ef4444'};">
                                ${stocksTotalProfit >= 0 ? '+' : ''}â‚ª${Math.round(stocksTotalProfit).toLocaleString()} (${stocksProfitPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ××’"×—
            html += `
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #f59e0b;">
                    <h4 style="margin-bottom: 15px; color: #92400e;">ğŸ’¼ ××’"×—</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">×”×•×Ÿ ××§×•×¨×™</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #92400e;">â‚ª${bondsCapital.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">×©×•×•×™ × ×•×›×—×™</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #92400e;">â‚ª${Math.round(bondsValue).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">×¨×•×•×— ×××•××©</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #92400e;">â‚ª${Math.round(bondsRealizedProfit).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">×¨×•×•×— ×œ× ×××•××©</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #92400e;">â‚ª${Math.round(bondsUnrealizedProfit).toLocaleString()}</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">ğŸ’° ×¨×•×•×— ×›×•×œ×œ</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${bondsTotalProfit >= 0 ? '#10b981' : '#ef4444'};">
                                ${bondsTotalProfit >= 0 ? '+' : ''}â‚ª${Math.round(bondsTotalProfit).toLocaleString()} (${bondsProfitPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ×¡×”"×›
            html += `
                <div style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); padding: 20px; border-radius: 12px; border: 2px solid #8b5cf6;">
                    <h4 style="margin-bottom: 15px; color: #5b21b6;">ğŸ’° ×¡×”"×› ×ª×™×§ ×”×©×§×¢×•×ª</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="color: #5b21b6; font-size: 0.8rem; margin-bottom: 3px;">×”×•×Ÿ ××§×•×¨×™ ×›×•×œ×œ</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #5b21b6;">â‚ª${totalCapital.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #5b21b6; font-size: 0.8rem; margin-bottom: 3px;">×©×•×•×™ ×›×•×œ×œ</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #5b21b6;">â‚ª${Math.round(totalValue).toLocaleString()}</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div style="color: #5b21b6; font-size: 0.8rem; margin-bottom: 3px;">ğŸ’ ×¨×•×•×— ×›×•×œ×œ</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: ${totalProfit >= 0 ? '#10b981' : '#ef4444'};">
                                ${totalProfit >= 0 ? '+' : ''}â‚ª${Math.round(totalProfit).toLocaleString()} (${totalProfitPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ×”×¡×‘×¨
            html += `
                <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h4 style="margin-bottom: 10px; color: #374151; font-size: 0.95rem;">ğŸ“Š ×”×¡×‘×¨ ×—×™×©×•×‘:</h4>
                    <div style="font-size: 0.85rem; color: #6b7280; line-height: 1.6;">
                        <strong>×¨×•×•×— ×›×•×œ×œ = ×©×•×•×™ × ×•×›×—×™ - ×”×•×Ÿ ××§×•×¨×™</strong><br>
                        <div style="margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 4px; border-right: 3px solid #f59e0b;">
                            ğŸ’¡ <strong>×—×©×•×‘:</strong> ×”×—×™×©×•×‘ ×œ×•×§×— ×‘×—×©×‘×•×Ÿ ××ª ×ª× ×•×¢×•×ª ×”×”×•×Ÿ (×”×¤×§×“×•×ª ×•××©×™×›×•×ª) ×•×œ× ××ª ×¢×œ×•×ª ×”×¨×›×™×©×” ×”×××•×¦×¢×ª.
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ===========================================
        // CALCULATE CAPITAL FROM HOLDINGS
        // ===========================================
        let selectedHoldings = new Set();
        
        function showCalculateCapitalFromHoldings() {
            if (portfolio.holdings.length === 0) {
                notify('âŒ ××™×Ÿ ×”×—×–×§×•×ª ×‘×ª×™×§', 'error');
                return;
            }
            
            // Reset selection
            selectedHoldings = new Set(portfolio.holdings.map(h => h.id));
            
            // Render checkboxes
            renderHoldingsCheckboxes();
            
            // Show modal
            const modal = document.getElementById('calculate-capital-modal');
            modal.style.display = 'flex';
        }
        
        function hideCalculateCapitalModal() {
            document.getElementById('calculate-capital-modal').style.display = 'none';
        }
        
        function renderHoldingsCheckboxes() {
            const container = document.getElementById('holdings-checkboxes');
            if (!container) return;
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            portfolio.holdings.forEach(h => {
                const cost = h.shares * h.costBasis;
                const costILS = convertToILS(cost, h.currency);
                const checked = selectedHoldings.has(h.id) ? 'checked' : '';
                
                html += `
                    <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid ${checked ? '#3b82f6' : '#e5e7eb'};">
                        <input type="checkbox" ${checked} onchange="toggleHoldingSelection(${h.id})" style="width: 20px; height: 20px; margin-left: 10px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 3px;">${h.symbol}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">
                                ${h.shares} ×× ×™×•×ª Ã— ${getCurrencySymbol(h.currency)}${h.costBasis.toFixed(2)} = 
                                <strong>${getCurrencySymbol(h.currency)}${cost.toFixed(2)}</strong>
                                ${h.currency !== 'ILS' ? ` (â‚ª${Math.round(costILS).toLocaleString()})` : ''}
                            </div>
                        </div>
                    </label>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            updateSelectedCapitalTotal();
        }
        
        function toggleHoldingSelection(id) {
            if (selectedHoldings.has(id)) {
                selectedHoldings.delete(id);
            } else {
                selectedHoldings.add(id);
            }
            renderHoldingsCheckboxes();
        }
        
        function updateSelectedCapitalTotal() {
            let total = 0;
            selectedHoldings.forEach(id => {
                const holding = portfolio.holdings.find(h => h.id === id);
                if (holding) {
                    const cost = holding.shares * holding.costBasis;
                    total += convertToILS(cost, holding.currency);
                }
            });
            
            const display = document.getElementById('selected-capital-total');
            if (display) {
                display.textContent = `â‚ª${Math.round(total).toLocaleString()}`;
            }
        }
        
        function addCalculatedCapital() {
            if (selectedHoldings.size === 0) {
                notify('âŒ ×‘×—×¨ ×œ×¤×—×•×ª ×”×—×–×§×” ××—×ª', 'error');
                return;
            }
            
            let total = 0;
            const selectedSymbols = [];
            
            selectedHoldings.forEach(id => {
                const holding = portfolio.holdings.find(h => h.id === id);
                if (holding) {
                    const cost = holding.shares * holding.costBasis;
                    total += convertToILS(cost, holding.currency);
                    selectedSymbols.push(holding.symbol);
                }
            });
            
            // Add as capital movement
            if (!portfolio.capitalMovements) portfolio.capitalMovements = [];
            portfolio.capitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: Math.round(total),
                type: 'deposit',
                note: `×—×™×©×•×‘ ××•×˜×•××˜×™: ${selectedSymbols.join(', ')}`
            });
            
            saveData();
            renderCapitalMovements();
            updateCapitalSummary();
            hideCalculateCapitalModal();
            
            notify(`âœ… × ×•×¡×£ ×”×•×Ÿ ××§×•×¨×™: â‚ª${Math.round(total).toLocaleString()}`);
        }
        
        function renderHoldingsList() {
            const container = document.getElementById('holdings-list');
            
            if (!container) {
                console.error('âŒ Holdings list container not found');
                return;
            }
            
            console.log('ğŸ“Š Rendering holdings list (Table view). Total:', portfolio.holdings.length);
            
            if (portfolio.holdings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">××™×Ÿ ×”×—×–×§×•×ª ×¢×“×™×™×Ÿ</p>
                        <p>×œ×—×¥ ×¢×œ "×”×•×¡×£ ×”×—×–×§×”" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                `;
                return;
            }
            
            // ×˜×‘×œ×” ×¨×•×—×‘×™×ª × ×§×™×™×”
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden;">';
            html += `<thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <tr>
                    <th style="padding: 15px; text-align: right; font-weight: 700;">×¡×™××•×œ</th>
                    <th style="padding: 15px; text-align: right;">×§×‘×•×¦×”</th>
                    <th style="padding: 15px; text-align: center;">×× ×™×•×ª</th>
                    <th style="padding: 15px; text-align: center;">××—×™×¨ ×§× ×™×™×”</th>
                    <th style="padding: 15px; text-align: center;">××—×™×¨ × ×•×›×—×™</th>
                    <th style="padding: 15px; text-align: center;">×©×•×•×™</th>
                    <th style="padding: 15px; text-align: center;">×¨×•×•×—/×”×¤×¡×“</th>
                    <th style="padding: 15px; text-align: center;">×¤×¢×•×œ×•×ª</th>
                </tr>
            </thead><tbody>`;
            
            portfolio.holdings.forEach(holding => {
                const holdingGroupId = parseInt(holding.groupId);
                const group = portfolio.groups.find(g => g.id === holdingGroupId);
                
                const currentValue = holding.shares * (holding.currentPrice || holding.costBasis);
                const costValue = holding.shares * holding.costBasis;
                const profit = currentValue - costValue;
                const profitPercent = (profit / costValue) * 100;
                const profitColor = profit >= 0 ? '#10b981' : '#ef4444';
                
                html += `<tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 15px; font-weight: 700; color: #1f2937;">
                        ${holding.symbol}
                        ${holding.altTicker ? `<br><span style="font-size: 0.75rem; color: #667eea;">â†’ ${holding.altTicker}</span>` : ''}
                        ${holding.isManualPrice ? '<span style="font-size: 0.75rem; color: #f59e0b; margin-right: 5px;" title="××—×™×¨ ×™×“× ×™ - ××•×’×Ÿ">ğŸ”’</span>' : ''}
                    </td>
                    <td style="padding: 15px; color: #6b7280;">
                        ${group ? group.name : '×œ× ×™×“×•×¢'}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600;">
                        ${holding.shares}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        ${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600;">
                        ${getCurrencySymbol(holding.currency)}${(holding.currentPrice || holding.costBasis).toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: #1f2937;">
                        ${getCurrencySymbol(holding.currency)}${currentValue.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: ${profitColor};">
                        ${profit >= 0 ? '+' : ''}${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}
                        <br>
                        <span style="font-size: 0.85rem;">(${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%)</span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="showAddSharesForm(${holding.id})" class="btn btn-sm" title="×”×•×¡×£ ×× ×™×•×ª" style="background: #10b981; color: white; padding: 6px 10px; font-size: 0.8rem;">
                                â•
                            </button>
                            <button onclick="showSellSharesForm(${holding.id})" class="btn btn-sm" title="××›×•×¨" style="background: #f59e0b; color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ğŸ’¸
                            </button>
                            <button onclick="editHolding(${holding.id})" class="btn btn-sm" title="×¢×¨×•×š" style="background: #3b82f6; color: white; padding: 6px 10px; font-size: 0.8rem;">
                                âœï¸
                            </button>
                            <button onclick="updatePriceManually(${holding.id})" class="btn btn-sm" title="${holding.isManualPrice ? '××—×™×¨ ××•×’×Ÿ' : '×¢×“×›×Ÿ ××—×™×¨'}" style="background: #8b5cf6; color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ${holding.isManualPrice ? 'ğŸ”’' : 'ğŸ’°'}
                            </button>
                            <button onclick="deleteHolding(${holding.id})" class="btn btn-sm" title="××—×§" style="background: #ef4444; color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ===========================================
        // OVERVIEW
        // ===========================================
        
        function updateOverview() {
            console.log('ğŸ”„ Starting updateOverview...');
            
            // =============================================
            // CALCULATE EVERYTHING FIRST
            // =============================================
            const stocksValue = getTotalValueILS();
            const bondsValue = Array.isArray(portfolio.bonds) ? 
                portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0) : 0;
            const bondsCount = Array.isArray(portfolio.bonds) ? portfolio.bonds.length : 0;
            const totalValue = getTotalPortfolioValue();
            const availableCash = getImplicitCash('all');
            
            // Deposits & Withdrawals
            const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + (d.amount || 0), 0);
            const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => sum + (w.amount || 0), 0);
            const stocksDeposits = portfolio.deposits.filter(d => !d.assetType || d.assetType === 'stocks')
                .reduce((sum, d) => sum + d.amount, 0);
            const bondsDeposits = portfolio.deposits.filter(d => d.assetType === 'bonds')
                .reduce((sum, d) => sum + d.amount, 0);
            
            // TWR Calculation
            const totalTWR = calculateTWR('total');
            
            // =============================================
            // UPDATE MAIN TWR HERO
            // =============================================
            if (totalTWR !== null) {
                const color = totalTWR.total >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('main-twr-display').textContent = 
                    `${totalTWR.total >= 0 ? '+' : ''}${totalTWR.total.toFixed(1)}%`;
                document.getElementById('main-twr-display').style.color = color;
                
                // TWR Breakdown (Base + Live)
                if (totalTWR.base !== undefined && totalTWR.live !== undefined) {
                    document.getElementById('twr-breakdown').textContent = 
                        `Base: ${totalTWR.base >= 0 ? '+' : ''}${totalTWR.base.toFixed(1)}% | Live: ${totalTWR.live >= 0 ? '+' : ''}${totalTWR.live.toFixed(1)}%`;
                } else {
                    document.getElementById('twr-breakdown').textContent = '';
                }
                
                // Absolute Profit
                const profit = totalValue - totalDeposits + totalWithdrawals;
                document.getElementById('main-profit-display').textContent = 
                    `${profit >= 0 ? '+' : ''}â‚ª${Math.round(profit).toLocaleString()}`;
                document.getElementById('main-profit-display').style.color = profit >= 0 ? '#10b981' : '#ef4444';
                
                // Period Info
                if (totalTWR.years !== undefined) {
                    const days = Math.round(totalTWR.years * 365);
                    document.getElementById('twr-period-info').textContent = 
                        `ğŸ“… ××ª×—×™×œ×ª ×”×ª×™×§: ${totalTWR.years.toFixed(1)} ×©× ×™× (${days} ×™××™×)`;
                }
            } else {
                document.getElementById('main-twr-display').textContent = '--';
                document.getElementById('twr-breakdown').textContent = '×¦×‘×•×¨ × ×ª×•× ×™×...';
                document.getElementById('main-profit-display').textContent = 'â‚ª0';
                document.getElementById('twr-period-info').textContent = 'ğŸ“… ×”×•×¡×£ ×”×¤×§×“×” ××• ××©×™×›×” ×œ×—×™×©×•×‘ TWR';
            }
            
            // =============================================
            // UPDATE STOCKS CARD
            // =============================================
            document.getElementById('stocks-value').textContent = `â‚ª${Math.round(stocksValue).toLocaleString()}`;
            
            const usdTotal = portfolio.holdings.filter(h => h.currency === 'USD')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            const eurTotal = portfolio.holdings.filter(h => h.currency === 'EUR')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            
            document.getElementById('stocks-value-original').textContent = 
                `$${Math.round(usdTotal).toLocaleString()} + â‚¬${Math.round(eurTotal).toLocaleString()}`;
            
            document.getElementById('stocks-count').textContent = `${portfolio.holdings.length} ×”×—×–×§×•×ª`;
            document.getElementById('stocks-capital').textContent = `â‚ª${Math.round(stocksDeposits).toLocaleString()}`;
            
            // =============================================
            // UPDATE BONDS CARD
            // =============================================
            document.getElementById('bonds-value').textContent = `â‚ª${Math.round(bondsValue).toLocaleString()}`;
            document.getElementById('bonds-count').textContent = `${bondsCount} ×§×¨× ×•×ª`;
            document.getElementById('bonds-count-num').textContent = `${bondsCount}`;
            document.getElementById('bonds-cost').textContent = `â‚ª${Math.round(bondsDeposits).toLocaleString()}`;
            
            // =============================================
            // UPDATE TOTAL CARD
            // =============================================
            const totalValueEl = document.getElementById('total-value');
            const totalValue2El = document.getElementById('total-value-2');
            const overviewTotalDepositsEl = document.getElementById('overview-total-deposits');
            
            if (totalValueEl) totalValueEl.textContent = `â‚ª${Math.round(totalValue).toLocaleString()}`;
            if (totalValue2El) totalValue2El.textContent = `â‚ª${Math.round(totalValue).toLocaleString()}`;
            if (overviewTotalDepositsEl) overviewTotalDepositsEl.textContent = `×”×•×©×§×¢: â‚ª${Math.round(totalDeposits).toLocaleString()}`;
            
            const availableCashOverviewEl = document.getElementById('available-cash-overview');
            if (availableCashOverviewEl) availableCashOverviewEl.textContent = `â‚ª${Math.round(availableCash).toLocaleString()}`;
            
            // Update last update time
            const now = new Date();
            const lastUpdateTimeEl = document.getElementById('last-update-time');
            if (lastUpdateTimeEl) lastUpdateTimeEl.textContent = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            
            // =============================================
            // UPDATE CASH FLOW SUMMARY
            // =============================================
            const totalDepositsEl = document.getElementById('total-deposits');
            const totalWithdrawalsEl = document.getElementById('total-withdrawals');
            const availableCashSummaryEl = document.getElementById('available-cash-summary');
            
            if (totalDepositsEl) totalDepositsEl.textContent = `â‚ª${Math.round(totalDeposits).toLocaleString()}`;
            if (totalWithdrawalsEl) totalWithdrawalsEl.textContent = `â‚ª${Math.round(totalWithdrawals).toLocaleString()}`;
            if (availableCashSummaryEl) availableCashSummaryEl.textContent = `â‚ª${Math.round(availableCash).toLocaleString()}`;
            
            // =============================================
            // RENDER OTHER SECTIONS
            // =============================================
            renderAllocationComparison();
            renderPortfolioChart();
            updateAnalysisTab();
        }
        
        function renderAllocationComparison() {
            const container = document.getElementById('allocation-comparison');
            const totalValue = getTotalValueILS();
            
            console.log('ğŸ“Š renderAllocationComparison - Total value:', totalValue);
            console.log('ğŸ“Š All holdings:', portfolio.holdings.map(h => ({ symbol: h.symbol, groupId: h.groupId, groupIdType: typeof h.groupId })));
            
            const html = portfolio.groups.map(group => {
                // Handle both string and number groupId
                const groupHoldings = portfolio.holdings.filter(h => {
                    const holdingGroupId = parseInt(h.groupId);
                    return holdingGroupId === group.id;
                });
                
                console.log(`ğŸ“‚ Group ${group.name} (ID: ${group.id}):`, {
                    holdings: groupHoldings.length,
                    symbols: groupHoldings.map(h => h.symbol)
                });
                
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    const ilsValue = convertToILS(value, h.currency);
                    console.log(`  - ${h.symbol}: ${h.shares} Ã— ${h.currentPrice || h.costBasis} ${h.currency} = â‚ª${ilsValue.toFixed(2)}`);
                    return sum + ilsValue;
                }, 0);
                
                console.log(`  Total group value: â‚ª${groupValue.toFixed(2)}`);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = actualPercent - group.target;
                
                let statusBadge = '';
                let statusClass = '';
                if (Math.abs(diff) < 2) {
                    statusBadge = 'ğŸŸ¢ ×××•×–×Ÿ';
                    statusClass = 'ok';
                } else if (diff < 0) {
                    statusBadge = `ğŸŸ¡ ×—×¡×¨ ${Math.abs(diff).toFixed(1)}%`;
                    statusClass = 'under';
                } else {
                    statusBadge = `ğŸ”´ ×™×ª×¨ ${diff.toFixed(1)}%`;
                    statusClass = 'over';
                }
                
                // Build holdings breakdown HTML
                const holdingsHTML = groupHoldings.length > 0 ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: #6b7280; margin-bottom: 10px;">
                            ğŸ“‹ ×× ×™×•×ª ×‘×§×‘×•×¦×” (${groupHoldings.length}):
                        </div>
                        <div style="display: grid; gap: 8px;">
                            ${groupHoldings.map(h => {
                                const value = h.shares * (h.currentPrice || h.costBasis);
                                const ilsValue = convertToILS(value, h.currency);
                                const holdingPercent = totalValue > 0 ? (ilsValue / totalValue * 100) : 0;
                                const profit = value - (h.shares * h.costBasis);
                                const profitPercent = (profit / (h.shares * h.costBasis)) * 100;
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; 
                                                padding: 8px 12px; background: white; border-radius: 6px; font-size: 0.85rem;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-weight: 600; color: #111827;">${h.symbol}</span>
                                            ${h.altTicker ? `<span style="font-size: 0.7rem; color: #667eea;">â†’ ${h.altTicker}</span>` : ''}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <span style="color: #6b7280;">
                                                â‚ª${Math.round(ilsValue).toLocaleString()}
                                            </span>
                                            <span style="color: ${profit >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600; font-size: 0.8rem;">
                                                ${profit >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%
                                            </span>
                                            <span style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: #6b7280;">
                                                ${holdingPercent.toFixed(1)}%
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : `
                    <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px; text-align: center; font-size: 0.85rem; color: #92400e;">
                        âš ï¸ ××™×Ÿ ×× ×™×•×ª ×‘×§×‘×•×¦×” ×–×•
                    </div>
                `;
                
                return `
                    <div class="group-card">
                        <div class="group-header">
                            <div class="group-title">${group.name}</div>
                            <div class="group-target">×™×¢×“: ${group.target}%</div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-header">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span>×‘×¤×•×¢×œ: ${actualPercent.toFixed(1)}%</span>
                                    <span style="color: #6b7280; font-size: 0.85rem;">
                                        (â‚ª${Math.round(groupValue).toLocaleString()})
                                    </span>
                                </div>
                                <span class="status-badge ${statusClass}">${statusBadge}</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min(actualPercent, 100)}%">
                                    ${actualPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        ${holdingsHTML}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function renderPortfolioChart() {
            const canvas = document.getElementById('portfolio-chart');
            if (!canvas) return;
            
            if (charts.portfolio) {
                charts.portfolio.destroy();
            }
            
            const totalValue = getTotalValueILS();
            const data = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                return groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
            });
            
            charts.portfolio = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: portfolio.groups.map(g => g.name),
                    datasets: [{
                        data: data,
                        backgroundColor: portfolio.groups.map(g => g.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = totalValue > 0 ? (value / totalValue * 100).toFixed(1) : 0;
                                    return `${context.label}: â‚ª${Math.round(value).toLocaleString()} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===========================================
        // GROUPS
        // ===========================================
        
        function renderGroupsList() {
            const container = document.getElementById('groups-list');
            const totalValue = getTotalValueILS();
            
            const html = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                
                return `
                    <div class="group-card">
                        <div class="group-header">
                            <div class="group-title">${group.name}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="group-target">×™×¢×“: ${group.target}% | ×‘×¤×•×¢×œ: ${actualPercent.toFixed(1)}%</div>
                                <button onclick="editGroup(${group.id})" class="btn btn-primary btn-sm" title="×¢×¨×•×š ×§×‘×•×¦×”">
                                    âœï¸ ×¢×¨×•×š
                                </button>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min(actualPercent, 100)}%; background: ${group.color}">
                                    ${actualPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        <div class="group-holdings" style="margin-top: 15px; display: grid; gap: 10px;">
                            ${groupHoldings.map(h => {
                                const value = h.shares * (h.currentPrice || h.costBasis);
                                const valueILS = convertToILS(value, h.currency);
                                const holdingPercent = totalValue > 0 ? (valueILS / totalValue * 100) : 0;
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
                                        <span style="font-weight: 600;">${h.symbol}</span>
                                        <span style="color: #6b7280;">
                                            â‚ª${Math.round(valueILS).toLocaleString()} (${holdingPercent.toFixed(1)}%)
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // RECOMMENDATIONS
        // ===========================================
        
        function editGroup(groupId) {
            const group = portfolio.groups.find(g => g.id === groupId);
            if (!group) return;
            
            // ×©× ×”×§×‘×•×¦×”
            const newName = prompt(`×¢×¨×•×š ×©× ×§×‘×•×¦×”\n\n×©× × ×•×›×—×™: ${group.name}\n\n×”×–×Ÿ ×©× ×—×“×©:`, group.name);
            if (newName === null) return;
            if (newName.trim()) group.name = newName.trim();
            
            // ××—×•×– ×™×¢×“
            const newTarget = prompt(`×¢×¨×•×š ××—×•×– ×™×¢×“\n\n×™×¢×“ × ×•×›×—×™: ${group.target}%\n\n×”×–×Ÿ ×™×¢×“ ×—×“×© (0-100):`, group.target);
            if (newTarget === null) return;
            const targetNum = parseFloat(newTarget);
            if (!isNaN(targetNum) && targetNum >= 0 && targetNum <= 100) {
                group.target = targetNum;
            }
            
            // ×¦×‘×¢
            const newColor = prompt(`×¢×¨×•×š ×¦×‘×¢ ×§×‘×•×¦×”\n\n×¦×‘×¢ × ×•×›×—×™: ${group.color}\n\n×”×–×Ÿ ×§×•×“ ×¦×‘×¢ (HEX):`, group.color);
            if (newColor === null) return;
            if (newColor.trim()) group.color = newColor.trim();
            
            saveData();
            renderGroupsList();
            updateOverview();
            notify(`âœ… ×§×‘×•×¦×” "${group.name}" ×¢×•×“×›× ×”`);
        }
        
        function renderRecommendations() {
            const container = document.getElementById('recommendations-list');
            const totalValue = getTotalValueILS();
            
            const recommendations = [];
            
            portfolio.groups.forEach(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = group.target - actualPercent;
                
                if (Math.abs(diff) > 2) {
                    recommendations.push({
                        group: group.name,
                        diff: diff,
                        action: diff > 0 ? 'buy' : 'sell'
                    });
                }
            });
            
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="glass" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ‰</div>
                        <h3 style="color: #10b981; margin-bottom: 10px;">×”×ª×™×§ ×××•×–×Ÿ ××¦×•×™×Ÿ!</h3>
                        <p style="color: #6b7280;">×›×œ ×”×§×‘×•×¦×•×ª ×§×¨×•×‘×•×ª ×œ×™×¢×“ ×©×œ×”×Ÿ</p>
                    </div>
                `;
                return;
            }
            
            const html = recommendations.map(rec => {
                const color = rec.action === 'buy' ? '#fef3c7' : '#fee2e2';
                const textColor = rec.action === 'buy' ? '#92400e' : '#991b1b';
                const icon = rec.action === 'buy' ? 'ğŸ’°' : 'ğŸ“‰';
                const actionText = rec.action === 'buy' ? '×§× ×”' : '××›×•×¨';
                
                return `
                    <div class="glass" style="background: ${color}; border: 2px solid ${textColor}40; margin-bottom: 15px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 2rem;">${icon}</span>
                            <h4 style="color: ${textColor};">${actionText} ${rec.group}</h4>
                        </div>
                        <p style="color: ${textColor};">
                            ${rec.action === 'buy' 
                                ? `×”×§×‘×•×¦×” ×—×¡×¨×” ${Math.abs(rec.diff).toFixed(1)}% ××”×™×¢×“. ×‘×§× ×™×” ×”×‘××”, ×”×ª××§×“ ×‘×§×‘×•×¦×” ×–×•.`
                                : `×”×§×‘×•×¦×” ×¢×•×“×¤×ª ×‘-${Math.abs(rec.diff).toFixed(1)}%. ×©×§×•×œ ×œ×”×¤×¡×™×§ ×œ×”×©×§×™×¢ ×‘×” ×–×× ×™×ª.`
                            }
                        </p>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // SETTINGS
        // ===========================================
        
        function saveBonds() {
            portfolio.bonds = parseFloat(document.getElementById('bonds-amount').value) || 0;
            saveData();
            updateOverview();
            notify('âœ… ××’"×— × ×©××¨');
        }
        
        function exportData() {
            const json = JSON.stringify(portfolio, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            notify('âœ… × ×ª×•× ×™× ×™×•×¦××•');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    portfolio = JSON.parse(e.target.result);
                    saveData();
                    updateOverview();
                    renderGroupsList();
                    renderHoldingsList();
                    renderCashFlow();
                    renderTransactions();
                    notify('âœ… × ×ª×•× ×™× ×™×•×‘××•');
                } catch (error) {
                    notify('âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }
        
        function deleteAllData() {
            const confirmation = confirm('âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ×œ×¦××™×ª×•×ª:\nâ€¢ ×›×œ ×”×× ×™×•×ª\nâ€¢ ×›×œ ×”××’"×—\nâ€¢ ×›×œ ×”×”×¤×§×“×•×ª ×•×”××©×™×›×•×ª\nâ€¢ ×›×œ ×”×¢×¡×§××•×ª\nâ€¢ ×›×œ ×”-Snapshots\n\n×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ××ª ×”× ×ª×•× ×™×!\n\n×”×§×œ×“ "××—×§ ×”×›×œ" ×›×“×™ ×œ××©×¨.');
            
            if (!confirmation) return;
            
            const secondConfirmation = prompt('×”×§×œ×“ "××—×§ ×”×›×œ" ×‘×“×™×•×§ ×›×“×™ ×œ××©×¨ ××—×™×§×”:');
            
            if (secondConfirmation !== '××—×§ ×”×›×œ') {
                notify('âŒ ××—×™×§×” ×‘×•×˜×œ×”', 'warning');
                return;
            }
            
            // Reset portfolio to empty state
            portfolio = {
                holdings: [],
                groups: [
                    { id: 1, name: '××“×“×™× ×¢×•×œ××™×™×', target: 60, color: '#3b82f6' },
                    { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                    { id: 3, name: '××§×˜×™×‘×™/×¡×™×›×•× ×™', target: 10, color: '#ef4444' }
                ],
                rates: {
                    USD: 3.75,
                    EUR: 4.05
                },
                bonds: [],
                deposits: [],
                withdrawals: [],
                purchases: [],
                sales: [],
                snapshots: []
            };
            
            // Save to localStorage
            saveData();
            
            // Refresh all views
            updateOverview();
            renderHoldingsList();
            renderBondsList();
            renderCashFlow();
            
            renderTransactions();
            
            notify('âœ… ×›×œ ×”× ×ª×•× ×™× × ××—×§×•', 'success');
        }
        
        function fixSnapshots() {
            if (!confirm('ğŸ”§ ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”-Snapshots ×”×™×©× ×™× ×•×ª×™×¦×•×¨ snapshot ××—×“ ×—×“×© ×¢× ×”×¤×•×¨××˜ ×”××¢×•×“×›×Ÿ.\n\n×”××©×š?')) {
                return;
            }
            
            // Delete all old snapshots
            portfolio.snapshots = [];
            
            // Create one new snapshot with current portfolio value
            const currentValue = getTotalPortfolioValue();
            const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + (d.amount || 0), 0);
            
            createSnapshot('fix', '×ª×™×§×•×Ÿ ×¤×•×¨××˜', 0);
            
            // Update the snapshot to have proper value_before_flow
            if (portfolio.snapshots.length > 0) {
                const newSnapshot = portfolio.snapshots[0];
                newSnapshot.value_before_flow = 0;
                newSnapshot.cash_flow = totalDeposits;
            }
            
            saveData();
            
            updateOverview();
            
            notify('âœ… Snapshots ×ª×•×§× ×•! TWR ×™×ª×—×™×œ ×œ×”×ª×¢×“×›×Ÿ ××¢×›×©×™×•.', 'success');
        }

        // ===========================================
        // ANALYSIS TAB - METRICS & TREEMAP
        // ===========================================
        
        // ========================================
        // MWR (Money-Weighted Return) Calculation
        // ========================================
        
        /**
         * Calculate IRR (Internal Rate of Return) using Newton-Raphson method
         * @param {Array} cashFlows - Array of {date, amount} objects
         * @returns {number} IRR as decimal (e.g., 0.15 = 15%)
         */
        /**
         * Calculate XNPV (Net Present Value with dates)
         * Similar to Excel's XNPV function
         */
        function XNPV(rate, values, dates) {
            if (values.length !== dates.length) {
                return null;
            }
            
            const firstDate = dates[0];
            let npv = 0;
            
            for (let i = 0; i < values.length; i++) {
                const diffDays = (dates[i] - firstDate) / (1000 * 60 * 60 * 24);
                npv += values[i] / Math.pow(1 + rate, diffDays / 365.25);
            }
            
            return npv;
        }
        
        /**
         * Calculate XIRR (Internal Rate of Return with dates)
         * Similar to Excel's XIRR function
         * Returns annualized rate directly
         */
        function XIRR(values, dates, guess = 0.1) {
            if (values.length !== dates.length || values.length < 2) {
                console.log('âŒ XIRR: Invalid input lengths');
                return null;
            }
            
            // Check that we have both positive and negative values
            const hasPositive = values.some(v => v > 0);
            const hasNegative = values.some(v => v < 0);
            if (!hasPositive || !hasNegative) {
                console.log('âŒ XIRR: Need both positive and negative values');
                return null;
            }
            
            console.log('ğŸ”¢ XIRR starting Newton-Raphson...');
            
            // Newton-Raphson method
            let rate = guess;
            const maxIterations = 100;
            const tolerance = 0.0001;
            
            for (let i = 0; i < maxIterations; i++) {
                const npv = XNPV(rate, values, dates);
                
                if (i % 10 === 0 || i < 5) {
                    console.log(`  Iteration ${i}: rate=${(rate*100).toFixed(4)}%, NPV=${npv.toFixed(2)}`);
                }
                
                if (Math.abs(npv) < tolerance) {
                    console.log(`âœ… XIRR converged: ${(rate*100).toFixed(2)}% (${i} iterations)`);
                    return rate; // Already annualized!
                }
                
                // Calculate derivative (dNPV/dRate)
                const firstDate = dates[0];
                let dnpv = 0;
                for (let j = 0; j < values.length; j++) {
                    const diffDays = (dates[j] - firstDate) / (1000 * 60 * 60 * 24);
                    const years = diffDays / 365.25;
                    dnpv -= years * values[j] / Math.pow(1 + rate, years + 1);
                }
                
                if (dnpv === 0) {
                    console.log(`âš ï¸ XIRR: dnpv=0 at iteration ${i}`);
                    break;
                }
                
                const newRate = rate - npv / dnpv;
                
                if (!isFinite(newRate) || Math.abs(newRate) > 100) {
                    console.log(`âš ï¸ XIRR: newRate out of bounds at iteration ${i}`);
                    break;
                }
                
                if (Math.abs(newRate - rate) < 1e-10) {
                    console.log(`âœ… XIRR converged by delta: ${(newRate*100).toFixed(2)}%`);
                    return newRate;
                }
                
                rate = newRate;
            }
            
            console.log('âš ï¸ XIRR: Newton-Raphson failed, trying Bisection...');
            
            // If Newton-Raphson fails, try bisection
            let low = -0.99;
            let high = 10.0;
            
            const npvLow = XNPV(low, values, dates);
            const npvHigh = XNPV(high, values, dates);
            
            console.log(`ğŸ” Bisection: NPV(${(low*100).toFixed(0)}%)=${npvLow.toFixed(2)}, NPV(${(high*100).toFixed(0)}%)=${npvHigh.toFixed(2)}`);
            
            if (npvLow * npvHigh > 0) {
                console.log('âŒ XIRR: No solution (NPV does not cross zero)');
                return null; // No solution
            }
            
            for (let i = 0; i < 100; i++) {
                const mid = (low + high) / 2;
                const npvMid = XNPV(mid, values, dates);
                
                if (i % 10 === 0) {
                    console.log(`  Bisection ${i}: mid=${(mid*100).toFixed(4)}%, NPV=${npvMid.toFixed(4)}`);
                }
                
                if (Math.abs(npvMid) < tolerance) {
                    console.log(`âœ… XIRR (Bisection): ${(mid*100).toFixed(2)}%`);
                    return mid;
                }
                
                if (npvMid * npvLow < 0) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            
            console.log('âŒ XIRR: Bisection also failed');
            return null;
        }
        
        /**
         * Calculate IRR (Internal Rate of Return) using Newton-Raphson method
         * Returns annualized IRR if period < 1 year
         * @param {Array} cashFlows - Array of {date, amount} objects
         * @returns {number} IRR as decimal (e.g., 0.15 = 15%)
         */
        function calculateIRR(cashFlows) {
            if (!cashFlows || cashFlows.length < 2) {
                console.log('âŒ IRR: Not enough cash flows');
                return null;
            }
            
            // Sort by date
            const flows = [...cashFlows].sort((a, b) => a.date - b.date);
            
            console.log('ğŸ”¢ IRR Input flows:', flows.map(f => ({
                date: f.date.toLocaleDateString('he-IL'),
                amount: f.amount.toFixed(2)
            })));
            
            // Check if all flows are same sign (invalid for IRR)
            const allPositive = flows.every(f => f.amount > 0);
            const allNegative = flows.every(f => f.amount < 0);
            
            if (allPositive || allNegative) {
                console.log('âŒ IRR: All cash flows have same sign');
                return null;
            }
            
            // Reference date (earliest date)
            const refDate = flows[0].date;
            
            // Convert dates to years from reference
            const flowsWithYears = flows.map(f => ({
                years: (f.date - refDate) / (1000 * 60 * 60 * 24 * 365.25),
                amount: f.amount
            }));
            
            const totalYears = flowsWithYears[flowsWithYears.length - 1].years;
            
            console.log(`ğŸ“… Period: ${totalYears.toFixed(4)} years (${(totalYears * 365.25).toFixed(1)} days)`);
            
            // Newton-Raphson to find IRR for the period (not annualized)
            // For short periods, IRR will be very small, so we need better starting guesses
            const startingGuesses = [0, 0.0001, 0.001, 0.005, 0.01, -0.0001, -0.001, 0.05, 0.1, 0.02];
            
            for (let guess of startingGuesses) {
                let rate = guess;
                const maxIterations = 3000;
                const tolerance = 1e-12; // Tighter tolerance for better accuracy
                
                for (let i = 0; i < maxIterations; i++) {
                    let npv = 0;
                    let dnpv = 0;
                    
                    flowsWithYears.forEach(f => {
                        const factor = Math.pow(1 + rate, f.years);
                        if (!isFinite(factor) || factor === 0) return;
                        
                        npv += f.amount / factor;
                        dnpv -= f.years * f.amount / (factor * (1 + rate));
                    });
                    
                    // Check both absolute and relative error
                    const absError = Math.abs(npv);
                    const sumAbsFlows = flowsWithYears.reduce((sum, f) => sum + Math.abs(f.amount), 0);
                    const relError = absError / (sumAbsFlows + 1);
                    
                    if (absError < 0.01 || relError < 1e-10) {
                        // Found period IRR, now annualize if needed
                        let annualizedRate = rate;
                        
                        if (totalYears > 0 && totalYears < 1) {
                            // Annualize: (1 + period_rate)^(1/years) - 1
                            annualizedRate = Math.pow(1 + rate, 1 / totalYears) - 1;
                            console.log(`âœ… IRR: Period=${(rate*100).toFixed(4)}%, Annualized=${(annualizedRate*100).toFixed(2)}% (${i} iterations, NPV=${npv.toFixed(4)})`);
                        } else {
                            console.log(`âœ… IRR: ${(rate*100).toFixed(2)}% (${i} iterations, NPV=${npv.toFixed(4)})`);
                        }
                        
                        return annualizedRate;
                    }
                    
                    if (!isFinite(dnpv) || dnpv === 0) break;
                    
                    // Newton step with damping to prevent overshooting
                    const rawStep = -npv / dnpv;
                    const dampingFactor = 0.5; // Use half-steps for stability
                    const newRate = rate + dampingFactor * rawStep;
                    
                    if (!isFinite(newRate) || newRate < -0.99 || newRate > 1000) break;
                    
                    // Check if we're converging
                    if (i > 10 && Math.abs(newRate - rate) < 1e-12) {
                        // Converged in delta, check NPV one more time
                        break;
                    }
                    
                    rate = newRate;
                }
            }
            
            console.log('âš ï¸ IRR: Newton-Raphson failed, trying Secant method');
            
            // Secant method as fallback - more stable for difficult cases
            const calcNPV = (rate) => {
                let npv = 0;
                flowsWithYears.forEach(f => {
                    const factor = Math.pow(1 + rate, f.years);
                    if (isFinite(factor) && factor !== 0) {
                        npv += f.amount / factor;
                    }
                });
                return npv;
            };
            
            // Try multiple starting pairs for Secant method
            const secantStarts = [
                [0, 0.001],
                [0, 0.01],
                [-0.001, 0.001],
                [0.001, 0.005],
                [0, 0.0001]
            ];
            
            for (let [r0, r1] of secantStarts) {
                let rate0 = r0;
                let rate1 = r1;
                
                for (let i = 0; i < 2000; i++) {
                    const npv0 = calcNPV(rate0);
                    const npv1 = calcNPV(rate1);
                    
                    if (Math.abs(npv1) < 0.01) {
                        let annualizedRate = rate1;
                        if (totalYears > 0 && totalYears < 1) {
                            annualizedRate = Math.pow(1 + rate1, 1 / totalYears) - 1;
                        }
                        console.log(`âœ… IRR (Secant): Period=${(rate1*100).toFixed(4)}%, Annualized=${(annualizedRate*100).toFixed(2)}%`);
                        return annualizedRate;
                    }
                    
                    if (Math.abs(npv1 - npv0) < 1e-14) break; // Too close, try next pair
                    
                    const rate2 = rate1 - npv1 * (rate1 - rate0) / (npv1 - npv0);
                    
                    if (!isFinite(rate2) || rate2 < -0.99 || rate2 > 1000) break;
                    
                    rate0 = rate1;
                    rate1 = rate2;
                }
            }
            
            // Last resort: Bisection method (slowest but most reliable)
            console.log('âš ï¸ IRR: Secant failed, trying Bisection method');
            
            let low = -0.5;
            let high = 2.0;
            const npvLow = calcNPV(low);
            const npvHigh = calcNPV(high);
            
            console.log(`ğŸ” Bisection: NPV(${(low*100).toFixed(2)}%) = ${npvLow.toFixed(2)}, NPV(${(high*100).toFixed(2)}%) = ${npvHigh.toFixed(2)}`);
            
            // Check if solution is in range
            if (npvLow * npvHigh > 0) {
                console.log('âŒ IRR: No solution found in range (NPV does not cross zero)');
                return null;
            }
            
            for (let i = 0; i < 100; i++) {
                const mid = (low + high) / 2;
                const npvMid = calcNPV(mid);
                
                if (Math.abs(npvMid) < 0.01 || Math.abs(high - low) < 1e-10) {
                    let annualizedRate = mid;
                    if (totalYears > 0 && totalYears < 1) {
                        annualizedRate = Math.pow(1 + mid, 1 / totalYears) - 1;
                    }
                    console.log(`âœ… IRR (Bisection): Period=${(mid*100).toFixed(4)}%, Annualized=${(annualizedRate*100).toFixed(2)}% (${i} iterations)`);
                    return annualizedRate;
                }
                
                if (npvMid * npvLow < 0) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            
            console.log('âŒ IRR: Could not calculate');
            return null;
        }

        
        /**
         * Calculate MWR (Money-Weighted Return) for the entire portfolio
         * MWR = IRR that considers timing of cash flows
         * @returns {number} MWR as percentage (e.g., 15.5 = 15.5%)
         */
        /**
         * Combine cash flows that occur on the same date
         * This is necessary for XIRR to work correctly
         */
        function combineCashFlows(values, dates) {
            const flowMap = new Map();
            
            // Group by date
            for (let i = 0; i < values.length; i++) {
                const dateKey = dates[i].toISOString().split('T')[0]; // Use date only (YYYY-MM-DD)
                if (flowMap.has(dateKey)) {
                    flowMap.set(dateKey, {
                        date: dates[i],
                        value: flowMap.get(dateKey).value + values[i]
                    });
                } else {
                    flowMap.set(dateKey, {
                        date: dates[i],
                        value: values[i]
                    });
                }
            }
            
            // Convert back to arrays
            const combinedValues = [];
            const combinedDates = [];
            
            // Sort by date
            const sortedEntries = Array.from(flowMap.entries()).sort((a, b) => 
                new Date(a[0]) - new Date(b[0])
            );
            
            sortedEntries.forEach(([dateKey, flow]) => {
                combinedValues.push(flow.value);
                combinedDates.push(flow.date);
            });
            
            return { values: combinedValues, dates: combinedDates };
        }
        
        /**
         * Calculate annualized returns when IRR is undefined
         * Returns both 365.25-day and 360-day conventions
         */
        function calculateFallbackReturns(values, dates) {
            const totalInvested = values.filter(v => v < 0).reduce((sum, v) => sum + Math.abs(v), 0);
            const totalReceived = values.filter(v => v > 0).reduce((sum, v) => sum + v, 0);
            const profit = totalReceived - totalInvested;
            
            const firstDate = dates[0];
            const lastDate = dates[dates.length - 1];
            const periodDays = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
            
            // Period return
            const periodReturn = profit / totalInvested;
            
            // Simple annualized
            const simpleAnnualized = periodReturn * (365.25 / periodDays);
            
            // Compound annualized - Standard (365.25 days/year)
            const compoundAnnualized365 = Math.pow(1 + periodReturn, 365.25 / periodDays) - 1;
            
            // Compound annualized - Financial (360 days/year)
            const compoundAnnualized360 = Math.pow(1 + periodReturn, 360 / periodDays) - 1;
            
            return {
                periodReturn,
                periodDays,
                simpleAnnualized,
                compoundAnnualized365,
                compoundAnnualized360
            };
        }
        
        function calculateMWR() {
            try {
                // âœ… CORRECT XIRR convention (from INVESTOR perspective):
                // Negative = Money OUT of investor (deposits)
                // Positive = Money INTO investor (withdrawals + final value)
                
                const values = [];
                const dates = [];
                
                // Deposits: Money OUT of investor = NEGATIVE
                console.log('ğŸ” Deposits:', portfolio.deposits?.length || 0);
                if (portfolio.deposits && portfolio.deposits.length > 0) {
                    portfolio.deposits.forEach((d, idx) => {
                        const amount = d.amount || 0;
                        values.push(-Math.abs(amount)); // NEGATIVE (money leaving investor)
                        dates.push(new Date(d.date));
                        console.log(`  Deposit ${idx}: ${d.date} = -${amount}`);
                    });
                }
                
                // Withdrawals: Money INTO investor = POSITIVE
                console.log('ğŸ” Withdrawals:', portfolio.withdrawals?.length || 0);
                if (portfolio.withdrawals && portfolio.withdrawals.length > 0) {
                    portfolio.withdrawals.forEach((w, idx) => {
                        const amount = w.amount || 0;
                        values.push(Math.abs(amount)); // POSITIVE (money returning to investor)
                        dates.push(new Date(w.date));
                        console.log(`  Withdrawal ${idx}: ${w.date} = +${amount} (note: ${w.note})`);
                    });
                }
                
                // Current Value: What investor gets back today = POSITIVE
                const currentValue = getTotalPortfolioValue();
                console.log('ğŸ” Current Value:', currentValue);
                values.push(currentValue); // POSITIVE (as if selling everything)
                dates.push(new Date());
                
                console.log('ğŸ” Total cash flows (before combining):', values.length);
                console.log('ğŸ” Sum of flows:', values.reduce((a,b) => a+b, 0).toFixed(2));
                
                if (values.length < 2) {
                    console.log('âš ï¸ MWR: Not enough cash flows');
                    return null;
                }
                
                // â­ COMBINE flows on the same date
                const { values: combinedValues, dates: combinedDates } = combineCashFlows(values, dates);
                
                console.log('ğŸ”€ After combining same-date flows:', combinedValues.length);
                console.log('ğŸ’° MWR Cash Flows (combined):', combinedValues.map((v, i) => ({
                    date: combinedDates[i].toLocaleDateString('he-IL'),
                    amount: v.toFixed(2)
                })));
                
                // Calculate XIRR (already returns annualized rate!)
                const xirr = XIRR(combinedValues, combinedDates);
                
                if (xirr === null || !isFinite(xirr)) {
                    console.log('âš ï¸ MWR: IRR is mathematically undefined (NPV does not cross zero)');
                    console.log('   â†’ Using compound annualized return instead...');
                    
                    // Fallback: Calculate compound annualized return
                    const returns = calculateFallbackReturns(combinedValues, combinedDates);
                    
                    console.log(`ğŸ“Š Fallback Returns:`);
                    console.log(`   Period: ${returns.periodDays.toFixed(0)} days`);
                    console.log(`   Period Return: ${(returns.periodReturn * 100).toFixed(2)}%`);
                    console.log(`   Simple Annualized: ${(returns.simpleAnnualized * 100).toFixed(2)}%`);
                    console.log(`   Compound (365.25 days/year): ${(returns.compoundAnnualized365 * 100).toFixed(2)}%`);
                    console.log(`   Compound (360 days/year):    ${(returns.compoundAnnualized360 * 100).toFixed(2)}%`);
                    console.log(`ğŸ’° Using Compound (365.25): ${(returns.compoundAnnualized365 * 100).toFixed(2)}%`);
                    
                    // Return the standard 365.25-day calculation
                    return returns.compoundAnnualized365 * 100;
                }
                
                // XIRR already returns annualized rate - NO double annualization!
                console.log(`ğŸ’° MWR calculated: ${(xirr * 100).toFixed(2)}%`);
                return xirr * 100; // Return as percentage
                
            } catch (error) {
                console.error('âŒ Error calculating MWR:', error);
                return null;
            }
        }
        
        // ========================================
        // Portfolio Metrics (Sharpe, Volatility, etc.)
        // ========================================
        
        function calculatePortfolioMetrics() {
            const holdings = portfolio.holdings || [];
            
            if (holdings.length === 0) {
                return {
                    sharpeRatio: 0,
                    maxDrawdown: 0,
                    volatility: 0,
                    winRate: 0,
                    mwr: null
                };
            }
            
            // Calculate returns array (simplified - based on current profit/loss)
            let returns = [];
            let totalInvested = 0;
            let totalCurrent = 0;
            let winners = 0;
            
            holdings.forEach(h => {
                const invested = h.shares * h.costBasis;
                const current = h.shares * (h.currentPrice || h.costBasis);
                const returnPct = ((current - invested) / invested) * 100;
                
                returns.push(returnPct);
                totalInvested += invested;
                totalCurrent += current;
                
                if (returnPct > 0) winners++;
            });
            
            // Win Rate
            const winRate = holdings.length > 0 ? (winners / holdings.length) * 100 : 0;
            
            // Volatility (Standard Deviation of Returns)
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const squaredDiffs = returns.map(r => Math.pow(r - avgReturn, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / returns.length;
            const volatility = Math.sqrt(variance);
            
            // Sharpe Ratio (simplified: avg return / volatility)
            // Assuming risk-free rate = 0 for simplicity
            const sharpeRatio = volatility > 0 ? avgReturn / volatility : 0;
            
            // Max Drawdown (simplified: worst single holding performance)
            const maxDrawdown = returns.length > 0 ? Math.min(...returns) : 0;
            
            // Calculate MWR (Money-Weighted Return)
            const mwr = calculateMWR();
            
            return {
                sharpeRatio: sharpeRatio.toFixed(2),
                maxDrawdown: maxDrawdown.toFixed(2) + '%',
                volatility: volatility.toFixed(2) + '%',
                winRate: winRate.toFixed(1) + '%',
                mwr: mwr !== null ? mwr.toFixed(2) + '%' : 'N/A'
            };
        }
        
        function updateAnalysisTab() {
            const metrics = calculatePortfolioMetrics();
            
            // Update KPI cards - with null safety
            const sharpeEl = document.getElementById('sharpe-ratio');
            const drawdownEl = document.getElementById('max-drawdown');
            const volatilityEl = document.getElementById('volatility');
            const winRateEl = document.getElementById('win-rate');
            const mwrEl = document.getElementById('mwr-value');
            
            if (sharpeEl) sharpeEl.textContent = metrics.sharpeRatio;
            if (drawdownEl) drawdownEl.textContent = metrics.maxDrawdown;
            if (volatilityEl) volatilityEl.textContent = metrics.volatility;
            if (winRateEl) winRateEl.textContent = metrics.winRate;
            if (mwrEl) mwrEl.textContent = metrics.mwr;
            
            // Draw Treemap
            drawTreemap();
        }
        
        function drawTreemap() {
            const container = document.getElementById('treemap-container');
            if (!container) return;
            
            const holdings = portfolio.holdings || [];
            if (holdings.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 1.2rem;">××™×Ÿ ×× ×™×•×ª ×‘×ª×™×§</div>';
                return;
            }
            
            // Calculate total value
            let totalValue = 0;
            holdings.forEach(h => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                totalValue += convertToILS(value, h.currency);
            });
            
            // Create treemap data
            const treemapData = holdings.map(h => {
                const currentValue = h.shares * (h.currentPrice || h.costBasis);
                const invested = h.shares * h.costBasis;
                const valueILS = convertToILS(currentValue, h.currency);
                const profit = convertToILS(currentValue - invested, h.currency);
                const profitPct = ((currentValue - invested) / invested) * 100;
                const percentage = (valueILS / totalValue) * 100;
                
                return {
                    symbol: h.symbol,
                    value: valueILS,
                    percentage: percentage,
                    profit: profit,
                    profitPct: profitPct
                };
            });
            
            // Sort by value (largest first)
            treemapData.sort((a, b) => b.value - a.value);
            
            // Clear container
            container.innerHTML = '';
            
            // Draw rectangles
            let remainingWidth = 100;
            let remainingHeight = 100;
            let currentX = 0;
            let currentY = 0;
            let rowHeight = 0;
            
            treemapData.forEach((item, index) => {
                // Calculate size based on percentage
                const itemPercentage = item.percentage;
                
                // Simple treemap layout (can be improved)
                let width, height;
                
                if (itemPercentage >= 20) {
                    // Large items get full width
                    width = 100;
                    height = itemPercentage;
                    currentX = 0;
                    currentY += rowHeight;
                    rowHeight = height;
                } else {
                    // Smaller items share rows
                    width = Math.max(itemPercentage * 3, 10);
                    height = 20;
                    
                    if (currentX + width > 100) {
                        currentX = 0;
                        currentY += rowHeight;
                        rowHeight = height;
                    }
                }
                
                // Determine color based on profit
                let color;
                if (item.profitPct > 0) {
                    color = `rgba(16, 185, 129, ${Math.min(item.profitPct / 50, 1)})`; // Green
                } else if (item.profitPct < 0) {
                    color = `rgba(239, 68, 68, ${Math.min(Math.abs(item.profitPct) / 50, 1)})`; // Red
                } else {
                    color = '#9ca3af'; // Gray
                }
                
                // Create rectangle
                const rect = document.createElement('div');
                rect.style.position = 'absolute';
                rect.style.left = currentX + '%';
                rect.style.top = currentY + '%';
                rect.style.width = width + '%';
                rect.style.height = height + '%';
                rect.style.background = color;
                rect.style.border = '1px solid white';
                rect.style.padding = '8px';
                rect.style.boxSizing = 'border-box';
                rect.style.cursor = 'pointer';
                rect.style.transition = 'all 0.3s';
                rect.style.overflow = 'hidden';
                
                // Add content
                const fontSize = width > 15 ? '0.9rem' : '0.7rem';
                rect.innerHTML = `
                    <div style="color: white; font-weight: bold; font-size: ${fontSize}; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${item.symbol}</div>
                    <div style="color: white; font-size: ${fontSize}; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${item.percentage.toFixed(1)}%</div>
                    <div style="color: white; font-size: calc(${fontSize} * 0.85); text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${item.profitPct > 0 ? '+' : ''}${item.profitPct.toFixed(1)}%</div>
                `;
                
                // Hover effect
                rect.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.zIndex = '10';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                });
                
                rect.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.zIndex = '1';
                    this.style.boxShadow = 'none';
                });
                
                container.appendChild(rect);
                
                currentX += width;
                rowHeight = Math.max(rowHeight, height);
            });
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        

        function fixTWR() {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×›×œ ×”-snapshots ×”×™×©× ×™× ×•×œ×™×¦×•×¨ ××—×“ ×—×“×©?\n\n×–×” ×™××¤×¡ ××ª ×—×™×©×•×‘ TWR ××‘×œ ×œ× ×™×©×¤×™×¢ ×¢×œ ×”× ×ª×•× ×™× ×”××—×¨×™×.')) {
                return;
            }
            
            // ××—×§ snapshots ×™×©× ×™×
            portfolio.snapshots = [];
            
            // ×¦×•×¨ snapshot ×—×“×©
            createSnapshot('fix', '×ª×™×§×•×Ÿ ×¤×•×¨××˜', 0);
            
            saveData();
            updateOverview();
            
            notify('âœ… TWR ×ª×•×§×Ÿ! snapshot ×—×“×© × ×•×¦×¨.', 'success');
        }

        // ============================================
        // CURRENCY EXCHANGE
        // ============================================
        
        function showCurrencyExchange() {
            const modal = document.createElement('div');
            modal.id = 'exchange-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            // ×—×©×‘ ×™×ª×¨×•×ª ××–×•××Ÿ:
            // portfolio.cash = ×›×œ ×”×™×ª×¨×•×ª (ILS, USD, EUR)
            // getImplicitCash = ×¨×§ ×œ×‘×“×™×§×” ×©×œ deposits-withdrawals-purchases+sales
            
            // ××ª×—×œ portfolio.cash ×× ×œ× ×§×™×™×
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            const cashBalances = {
                ILS: portfolio.cash.ILS || 0,
                USD: portfolio.cash.USD || 0,
                EUR: portfolio.cash.EUR || 0
            };
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0;">ğŸ”„ ×”××¨×ª ××˜×‘×¢</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">××˜×‘×¢ ××§×•×¨:</label>
                        <select id="exchange-from" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="ILS">×©×§×œ (â‚ª) - ×™×ª×¨×”: â‚ª${Math.round(cashBalances.ILS).toLocaleString()}</option>
                            <option value="USD">×“×•×œ×¨ ($) - ×™×ª×¨×”: $${cashBalances.USD.toFixed(2)}</option>
                            <option value="EUR">×™×•×¨×• (â‚¬) - ×™×ª×¨×”: â‚¬${cashBalances.EUR.toFixed(2)}</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">××˜×‘×¢ ×™×¢×“:</label>
                        <select id="exchange-to" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="USD">×“×•×œ×¨ ($)</option>
                            <option value="ILS">×©×§×œ (â‚ª)</option>
                            <option value="EUR">×™×•×¨×• (â‚¬)</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">×¡×›×•× ×œ×”××¨×”:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="exchange-amount-from" placeholder="×¡×›×•× ××§×•×¨" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <span style="padding: 10px; font-size: 24px;">â‡„</span>
                            <input type="number" id="exchange-amount-to" placeholder="×¡×›×•× ×™×¢×“" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">×©×¢×¨ ×”××¨×”:</label>
                        <input type="number" id="exchange-rate" step="0.0001" placeholder="×©×¢×¨" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                        <div style="font-size: 0.85rem; color: #6b7280; margin-top: 5px;">×”×©×¢×¨ ××¢×•×“×›×Ÿ ××•×˜×•××˜×™×ª ××”×”×’×“×¨×•×ª, ××¤×©×¨ ×œ×©× ×•×ª ×™×“× ×™×ª</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="executeCurrencyExchange()" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            âœ… ×‘×¦×¢ ×”××¨×”
                        </button>
                        <button onclick="closeExchangeModal()" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            ×‘×™×˜×•×œ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up event listeners
            const fromSelect = document.getElementById('exchange-from');
            const toSelect = document.getElementById('exchange-to');
            const rateInput = document.getElementById('exchange-rate');
            const amountFromInput = document.getElementById('exchange-amount-from');
            const amountToInput = document.getElementById('exchange-amount-to');
            
            // Update rate when currencies change
            function updateRate() {
                const from = fromSelect.value;
                const to = toSelect.value;
                
                if (from === to) {
                    rateInput.value = '1';
                    return;
                }
                
                // ×ª××™×“ ×œ×”×¦×™×’ ××ª ×”×©×¢×¨ ×”×˜×‘×¢×™ (USD=3.75, EUR=4.05)
                // ×”××¢×¨×›×ª ×ª×“×¢ ××ª×™ ×œ×›×¤×•×œ ×•××ª×™ ×œ×—×œ×§ ×‘×—×™×©×•×‘
                let rate = 1;
                if (from === 'ILS' && to === 'USD') {
                    rate = portfolio.rates.USD;  // ×”×¦×’ 3.75 (× ×—×œ×§ ×‘×–×”)
                } else if (from === 'USD' && to === 'ILS') {
                    rate = portfolio.rates.USD;  // ×”×¦×’ 3.75 (× ×›×¤×•×œ ×‘×–×”)
                } else if (from === 'ILS' && to === 'EUR') {
                    rate = portfolio.rates.EUR;  // ×”×¦×’ 4.05 (× ×—×œ×§ ×‘×–×”)
                } else if (from === 'EUR' && to === 'ILS') {
                    rate = portfolio.rates.EUR;  // ×”×¦×’ 4.05 (× ×›×¤×•×œ ×‘×–×”)
                } else if (from === 'USD' && to === 'EUR') {
                    rate = portfolio.rates.EUR / portfolio.rates.USD;  // ×©×¢×¨ ×™×•×¨×•/×“×•×œ×¨
                } else if (from === 'EUR' && to === 'USD') {
                    rate = portfolio.rates.USD / portfolio.rates.EUR;  // ×©×¢×¨ ×“×•×œ×¨/×™×•×¨×•
                }
                
                rateInput.value = rate.toFixed(4);
            }
            
            // Update amount when rate or amount changes
            function updateAmountTo() {
                const from = fromSelect.value;
                const to = toSelect.value;
                const amountFrom = parseFloat(amountFromInput.value);
                const rate = parseFloat(rateInput.value);
                
                if (!isNaN(amountFrom) && !isNaN(rate)) {
                    let amountTo;
                    // ×§×‘×¢ ×”×× ×œ×›×¤×•×œ ××• ×œ×—×œ×§
                    if (from === 'ILS' && (to === 'USD' || to === 'EUR')) {
                        // ×-ILS ×œ××˜×‘×¢ ×–×¨ - ×—×œ×§
                        amountTo = amountFrom / rate;
                    } else if ((from === 'USD' || from === 'EUR') && to === 'ILS') {
                        // ×××˜×‘×¢ ×–×¨ ×œ-ILS - ×›×¤×•×œ
                        amountTo = amountFrom * rate;
                    } else {
                        // ×‘×™×Ÿ ××˜×‘×¢×•×ª ×–×¨×™× - ×›×¤×•×œ ×‘×©×¢×¨
                        amountTo = amountFrom * rate;
                    }
                    amountToInput.value = amountTo.toFixed(2);
                }
            }
            
            function updateAmountFrom() {
                const from = fromSelect.value;
                const to = toSelect.value;
                const amountTo = parseFloat(amountToInput.value);
                const rate = parseFloat(rateInput.value);
                
                if (!isNaN(amountTo) && !isNaN(rate) && rate !== 0) {
                    let amountFrom;
                    // ×”×¤×•×š ××ª ×”×¤×¢×•×œ×”
                    if (from === 'ILS' && (to === 'USD' || to === 'EUR')) {
                        // ×-ILS ×œ××˜×‘×¢ ×–×¨ - ×”×™×™× ×• ××—×œ×§×™×, ×¢×›×©×™×• × ×›×¤×•×œ
                        amountFrom = amountTo * rate;
                    } else if ((from === 'USD' || from === 'EUR') && to === 'ILS') {
                        // ×××˜×‘×¢ ×–×¨ ×œ-ILS - ×”×™×™× ×• ××›×¤×™×œ×™×, ×¢×›×©×™×• × ×—×œ×§
                        amountFrom = amountTo / rate;
                    } else {
                        // ×‘×™×Ÿ ××˜×‘×¢×•×ª ×–×¨×™× - ×—×œ×§
                        amountFrom = amountTo / rate;
                    }
                    amountFromInput.value = amountFrom.toFixed(2);
                }
            }
            
            fromSelect.addEventListener('change', updateRate);
            toSelect.addEventListener('change', updateRate);
            rateInput.addEventListener('input', updateAmountTo);
            amountFromInput.addEventListener('input', updateAmountTo);
            amountToInput.addEventListener('input', updateAmountFrom);
            
            // Initialize rate
            updateRate();
        }
        
        function closeExchangeModal() {
            const modal = document.getElementById('exchange-modal');
            if (modal) modal.remove();
        }
        
        function executeCurrencyExchange() {
            const from = document.getElementById('exchange-from').value;
            const to = document.getElementById('exchange-to').value;
            const amountFrom = parseFloat(document.getElementById('exchange-amount-from').value);
            const amountTo = parseFloat(document.getElementById('exchange-amount-to').value);
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            
            // Validation
            if (!from || !to || from === to) {
                notify('âŒ ×‘×—×¨ ××˜×‘×¢×•×ª ×©×•× ×™×', 'error');
                return;
            }
            
            if (isNaN(amountFrom) || amountFrom <= 0) {
                notify('âŒ ×”×–×Ÿ ×¡×›×•× ×ª×§×™×Ÿ ×œ×”××¨×”', 'error');
                return;
            }
            
            if (isNaN(rate) || rate <= 0) {
                notify('âŒ ×”×–×Ÿ ×©×¢×¨ ×”××¨×” ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // Check balance
            // ×—×©×‘ ×™×ª×¨×•×ª ××–×•××Ÿ:
            // portfolio.cash = ×›×œ ×”×™×ª×¨×•×ª (ILS, USD, EUR)
            // getImplicitCash = ×¨×§ ×œ×‘×“×™×§×” ×©×œ deposits-withdrawals-purchases+sales
            
            // ××ª×—×œ portfolio.cash ×× ×œ× ×§×™×™×
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            const cashBalances = {
                ILS: portfolio.cash.ILS || 0,
                USD: portfolio.cash.USD || 0,
                EUR: portfolio.cash.EUR || 0
            };
            if (cashBalances[from] < amountFrom) {
                notify(`âŒ ××™×Ÿ ××¡×¤×™×§ ×™×ª×¨×” ×‘-${from}. ×™×ª×¨×” × ×•×›×—×™×ª: ${cashBalances[from].toFixed(2)}`, 'error');
                return;
            }
            
            // Execute exchange - ×œ×œ× ××©×™×›×•×ª/×”×¤×§×“×•×ª!
            // ×”××¨×” = ××©×—×§ ×¡×›×•× 0, ×œ× ×¦×¨×™×›×” ×œ×”×©×¤×™×¢ ×¢×œ TWR
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            // ×¤×©×•×˜ ×¢×“×›×Ÿ ××ª portfolio.cash ×™×©×™×¨×•×ª
            portfolio.cash[from] -= amountFrom;
            portfolio.cash[to] += amountTo;
            
            console.log(`âœ… ×”××¨×”: ${amountFrom} ${from} â†’ ${amountTo} ${to}`);
            console.log(`   ×™×ª×¨×•×ª: ILS=${portfolio.cash.ILS}, USD=${portfolio.cash.USD}, EUR=${portfolio.cash.EUR}`);
            
            // Record transaction (for history)
            if (!portfolio.currencyExchanges) portfolio.currencyExchanges = [];
            portfolio.currencyExchanges.push({
                id: Date.now() + 2,
                date: new Date().toISOString(),
                from: from,
                to: to,
                amountFrom: amountFrom,
                amountTo: amountTo,
                rate: rate
            });
            
            saveData();
            renderCashFlow();
            updateOverview();
            
            notify(`âœ… ×”××¨×” ×‘×•×¦×¢×”: ${amountFrom.toFixed(2)} ${from} â†’ ${amountTo.toFixed(2)} ${to}`, 'success');
            
            closeExchangeModal();
        }
        // ==================== ADVANCED CHARTS (NEW!) ====================
        // ğŸ“Š ×¤×•× ×§×¦×™×•×ª ×œ×™×¦×™×¨×ª ×”×’×¨×¤×™× ×”××ª×§×“××™×
        
        let advancedCharts = {};
        
        function createAdvancedCharts() {
            console.log('ğŸ“Š Creating advanced charts...');
            
            // Destroy existing charts
            Object.values(advancedCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            advancedCharts = {};
            
            // Get theme colors
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#f9fafb' : '#1f2937';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            
            createValueOverTimeChart(textColor, gridColor);
            createGainLossChart(textColor, gridColor);
            createCurrencyDistributionChart(textColor, gridColor);
            createPerformanceComparisonChart(textColor, gridColor);
            
            console.log('âœ… Advanced charts created successfully!');
        }
        
        function createValueOverTimeChart(textColor, gridColor) {
            const canvas = document.getElementById('value-over-time-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // ×‘× ×™×™×ª × ×ª×•× ×™×: ××™×–×•×’ ×”×¤×§×“×•×ª, ××©×™×›×•×ª ×•×©×•×•×™ × ×•×›×—×™
            const dataPoints = [];
            
            // ×”×•×¡×£ × ×§×•×“×•×ª ××”×”×¤×§×“×•×ª
            portfolio.deposits.forEach(d => {
                dataPoints.push({
                    date: new Date(d.date),
                    type: 'deposit',
                    amount: d.amount,
                    cumulative: 0 // × ×—×©×‘ ××—×¨ ×›×š
                });
            });
            
            // ×”×•×¡×£ × ×§×•×“×•×ª ××”××©×™×›×•×ª
            portfolio.withdrawals.forEach(w => {
                dataPoints.push({
                    date: new Date(w.date),
                    type: 'withdrawal',
                    amount: -w.amount,
                    cumulative: 0
                });
            });
            
            // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
            dataPoints.sort((a, b) => a.date - b.date);
            
            // ×—×™×©×•×‘ ××¦×˜×‘×¨ ×©×œ ×”×¤×§×“×•×ª
            let cumulativeDeposits = 0;
            const depositsLine = [];
            const portfolioValueLine = [];
            const labels = [];
            
            dataPoints.forEach(point => {
                cumulativeDeposits += point.amount;
                const label = point.date.toLocaleDateString('he-IL', { month: 'short', year: 'numeric' });
                labels.push(label);
                depositsLine.push(cumulativeDeposits);
            });
            
            // ×”×•×¡×£ × ×§×•×“×” × ×•×›×—×™×ª
            const now = new Date();
            const currentValue = getTotalPortfolioValue();
            const nowLabel = now.toLocaleDateString('he-IL', { month: 'short', year: 'numeric' });
            labels.push(nowLabel);
            depositsLine.push(cumulativeDeposits);
            
            // ×‘× ×” ×§×• ×©×•×•×™ ×”×ª×™×§ (×¤×©×•×˜: ××”×”×¤×§×“×” ×”×¨××©×•× ×” ×•×¢×“ ×¢×›×©×™×•)
            if (dataPoints.length > 0) {
                // ××œ× ×‘×¢×¨×›×™× ×œ×™× ××¨×™×™×
                for (let i = 0; i < labels.length - 1; i++) {
                    const progress = i / (labels.length - 2);
                    portfolioValueLine.push(dataPoints[0].amount + (currentValue - dataPoints[0].amount) * progress);
                }
                portfolioValueLine.push(currentValue);
            }
            
            advancedCharts.valueOverTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '×©×•×•×™ ×ª×™×§ ×‘×¤×•×¢×œ',
                            data: portfolioValueLine,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: '×¡×š ×”×¤×§×“×•×ª ××¦×˜×‘×¨',
                            data: depositsLine,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: textColor,
                                font: { size: 14, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': â‚ª' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '×ª××¨×™×š',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '×¢×¨×š (â‚ª)',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return 'â‚ª' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }
        
        function createGainLossChart(textColor, gridColor) {
            const canvas = document.getElementById('gain-loss-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // ×—×™×©×•×‘ ×¨×•×•×—/×”×¤×¡×“ ×œ××•×¨×š ×–××Ÿ
            const totalValue = getTotalPortfolioValue();
            const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + d.amount, 0);
            const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => sum + w.amount, 0);
            const netGain = totalValue - totalDeposits + totalWithdrawals;
            const gainPercent = totalDeposits > 0 ? (netGain / totalDeposits * 100) : 0;
            
            // ×‘× ×” × ×ª×•× ×™× ×—×•×“×©×™×™× (×§×™×¨×•×‘)
            const monthLabels = [];
            const gains = [];
            const today = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const label = date.toLocaleDateString('he-IL', { month: 'short' });
                monthLabels.push(label);
                // ×§×™×¨×•×‘: × × ×™×— ×¦××™×—×” ×œ×™× ××¨×™×ª
                const progress = (11 - i) / 11;
                gains.push(netGain * progress);
            }
            
            advancedCharts.gainLoss = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: '×¨×•×•×—/×”×¤×¡×“ ××¦×˜×‘×¨',
                        data: gains,
                        backgroundColor: gains.map(g => g >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                        borderColor: gains.map(g => g >= 0 ? '#10b981' : '#ef4444'),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const sign = value >= 0 ? '+' : '';
                                    return '×¨×•×•×—/×”×¤×¡×“: ' + sign + 'â‚ª' + Math.round(value).toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '×—×•×“×©',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '×¨×•×•×—/×”×¤×¡×“ (â‚ª)',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return (value >= 0 ? '+' : '') + 'â‚ª' + (value / 1000).toFixed(1) + 'K';
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }
        
        function createCurrencyDistributionChart(textColor, gridColor) {
            const canvas = document.getElementById('currency-distribution-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // ×—×™×©×•×‘ ×—×œ×•×§×” ×œ××˜×‘×¢×•×ª - ×ª×™×§×•×Ÿ ×—×©×•×‘!
            let ilsTotal = 0;
            let usdTotal = 0;
            let eurTotal = 0;
            
            // ×× ×™×•×ª
            portfolio.holdings.forEach(h => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                if (h.currency === 'ILS') {
                    ilsTotal += value;
                } else if (h.currency === 'USD') {
                    // ×©××•×¨ ××ª ×”×¡×›×•× ×‘××˜×‘×¢ ×”××§×•×¨×™ (×“×•×œ×¨×™×)
                    usdTotal += value;
                } else if (h.currency === 'EUR') {
                    // ×©××•×¨ ××ª ×”×¡×›×•× ×‘××˜×‘×¢ ×”××§×•×¨×™ (×™×•×¨×•)
                    eurTotal += value;
                }
            });
            
            // ××’"×— (×‘×“×¨×š ×›×œ×œ ×‘×©×§×œ×™×)
            if (portfolio.bonds) {
                portfolio.bonds.forEach(b => {
                    ilsTotal += b.units * b.currentPrice;
                });
            }
            
            // ××–×•××Ÿ
            if (portfolio.cash) {
                ilsTotal += portfolio.cash.ILS || 0;
                usdTotal += portfolio.cash.USD || 0;
                eurTotal += portfolio.cash.EUR || 0;
            }
            
            // ×”××¨×” ×œ×©×§×œ×™× ×œ×¦×•×¨×š ×—×™×©×•×‘ ××—×•×–×™×
            const ilsTotalInILS = ilsTotal;
            const usdTotalInILS = usdTotal * portfolio.rates.USD;
            const eurTotalInILS = eurTotal * portfolio.rates.EUR;
            const grandTotal = ilsTotalInILS + usdTotalInILS + eurTotalInILS;
            
            console.log('ğŸ’± Currency Distribution:');
            console.log(`   ILS: â‚ª${ilsTotal.toFixed(2)} (${(ilsTotalInILS / grandTotal * 100).toFixed(1)}%)`);
            console.log(`   USD: $${usdTotal.toFixed(2)} = â‚ª${usdTotalInILS.toFixed(2)} (${(usdTotalInILS / grandTotal * 100).toFixed(1)}%)`);
            console.log(`   EUR: â‚¬${eurTotal.toFixed(2)} = â‚ª${eurTotalInILS.toFixed(2)} (${(eurTotalInILS / grandTotal * 100).toFixed(1)}%)`);
            console.log(`   Total: â‚ª${grandTotal.toFixed(2)}`);
            
            advancedCharts.currencyDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['×©×§×œ (â‚ª)', '×“×•×œ×¨ ($)', '×™×•×¨×• (â‚¬)'],
                    datasets: [{
                        data: [ilsTotalInILS, usdTotalInILS, eurTotalInILS],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b'
                        ],
                        borderWidth: 3,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                font: { size: 14, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = grandTotal > 0 ? (value / grandTotal * 100).toFixed(1) : 0;
                                    return context.label + ': â‚ª' + Math.round(value).toLocaleString() + ' (' + percent + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createPerformanceComparisonChart(textColor, gridColor) {
            const canvas = document.getElementById('performance-comparison-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // ×—×™×©×•×‘ ×‘×™×¦×•×¢×™ ×”×ª×™×§ - ×××™×ª×™!
            const totalValue = getTotalPortfolioValue();
            const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + d.amount, 0);
            const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => sum + w.amount, 0);
            
            // ×—×™×©×•×‘ ×ª×©×•××” ×©× ×ª×™×ª ×©×œ ×”×ª×™×§
            let portfolioReturn = 0;
            
            if (totalDeposits > 0) {
                // ×—×™×©×•×‘ ×¤×©×•×˜: ×¨×•×•×—/×”×¤×¡×“ ×—×œ×§×™ ×”×•×©×§×¢
                const netProfit = totalValue - totalDeposits + totalWithdrawals;
                portfolioReturn = (netProfit / totalDeposits) * 100;
                
                // ×× ×™×© ×ª×§×•×¤×” - ×—×©×‘ ×©× ×ª×™
                if (portfolio.deposits.length > 0) {
                    const firstDeposit = new Date(portfolio.deposits[0].date);
                    const now = new Date();
                    const years = (now - firstDeposit) / (1000 * 60 * 60 * 24 * 365);
                    if (years > 0) {
                        // ×ª×©×•××” ×©× ×ª×™×ª ×××•×¦×¢×ª
                        portfolioReturn = portfolioReturn / Math.max(years, 0.1);
                    }
                }
            }
            
            // ×”×©×•×•××” ×œ××™× ×“×§×¡×™× (×××•×¦×¢ ×”×™×¡×˜×•×¨×™ ×-2020-2024)
            const sp500Avg = 12;  // S&P 500: ~12% ×©× ×ª×™ ×××•×¦×¢
            const ta35Avg = 5;    // TA-35: ~5% ×©× ×ª×™ ×××•×¦×¢ (2020-2024)
            const bondsAvg = 2.5;  // ××’"×— ×××©×œ×ª×™ ×™×©×¨××œ×™: ~2.5%
            
            console.log('ğŸ“Š Performance Comparison:');
            console.log(`   Your Portfolio: ${portfolioReturn.toFixed(1)}% annually`);
            console.log(`   S&P 500: ${sp500Avg}% (2020-2024 avg)`);
            console.log(`   TA-35: ${ta35Avg}% (2020-2024 avg)`);
            console.log(`   Gov Bonds: ${bondsAvg}% (2020-2024 avg)`);
            
            advancedCharts.performanceComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['×”×ª×™×§ ×©×œ×š', 'S&P 500', 'TA-35', '××’"×— ×××©×œ×ª×™'],
                    datasets: [{
                        label: '×ª×©×•××” ×©× ×ª×™×ª ×××•×¦×¢×ª (%)',
                        data: [portfolioReturn, sp500Avg, ta35Avg, bondsAvg],
                        backgroundColor: [
                            portfolioReturn >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            portfolioReturn >= 0 ? '#10b981' : '#ef4444',
                            '#3b82f6',
                            '#667eea',
                            '#f59e0b'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    return '×ª×©×•××”: ' + (context.parsed.y >= 0 ? '+' : '') + context.parsed.y.toFixed(1) + '%';
                                },
                                afterLabel: function(context) {
                                    if (context.dataIndex === 0) {
                                        return '×‘×™×¦×•×¢×™ ×”×ª×™×§ ×©×œ×š';
                                    } else if (context.dataIndex === 1) {
                                        return '×××•×¦×¢ 2020-2024';
                                    } else if (context.dataIndex === 2) {
                                        return '×××•×¦×¢ 2020-2024';
                                    } else {
                                        return '×××•×¦×¢ 2020-2024';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '××™× ×“×§×¡',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '×ª×©×•××” ×©× ×ª×™×ª (%)',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return (value >= 0 ? '+' : '') + value + '%';
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== END ADVANCED CHARTS ====================
        
        window.onload = function() {
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('âœ¨ VERSION: ENHANCED v32 - Advanced Charts + Dark Mode');
            console.log('   âœ… Fixed: localStorage now saves and loads correctly');
            console.log('   âœ… Fixed: Groups are ALWAYS default - never corrupted');
            console.log('   âœ… Fixed: All holdings now have valid groupId');
            console.log('   âœ… NEW: Portfolio Value Over Time Chart');
            console.log('   âœ… NEW: Gain/Loss Chart');
            console.log('   âœ… NEW: Currency Distribution Chart');
            console.log('   âœ… NEW: Performance Comparison Chart');
            console.log('   âœ… NEW: Dark Mode Support');
            console.log('   âœ… NEW: Enhanced UI/UX with Lucide Icons');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸš€ Initializing enhanced portfolio...');
            console.log('ğŸ“¦ Portfolio data structure:', portfolio);
            
            // ×§×¨×™××” ×œ-init ×›×“×™ ×œ×˜×¢×•×Ÿ × ×ª×•× ×™×
            init();
        }
        
        async function init() {
            await loadData();  // Load from localStorage
            console.log('ğŸ“Š Loaded holdings:', portfolio.holdings.length);
            
            updateOverview();
            updateGroupSelect();
            renderHoldingsList();
            renderCashFlow();
            
            
            renderTransactions();
            
            // ×˜×¢×™× ×ª ×¢×¨×›×™× ×œ×”×’×“×¨×•×ª
            document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
            document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
            
            // Hide loading screen with animation
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    if (mainContent) mainContent.style.display = 'block';
                    
                    // Initialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    
                    // Create advanced charts after content is visible
                    setTimeout(() => {
                        createAdvancedCharts();
                    }, 300);
                }, 300);
            }
            
            // × ×™×¡×™×•×Ÿ ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ (×¨×§×¢ - ×œ× ×—×•×¡×)
            autoUpdateExchangeRates().then(success => {
                if (success) {
                    updateOverview();
                    console.log('âœ… Auto-update successful');
                } else {
                    console.log('â„¹ï¸ Using manual rates');
                }
            });
            
            notify('ğŸ’¼ ××¢×¨×›×ª ××•×›× ×” ×¢× ×’×¨×¤×™× ××ª×§×“××™×!', 'success');
            console.log('âœ… Portfolio initialized successfully');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“‹ Debug Info:');
            console.log('  - Holdings:', portfolio.holdings.length);
            console.log('  - Groups:', portfolio.groups.length);
            console.log('  - USD Rate:', portfolio.rates.USD);
            console.log('  - EUR Rate:', portfolio.rates.EUR);
            console.log('  - Bonds:', portfolio.bonds);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('âœ… To add a holding, click "×”×•×¡×£ ×”×—×–×§×”" and fill the form');
            console.log('âœ… To refresh prices, click "×¨×¢× ×Ÿ ××—×™×¨×™×"');
            console.log('âœ… To view advanced charts, click on "×’×¨×¤×™×" tab');
            console.log('âœ… To toggle dark mode, click the moon/sun icon');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            // ×©××•×¨ ××ª ×”× ×ª×•× ×™× ××—×¨×™ ×˜×¢×™× ×”
            saveData();
        };
        
        // Expose functions to window for HTML onclick handlers
        window.showTab = showTab;
        window.addHolding = addHolding;
        window.editHolding = editHolding;
        window.deleteHolding = deleteHolding;
        window.updatePriceManually = updatePriceManually;
        window.showAddSharesForm = showAddSharesForm;
        window.showSellSharesForm = showSellSharesForm;
        window.addCapitalMovement = addCapitalMovement;
        window.deleteCapitalMovement = deleteCapitalMovement;
        window.deleteSale = deleteSale;
        window.showCalculateCapitalFromHoldings = showCalculateCapitalFromHoldings;
        window.hideCalculateCapitalModal = hideCalculateCapitalModal;
        window.toggleHoldingSelection = toggleHoldingSelection;
        window.addCalculatedCapital = addCalculatedCapital;
        window.showAddBondForm = showAddBondForm;
        window.hideAddBondForm = hideAddBondForm;
        window.saveBond = saveBond;
        window.editBond = editBond;
        window.deleteBond = deleteBond;
        window.refreshPrices = refreshPrices;
        window.showCurrencyExchange = showCurrencyExchange;
        window.closeExchangeModal = closeExchangeModal;
        window.executeCurrencyExchange = executeCurrencyExchange;
        window.fixTWR = fixTWR;
        window.showAddHoldingForm = showAddHoldingForm;
        window.hideAddHoldingForm = hideAddHoldingForm;
        window.calculateInvestment = calculateInvestment;
        window.editGroup = editGroup;
        window.fixGroupIds = fixGroupIds;
        window.updateExchangeRates = updateExchangeRates;
        window.tryAutoUpdateRates = tryAutoUpdateRates;
        window.exportData = exportData;
        window.importData = importData;

    
        // Initialize dark mode from localStorage
        window.addEventListener('DOMContentLoaded', () => {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                const themeIcon = document.getElementById('theme-icon');
                if (themeIcon) themeIcon.textContent = 'â˜€ï¸';
            }
        });

    </script>
</body>
</html>